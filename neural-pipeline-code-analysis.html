<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-01-02 一 17:32 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>任务型对话系统中Neural Pipeline系列源码剖析</title>
<meta name="author" content="Zi Liang" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="./css/worg.css" />
</head>
<body>
<div id="content" class="content">
<h1 class="title">任务型对话系统中Neural Pipeline系列源码剖析</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgf39b895">1. 总体结构</a></li>
<li><a href="#org0827ee4">2. Data部分</a>
<ul>
<li><a href="#orgdcc81e3">2.1. GPT-2的输入形态</a></li>
<li><a href="#org0fde8a8">2.2. Neural Pipeline中的文本输入与输出</a></li>
<li><a href="#org4354fe6">2.3. neural pipline与GPT-2的结合</a></li>
<li><a href="#org98e7cda">2.4. 再坚持一下: 为什么说一个TOD很复杂?</a>
<ul>
<li><a href="#org4edc5e1">2.4.1. 如何预处理任务型对话系统数据集?</a></li>
<li><a href="#org1c75e7f">2.4.2. TOD的层级结构以及各个常见的数据对象</a></li>
<li><a href="#org2bd83c5">2.4.3. 如何解析tod数据集?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgd92fbbe">3. Model的设计</a>
<ul>
<li><a href="#org4163a3e">3.1. train- forward</a></li>
</ul>
</li>
<li><a href="#org4d3aa57">4. 训练流程</a></li>
<li><a href="#orgc427d02">5. 推理流程</a></li>
</ul>
</div>
</div>
<p>
本文于<span class="timestamp-wrapper"><span class="timestamp">&lt;2022-03-26 六&gt;</span></span>进行了修改.
</p>

<p>
本文主要是基于github上的SOLOIST和AuGPT两份源码<a href="https://github.com/jkulhanek/soloist.git">(here)</a>进行的阅读. 这两份源码都是Neural Pipeline相关的, 因此笔者就基于该源码统一的进行分析了.
</p>

<p>
在阅读源码之前, 可能还是需要首先了解一下什么是任务型对话系统(TOD, task-oriented dialogue system)以及什么是neural pipeline的方法,如果我忘记了这两个概念,我会去阅读 <code>这篇</code> 笔记.
</p>

<p>
然后,这篇文章就着重于描述上述模型的代码实现了!
</p>

<div id="outline-container-orgf39b895" class="outline-2">
<h2 id="orgf39b895"><span class="section-number-2">1.</span> 总体结构</h2>
<div class="outline-text-2" id="text-1">
<p>
总体上而言, 任何一个深度学习的代码无外乎以下几个主要部分:
</p>
<ul class="org-ul">
<li>数据预处理: 解析和读取实验数据, 对实验数据进行一系列变换, 并最终整理为格式化的输入. 对于pytorch而言, 所谓的格式化输入相当于整理得到可供dataloader加载的数据,在具体传入模型的形式上, 除去一部分控制参数可以拥有 bool或scale的数值类型之外,绝大多数数据类型都应是一个张量,也就是tensor. 将不同维度的向量通过padding形成一个batch层面的张量是NLP中必须考虑的一环.</li>
<li>深度学习模型代码. 当下绝大多数深度学习模型都不是model free的,所以模型的设计几乎不可避免. 当然,由于预训练模型的兴起,深度学习模型部分的代码已经没有多少代码量了. 本文主要还是基于GPT-2这样一些transformer家族的模型进行处理,因此在模型结构设计上没有创新,可以直接复用hugging face, 如果我对设计transformer模型感兴趣, <code>这篇</code> 笔记记录了如何阅读并修改transformers源码, 我可以去看一下.</li>
<li>训练部分的代码. 按照传统有监督学习的框架, 一个有监督学习主要包括data, model, loss function, optimization等四个基本组件, 由于data和model的出奇的重要性, 所以这两块被拿出来单独陈述了,而剩下的loss和optimization, 其实都可以放入训练部分的代码中. 一般而言,训练部分的代码便是这样的"胶水":用以记录如何进行这样的forward和backward的传播, 存储实验结果和模型参数, 进行可视化,等等等等.</li>
<li>模型测试环节的代码实现. 模型测试环节的代码实现和训练时大同小异,但对于NLG任务而言, 二者还是有较多的区别, 因此此处单独拿出来作为新的一部分.笔者在对已有的代码进行魔改时,曾经就是忘记了修改模型测试部分的代码而浪费了一周的宝贵时间. 在模型测试部分, 主要是设计prefix进行自回归的生成, 以及如何对生成的语句进行基于规则的后处理,最终将后处理的文本与ground truth 进行评估,以产生最终的结果.</li>
</ul>
</div>
</div>

<div id="outline-container-org0827ee4" class="outline-2">
<h2 id="org0827ee4"><span class="section-number-2">2.</span> Data部分</h2>
<div class="outline-text-2" id="text-2">
<p>
对于深度学习,尤其是transformer时代的深度学习而言, 当下的创新多从训练任务和整理数据入手,而非模型的结构. 笔者的同学甚至因为在面向某个NLP任务时自己设计了特殊的结构而被审稿人质疑. neural pipeline的方法, 其核心思路是将TOD中的各个基本组件都统一地放在单一的一个NLG模型中,所以, 对数据的编排就不得不算是重中之重了.
</p>

<p>
下文将先介绍GPT-2的输入输出具体是什么风格, 之后介绍TOD的各基本模块的输入输出为什么, 最后在上述二者的基础上, 探究怎么用GPT-2做基本模块的输入. 当然,这里的问题是:为什么一定要用GPT-2 ? 其实不用GPT-2也是完全可以的, T5, BART等模型一样可以解决该问题, 此处单以GPT-2为示例,其他情况灵活变通.
</p>
</div>


<div id="outline-container-orgdcc81e3" class="outline-3">
<h3 id="orgdcc81e3"><span class="section-number-3">2.1.</span> GPT-2的输入形态</h3>
<div class="outline-text-3" id="text-2-1">
<p>
GPT-2的输入严格而言主要包括三部分:
</p>
<ol class="org-ol">
<li>token encoding. 可以理解为是输入语句的语义信息输入. 实际上传入模型中的每一条数据都是index的列表. 相当于对于输入的一句话,可以通过tokenizer将其切分为若干个token(根据不同的tokenize方法而产生word 或 subword),而该token都可以唯一的与vocablist中的某一行对应,该行的行号便可以看作是这里的index. 而对于GPT-2这样的深度学习模型而言, 这里的index并不是一个数字, 而是可以理解为1个one-hot向量, 该向量仅仅在index处为1,其他地方为0. GPT-2会基于这样的one-hot向量, 使用一个早就学习好的embedding layer(其实就是1个全连接)将这个稀疏的向量映射为一个稠密的真值向量(比如从5w个词汇到768维), 后者便是真正的token embedding. 当然, transformer库也可以允许你直接传入embedding的列表来表示1句话,这样这个embedding层就不会生效.</li>
<li>position encoding. 由于self-attention天生的无位置性,所以需要加入位置编码信息来确定顺序. GPT-2采用的是绝对位置编码,一般而言相当于从0到max_seq_len-1内的任何一个数字作为输入,之后会使用三角函数将这个数转化为1个embedding.</li>
<li>type encoding. 用于区分每个token的类型. 比如A和B聊天, 那么就可以对这二者设置两种不同的类型.</li>
</ol>

<p>
不妨通过 <code>GPT2LMHeadModel</code> 中的 <code>forward</code> 函数进行简单的理解:
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">forward</span><span style="color: #4d9391;">(</span>
    <span style="color: #49bdb0;">self</span>,
    input_ids=<span style="color: #ef6787;">None</span>, <span style="color: #635C4A;"># </span><span style="color: #635C4A;">token encoding</span>
    past=<span style="color: #ef6787;">None</span>,
    attention_mask=<span style="color: #ef6787;">None</span>,
    token_type_ids=<span style="color: #ef6787;">None</span>, <span style="color: #635C4A;"># </span><span style="color: #635C4A;">type encoding</span>
    position_ids=<span style="color: #ef6787;">None</span>, <span style="color: #635C4A;"># </span><span style="color: #635C4A;">position encoding</span>
    head_mask=<span style="color: #ef6787;">None</span>,
    inputs_embeds=<span style="color: #ef6787;">None</span>,
    labels=<span style="color: #ef6787;">None</span>,
    use_cache=<span style="color: #ef6787;">None</span>,
    output_attentions=<span style="color: #ef6787;">None</span>,
    output_hidden_states=<span style="color: #ef6787;">None</span>,
<span style="color: #4d9391;">)</span>:
</pre>
</div>

<p>
注意到此处还有一些别的函数, 这些函数在 <code>这篇</code> 笔记中会有详细介绍.
</p>

<p>
我们可以观察一下token encoding的映射embedding在GPT-2中的实现:
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #49bdb0;">class</span> <span style="color: #eed891;">GPT2Model</span><span style="color: #4d9391;">(</span>GPT2PreTrainedModel<span style="color: #4d9391;">)</span>:
    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__init__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, config<span style="color: #4d9391;">)</span>:
        <span style="color: #53E6B5;">super</span><span style="color: #4d9391;">()</span>.__init__<span style="color: #4d9391;">(</span>config<span style="color: #4d9391;">)</span>

        <span style="color: #49bdb0;">self</span>.<span style="color: #ef6787;">wte</span> = nn.Embedding<span style="color: #4d9391;">(</span>config.vocab_size, config.n_embd<span style="color: #4d9391;">)</span>   <span style="color: #635C4A;"># </span><span style="color: #635C4A;">token encoding--&gt;token embedding layer</span>
        <span style="color: #49bdb0;">self</span>.<span style="color: #ef6787;">wpe</span> = nn.Embedding<span style="color: #4d9391;">(</span>config.n_positions, config.n_embd<span style="color: #4d9391;">)</span><span style="color: #635C4A;"># </span><span style="color: #635C4A;">position encoding--&gt;position embedding layer</span>
        <span style="color: #49bdb0;">self</span>.<span style="color: #ef6787;">drop</span> = nn.Dropout<span style="color: #4d9391;">(</span>config.embd_pdrop<span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">self</span>.<span style="color: #ef6787;">h</span> = nn.ModuleList<span style="color: #4d9391;">(</span><span style="color: #47ba99;">[</span>Block<span style="color: #9d81ba;">(</span>config.n_ctx, config, scale=<span style="color: #ef6787;">True</span><span style="color: #9d81ba;">)</span> <span style="color: #49bdb0;">for</span> _ <span style="color: #49bdb0;">in</span> <span style="color: #53E6B5;">range</span><span style="color: #9d81ba;">(</span>config.n_layer<span style="color: #9d81ba;">)</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">self</span>.ln_f = nn.LayerNorm<span style="color: #4d9391;">(</span>config.n_embd, eps=config.layer_norm_epsilon<span style="color: #4d9391;">)</span>

        <span style="color: #49bdb0;">self</span>.init_weights<span style="color: #4d9391;">()</span>

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">get_input_embeddings</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span><span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">return</span> <span style="color: #49bdb0;">self</span>.wte

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">set_input_embeddings</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, new_embeddings<span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">self</span>.wte = new_embeddings
</pre>
</div>

<p>
可以发现3.0.2版本的GPT-2, 在实现position embedding时并没有使用三角函数, 也是使用的pytorch中的embedding层.
</p>


<p>
关于GPT-2的文本输出,则更为简单. GPT-2在经过最末层的transformer模块之后,会进入一个线性分类器层W, 从而从embedding维度被映射到vocab length. 如果上述公式被表达为Y=W*d, 那么W的每一行都可以看作是vocab的表示, 即token embedding, 而映射后的Y则是vocab的分布. 最后生成的token将基于这个分布进行采样. 比如greedy就会是argmax,即直接取最大值对应的index,去查表找到这个vocab. 对上述过程的直观理解就是: Y可以看作是d与各token表示的相似度构成的向量,选取相似度最大的那个token. 这也是CV中比较传统的pattern matching的思想.
</p>
</div>
</div>

<div id="outline-container-org0fde8a8" class="outline-3">
<h3 id="org0fde8a8"><span class="section-number-3">2.2.</span> Neural Pipeline中的文本输入与输出</h3>
<div class="outline-text-3" id="text-2-2">
<p>
下面来看任务型对话系统Neural Pipeline的输入与输出形态.
</p>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">模块</th>
<th scope="col" class="org-left">输入</th>
<th scope="col" class="org-left">输出</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">NLU+DST</td>
<td class="org-left">history</td>
<td class="org-left">belief state</td>
</tr>

<tr>
<td class="org-left">database retrievaling</td>
<td class="org-left">belief state</td>
<td class="org-left">database matching result</td>
</tr>

<tr>
<td class="org-left">decision (i.e. dialogue policy)</td>
<td class="org-left">belief state and database matching result</td>
<td class="org-left">dialogue action</td>
</tr>

<tr>
<td class="org-left">NLG      case1</td>
<td class="org-left">dialogue action</td>
<td class="org-left">delexicalized response</td>
</tr>

<tr>
<td class="org-left">NLG case2</td>
<td class="org-left">belief state and database matching result</td>
<td class="org-left">delexicalized response</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">lexicalizing</td>
<td class="org-left">delexicalized response belief state datbase</td>
<td class="org-left">response</td>
</tr>
</tbody>
</table>


<p>
上表简单展示了大体上的各模块的输入输出,其中NLU+DST, decision, NLG三个主要部分是Neural Pipeline在进行, 而数据库的的检索和slot填值都可以简单地基于规则进行解决. 此处不会再去介绍每个输入和输出的数据都是什么意思, 但是可以简单写一下上述各个数据的数据结构:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">data structure</th>
<th scope="col" class="org-left">type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">history</td>
<td class="org-left">Vec&lt;String&gt;</td>
</tr>

<tr>
<td class="org-left">belief state</td>
<td class="org-left">HashMap&lt;Domain, HashMap&lt;Slot, Value&gt;&gt;</td>
</tr>

<tr>
<td class="org-left">database matching result</td>
<td class="org-left">HashMap&lt;Domain, Int32&gt;</td>
</tr>

<tr>
<td class="org-left">dialogue action</td>
<td class="org-left">Vec&lt;(Intent, Domain, Slot, Value)&gt;</td>
</tr>

<tr>
<td class="org-left">delexicalized response</td>
<td class="org-left">String</td>
</tr>

<tr>
<td class="org-left">response</td>
<td class="org-left">String</td>
</tr>
</tbody>
</table>

<p>
类型中的domain, slot, value都是什么类型呢? 其实和任务型对话系统的设计有关, multiwoz比较玩具,就都是字符串了.
</p>

<p>
所可以看到, 把上述的结构全部转化为连续的字符串序列是利用预训练模型的第一步, 这个过程在前后端交互中似乎叫serial和deserial. 下面介绍之.
</p>
</div>
</div>

<div id="outline-container-org4354fe6" class="outline-3">
<h3 id="org4354fe6"><span class="section-number-3">2.3.</span> neural pipline与GPT-2的结合</h3>
<div class="outline-text-3" id="text-2-3">
<p>
我们最终的目标是用GPT-2来完成一个pipeline, 所以相当于用history做输出输出belief state, 之后检索数据库得到datbase matching result, 用三者做输入去产生actions, 最终产生delexicalized response.
</p>

<p>
整体架构可用下图表达:
</p>


<div id="org65051d6" class="figure">
<p><img src="./images/screenshot_20220326_173041.png" alt="screenshot_20220326_173041.png" />
</p>
</div>

<p>
serial的过程, 依照不同的代码实现有所不同, 主要而言其实包括两个大的部分:
</p>
<ol class="org-ol">
<li>如何将结构化信息表述成一个序列;</li>
<li>如何对各个子模块进行分隔.</li>
</ol>

<p>
我们可以看一下源码中的实现:
</p>

<p>
关于如何serial belief state:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">format_belief</span><span style="color: #4d9391;">(</span>belief: OrderedDict<span style="color: #4d9391;">)</span> -&gt; <span style="color: #53E6B5;">str</span>:
    <span style="color: #49bdb0;">assert</span> <span style="color: #53E6B5;">isinstance</span><span style="color: #4d9391;">(</span>belief, OrderedDict<span style="color: #4d9391;">)</span>
    str_bs = <span style="color: #4d9391;">[]</span>
    <span style="color: #49bdb0;">for</span> domain, domain_bs <span style="color: #49bdb0;">in</span> belief.items<span style="color: #4d9391;">()</span>:
        <span style="color: #ef6787;">domain_bs</span> = <span style="color: #cea2ca;">', '</span>.join<span style="color: #4d9391;">(</span><span style="color: #47ba99;">[</span>f<span style="color: #cea2ca;">'</span>{slot}<span style="color: #cea2ca;"> = </span>{val}<span style="color: #cea2ca;">'</span> <span style="color: #49bdb0;">for</span> slot, val <span style="color: #49bdb0;">in</span> <span style="color: #53E6B5;">sorted</span><span style="color: #9d81ba;">(</span>domain_bs.items(), key=<span style="color: #49bdb0;">lambda</span> x: x[0]<span style="color: #9d81ba;">)</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
        str_bs.extend<span style="color: #4d9391;">(</span><span style="color: #47ba99;">[</span>domain, <span style="color: #cea2ca;">'{'</span> + domain_bs + <span style="color: #cea2ca;">'}'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
    <span style="color: #49bdb0;">return</span> <span style="color: #cea2ca;">' '</span>.join<span style="color: #4d9391;">(</span>str_bs<span style="color: #4d9391;">)</span>
</pre>
</div>

<p>
关于如何serial dialogue acts(这个是我自己写的):
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">format_dialogue_act</span><span style="color: #4d9391;">(</span>acts<span style="color: #4d9391;">)</span> -&gt; <span style="color: #53E6B5;">str</span>:
    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">assert isinstance(acts, List[List[str]])</span>
    str_da = <span style="color: #4d9391;">[]</span>
    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">intent-domain-slot-value</span>
    <span style="color: #ef6787;">str_acts</span>=<span style="color: #cea2ca;">""</span>
    <span style="color: #49bdb0;">for</span> act <span style="color: #49bdb0;">in</span> <span style="color: #ef6787;">acts</span>:
        <span style="color: #ef6787;">intent</span>,<span style="color: #ef6787;">domain</span>,<span style="color: #ef6787;">slot</span>,<span style="color: #ef6787;">value</span>=act
        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">str_acts+=f"{intent}, {domain}, {slot}, {value}; "</span>
        <span style="color: #ef6787;">str_acts</span>+=f<span style="color: #cea2ca;">"</span>{intent}<span style="color: #cea2ca;">, </span>{domain}<span style="color: #cea2ca;">, </span>{slot}<span style="color: #cea2ca;">; "</span>
    <span style="color: #49bdb0;">return</span> str_acts<span style="color: #4d9391;">[</span>:-2<span style="color: #4d9391;">]</span>
</pre>
</div>

<p>
关于如何serial dialogue acts:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">default_translate_match</span><span style="color: #4d9391;">(</span>n<span style="color: #4d9391;">)</span>:
    <span style="color: #49bdb0;">if</span> n == 0:
        <span style="color: #49bdb0;">return</span> <span style="color: #cea2ca;">'no match'</span>
    <span style="color: #49bdb0;">if</span> n == 1:
        <span style="color: #49bdb0;">return</span> <span style="color: #cea2ca;">'1 match'</span>
    <span style="color: #49bdb0;">return</span> f<span style="color: #cea2ca;">'</span>{n}<span style="color: #cea2ca;"> matches'</span>
</pre>
</div>

<p>
以及如何拼接history!
</p>

<div class="org-src-container">
<pre class="src src-python">    <span style="color: #49bdb0;">class</span> <span style="color: #eed891;">InsertLabelsTransformation</span>:
        user_label: <span style="color: #53E6B5;">str</span> = <span style="color: #cea2ca;">'User :'</span>
        sys_label: <span style="color: #53E6B5;">str</span> = <span style="color: #cea2ca;">'System :'</span>
        database_label: <span style="color: #53E6B5;">str</span> = <span style="color: #cea2ca;">'DB :'</span>
        belief_label: <span style="color: #53E6B5;">str</span> = <span style="color: #cea2ca;">'Belief state :'</span>
        dialogue_act_label: <span style="color: #53E6B5;">str</span> = <span style="color: #cea2ca;">'Action :'</span>
        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">template_label: str = "Template :"</span>

        <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__call__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, sample: DialogDatasetItem<span style="color: #4d9391;">)</span> -&gt; <span style="color: #ef6787;">DialogDatasetItem</span>:
            <span style="color: #49bdb0;">if</span> <span style="color: #53E6B5;">isinstance</span><span style="color: #4d9391;">(</span>sample, <span style="color: #53E6B5;">tuple</span><span style="color: #4d9391;">)</span>:
                sample = DialogDatasetItem<span style="color: #4d9391;">(</span>*sample<span style="color: #4d9391;">)</span>
            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Transform context</span>
<span style="color: #635C4A;">#######################################################################</span>
            <span style="color: #ef6787;">context</span> = sample.context
            <span style="color: #ef6787;">context</span> = <span style="color: #53E6B5;">list</span><span style="color: #4d9391;">(</span>context<span style="color: #4d9391;">)</span>
            <span style="color: #ef6787;">labels</span> = <span style="color: #49bdb0;">self</span>.user_label, <span style="color: #49bdb0;">self</span>.sys_label
            <span style="color: #49bdb0;">for</span> i <span style="color: #49bdb0;">in</span> <span style="color: #53E6B5;">range</span><span style="color: #4d9391;">(</span><span style="color: #53E6B5;">len</span><span style="color: #47ba99;">(</span>context<span style="color: #47ba99;">)</span> - 1, -1, -1<span style="color: #4d9391;">)</span>:
                <span style="color: #ef6787;">label</span>, <span style="color: #ef6787;">other</span> = labels
                <span style="color: #ef6787;">context</span><span style="color: #4d9391;">[</span><span style="color: #ef6787;">i</span><span style="color: #4d9391;">]</span> = label + <span style="color: #cea2ca;">' '</span> + context<span style="color: #4d9391;">[</span>i<span style="color: #4d9391;">]</span>
                <span style="color: #ef6787;">labels</span> = other, label
            <span style="color: #ef6787;">context</span> = <span style="color: #cea2ca;">' '</span>.join<span style="color: #4d9391;">(</span>context<span style="color: #4d9391;">)</span>
<span style="color: #635C4A;">#######################################################################</span>

            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Database</span>
            <span style="color: #ef6787;">database</span> = sample.database
            <span style="color: #49bdb0;">if</span> database <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
                database_str = <span style="color: #4d9391;">[]</span>
                <span style="color: #49bdb0;">for</span> database_domain, database_count <span style="color: #49bdb0;">in</span> database.items<span style="color: #4d9391;">()</span>:
                    database_str.append<span style="color: #4d9391;">(</span>database_domain + <span style="color: #cea2ca;">' '</span> +
                                        default_translate_match<span style="color: #47ba99;">(</span>database_count<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                <span style="color: #ef6787;">database</span> = <span style="color: #49bdb0;">self</span>.database_label + <span style="color: #cea2ca;">' '</span> + <span style="color: #cea2ca;">' , '</span>.join<span style="color: #4d9391;">(</span>database_str<span style="color: #4d9391;">)</span>

            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Belief state</span>
            <span style="color: #ef6787;">belief</span> = sample.belief
            <span style="color: #49bdb0;">if</span> belief <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
                belief = <span style="color: #49bdb0;">self</span>.belief_label + <span style="color: #cea2ca;">' '</span> + belief

            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">dialogue act</span>
            <span style="color: #49bdb0;">if</span> sample.dialogue_act <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
                dialogue_act=sample.dialogue_act
                <span style="color: #ef6787;">dialogue_act</span>=<span style="color: #49bdb0;">self</span>.dialogue_act_label+<span style="color: #cea2ca;">" "</span>+dialogue_act
            <span style="color: #49bdb0;">else</span>:
                dialogue_act=<span style="color: #ef6787;">None</span>

            <span style="color: #635C4A;"># </span><span style="color: #635C4A;"># template</span>
            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">template=sample.template</span>
            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">if template is not None:</span>
            <span style="color: #635C4A;">#     </span><span style="color: #635C4A;">template=self.template_label+" "+ str()</span>
            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">return dataclasses.replace(sample, belief=belief,</span>
                                       <span style="color: #635C4A;"># </span><span style="color: #635C4A;">database=database, context=context,template=template)</span>

            <span style="color: #49bdb0;">return</span> dataclasses.replace<span style="color: #4d9391;">(</span>sample, belief=belief,
                                       database=database,
                                       dialogue_act=dialogue_act,
                                       context=context<span style="color: #4d9391;">)</span>

</pre>
</div>

<p>
上述代码中笔者注释的两行井号中间,就是serial history的部分.
</p>

<p>
完成了上述活动,下一个问题就是,如何进行各个组件的拼接. 各个组件的拼接其实主要是加入一些special token, 当然,上面的Transformation类也插入了一些提示信息,但是这个还不够彻底,还需要加入一些speicaltoken,最终才连接在一起.
</p>

<p>
对speical token的定义比较简单,直接修改tokenizer:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #ef6787;">EOB_TK</span> = <span style="color: #cea2ca;">'&lt;|eob|&gt;'</span>
<span style="color: #ef6787;">EOKB_TK</span> = <span style="color: #cea2ca;">'&lt;|eokb|&gt;'</span>
<span style="color: #ef6787;">EOT_TK</span> = <span style="color: #cea2ca;">'&lt;|endoftext|&gt;'</span>

<span style="color: #ef6787;">SPECIAL_TOKENS</span> = <span style="color: #4d9391;">[</span>EOB_TK, EOKB_TK,
                  <span style="color: #cea2ca;">"&lt;|pd|&gt;"</span>,<span style="color: #cea2ca;">"&lt;|pb|&gt;"</span>,<span style="color: #cea2ca;">"&lt;|pc|&gt;"</span>,
                  <span style="color: #cea2ca;">"&lt;|pa|&gt;"</span>,<span style="color: #cea2ca;">"&lt;|eoda|&gt;"</span>,<span style="color: #cea2ca;">"&lt;|eo_turn|&gt;"</span><span style="color: #4d9391;">]</span>

<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">add_custom_tokens</span><span style="color: #4d9391;">(</span>tokenizer, model<span style="color: #4d9391;">)</span>:
    tokenizer.add_special_tokens<span style="color: #4d9391;">(</span><span style="color: #47ba99;">{</span><span style="color: #cea2ca;">'additional_special_tokens'</span>: SPECIAL_TOKENS<span style="color: #47ba99;">}</span><span style="color: #4d9391;">)</span>
    model.resize_token_embeddings<span style="color: #4d9391;">(</span><span style="color: #53E6B5;">len</span><span style="color: #47ba99;">(</span>tokenizer<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
    <span style="color: #49bdb0;">return</span> tokenizer, model
</pre>
</div>
<p>
其中p开头的和eo都不属于neural pipline的范畴, 是我的工作的一部分&#x2026;&#x2026;
</p>

<p>
之后定义将他们进行拼接的操作:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #49bdb0;">class</span> <span style="color: #eed891;">TokenizerTransformation</span>:
    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__init__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, tokenizer: transformers.GPT2Tokenizer, max_context_length: <span style="color: #53E6B5;">int</span> = 500, is_bi=<span style="color: #ef6787;">False</span><span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">self</span>.<span style="color: #ef6787;">bob</span>, <span style="color: #49bdb0;">self</span>.<span style="color: #ef6787;">eob</span>, <span style="color: #49bdb0;">self</span>.<span style="color: #ef6787;">eokb</span> = tokenizer.convert_tokens_to_ids<span style="color: #4d9391;">(</span>
            <span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'=&gt;'</span>, <span style="color: #cea2ca;">'&lt;|eob|&gt;'</span>, <span style="color: #cea2ca;">'&lt;|eokb|&gt;'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>

        <span style="color: #49bdb0;">self</span>.eos = tokenizer.eos_token_id
        <span style="color: #49bdb0;">self</span>.tokenizer = tokenizer
        <span style="color: #49bdb0;">self</span>.max_context_length = max_context_length

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">get_tokens</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, data<span style="color: #4d9391;">)</span>:
        <span style="color: #ef6787;">history</span>, <span style="color: #ef6787;">belief</span>, <span style="color: #ef6787;">database</span> = data.context, data.belief, data.database
        <span style="color: #ef6787;">response</span>, <span style="color: #ef6787;">positive</span> = data.response, data.positive

        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Add history</span>
        history = <span style="color: #49bdb0;">self</span>.tokenizer.encode<span style="color: #4d9391;">(</span>history<span style="color: #4d9391;">)</span>
        inp = history
        labels = <span style="color: #4d9391;">[</span>-100 <span style="color: #49bdb0;">for</span> _ <span style="color: #49bdb0;">in</span> history<span style="color: #4d9391;">]</span>
        context_end = <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span>labels<span style="color: #4d9391;">)</span>

        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Add belief states</span>
        <span style="color: #49bdb0;">if</span> belief <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
            belief = <span style="color: #4d9391;">[</span><span style="color: #49bdb0;">self</span>.bob<span style="color: #4d9391;">]</span> + <span style="color: #49bdb0;">self</span>.tokenizer.encode<span style="color: #4d9391;">(</span>belief<span style="color: #4d9391;">)</span> + <span style="color: #4d9391;">[</span><span style="color: #49bdb0;">self</span>.eob<span style="color: #4d9391;">]</span>
            inp += belief
            labels += belief

        belief_end = <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span>labels<span style="color: #4d9391;">)</span>

        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Add database</span>
        <span style="color: #49bdb0;">if</span> database <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
            database = <span style="color: #49bdb0;">self</span>.tokenizer.encode<span style="color: #4d9391;">(</span>database<span style="color: #4d9391;">)</span> + <span style="color: #4d9391;">[</span><span style="color: #49bdb0;">self</span>.eokb<span style="color: #4d9391;">]</span>
            inp += database
            labels += <span style="color: #4d9391;">[</span>-100 <span style="color: #49bdb0;">for</span> _ <span style="color: #49bdb0;">in</span> database<span style="color: #4d9391;">]</span>

        database_end = <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span>labels<span style="color: #4d9391;">)</span>

        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Add response</span>
        <span style="color: #49bdb0;">if</span> response <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
            response = <span style="color: #49bdb0;">self</span>.tokenizer.encode<span style="color: #4d9391;">(</span>response<span style="color: #4d9391;">)</span> + <span style="color: #4d9391;">[</span><span style="color: #49bdb0;">self</span>.eos<span style="color: #4d9391;">]</span>
            inp += response
            labels += response

        <span style="color: #49bdb0;">if</span> positive <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span> <span style="color: #49bdb0;">and</span> <span style="color: #49bdb0;">not</span> positive:
            labels = <span style="color: #4d9391;">[</span>-100 <span style="color: #49bdb0;">for</span> _ <span style="color: #49bdb0;">in</span> labels<span style="color: #4d9391;">]</span>

        <span style="color: #49bdb0;">if</span> <span style="color: #49bdb0;">self</span>.max_context_length &gt; 0:

            old_length = <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span>inp<span style="color: #4d9391;">)</span>
            inp = inp<span style="color: #4d9391;">[</span>-<span style="color: #49bdb0;">self</span>.max_context_length:<span style="color: #4d9391;">]</span>
            labels = labels<span style="color: #4d9391;">[</span>-<span style="color: #49bdb0;">self</span>.max_context_length:<span style="color: #4d9391;">]</span>

            belief_end = belief_end - <span style="color: #4d9391;">(</span>old_length - <span style="color: #53E6B5;">len</span><span style="color: #47ba99;">(</span>inp<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
            context_end = context_end - <span style="color: #4d9391;">(</span>old_length - <span style="color: #53E6B5;">len</span><span style="color: #47ba99;">(</span>inp<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
            database_end = database_end - <span style="color: #4d9391;">(</span>old_length - <span style="color: #53E6B5;">len</span><span style="color: #47ba99;">(</span>inp<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>

        <span style="color: #49bdb0;">return</span> inp, labels, positive, belief_end, context_end, database_end

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">-100 is mask token for LM</span>
    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">transforms into dict {"input_ids", "labels", "binary_labels", "binary_token_ids" }</span>
    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">binary_labels are used for task 3</span>
    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__call__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, data<span style="color: #4d9391;">)</span>:
        <span style="color: #ef6787;">inp</span>, <span style="color: #ef6787;">labels</span>, <span style="color: #ef6787;">positive</span>, <span style="color: #ef6787;">belief_end</span>, <span style="color: #ef6787;">context_end</span>, <span style="color: #ef6787;">database_end</span> = <span style="color: #49bdb0;">self</span>.get_tokens<span style="color: #4d9391;">(</span>data<span style="color: #4d9391;">)</span>
        belief_labels = <span style="color: #4d9391;">[</span>x <span style="color: #49bdb0;">if</span> i &lt; belief_end <span style="color: #49bdb0;">else</span> -100 <span style="color: #49bdb0;">for</span> i, x <span style="color: #49bdb0;">in</span> <span style="color: #53E6B5;">enumerate</span><span style="color: #47ba99;">(</span>labels<span style="color: #47ba99;">)</span><span style="color: #4d9391;">]</span>
        response_labels = <span style="color: #4d9391;">[</span>x <span style="color: #49bdb0;">if</span> i &gt;= belief_end <span style="color: #49bdb0;">else</span> -100 <span style="color: #49bdb0;">for</span> i, x <span style="color: #49bdb0;">in</span> <span style="color: #53E6B5;">enumerate</span><span style="color: #47ba99;">(</span>labels<span style="color: #47ba99;">)</span><span style="color: #4d9391;">]</span>
        <span style="color: #49bdb0;">return</span> <span style="color: #53E6B5;">dict</span><span style="color: #4d9391;">(</span>input_ids=inp, belief_labels=belief_labels, response_labels=response_labels,
                    consistency_labels=positive, consistency_token_ids=<span style="color: #53E6B5;">len</span><span style="color: #47ba99;">(</span>labels<span style="color: #47ba99;">)</span> - 1<span style="color: #4d9391;">)</span>

</pre>
</div>

<p>
其中,注意到常常会使用 <b>-100</b>, 这个-100是一个特殊的token, 该token不会被计算损失. 所以上述代码中,作为prefix的history是不会被计算损失的,同理,database的matching结果, 由于是检索得到的,所以其标签也被设置为了-100.
</p>

<p>
可以看出, 在 <code>get_tokens</code> 里定义了所有的连接操作, 该transformation最终将会返回得到5个结果:
</p>
<ol class="org-ol">
<li>input_ids: 即前篇所说的token encoding</li>
<li>belief_labels: 即belief state的label值,用作监督信号</li>
<li>response_labels: 同理</li>
<li>consistency_labels: 这个是一致性的标签,只包括01两种情况, 后面在任务中会详细介绍</li>
<li>consistency_token_ids 即eos token, 换句话说, eos token的embedding,将会通过一个分类器,进行是否一致的二分类.</li>
</ol>

<p>
上述的5个输入, 将会通过下面的wrapper进行封装,此处的封装便是NLP常用的所需的封装了.
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="color: #eed891;">@dataclass</span>
<span style="color: #49bdb0;">class</span> <span style="color: #eed891;">DataCollatorWithPadding</span>:
    tokenizer: Union<span style="color: #4d9391;">[</span>transformers.PreTrainedTokenizer,
                     transformers.PreTrainedTokenizerFast<span style="color: #4d9391;">]</span>
    max_length: Optional<span style="color: #4d9391;">[</span><span style="color: #53E6B5;">int</span><span style="color: #4d9391;">]</span> = <span style="color: #ef6787;">None</span>

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__call__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, features: List<span style="color: #47ba99;">[</span>Dict<span style="color: #9d81ba;">[</span><span style="color: #53E6B5;">str</span>, Union[List<span style="color: #35BF88;">[</span><span style="color: #53E6B5;">int</span><span style="color: #35BF88;">]</span>, torch.Tensor,<span style="color: #53E6B5;">float</span>]<span style="color: #9d81ba;">]</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span> -&gt; <span style="color: #ef6787;">Dict</span><span style="color: #4d9391;">[</span><span style="color: #53E6B5;">str</span>, torch.Tensor<span style="color: #4d9391;">]</span>:
        batch = <span style="color: #4d9391;">{</span>
            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">"attention_mask":torch.tensor([x["attention_mask"].numpy() for x in features]),</span>
            <span style="color: #cea2ca;">'consistency_labels'</span>: torch.tensor<span style="color: #47ba99;">(</span><span style="color: #9d81ba;">[</span>x[<span style="color: #cea2ca;">'consistency_labels'</span>] <span style="color: #49bdb0;">for</span> x <span style="color: #49bdb0;">in</span> features<span style="color: #9d81ba;">]</span>, dtype=torch.float32<span style="color: #47ba99;">)</span>,
            <span style="color: #cea2ca;">'consistency_token_ids'</span>: torch.tensor<span style="color: #47ba99;">(</span><span style="color: #9d81ba;">[</span>x[<span style="color: #cea2ca;">'consistency_token_ids'</span>] <span style="color: #49bdb0;">for</span> x <span style="color: #49bdb0;">in</span> features<span style="color: #9d81ba;">]</span>, dtype=torch.int64<span style="color: #47ba99;">)</span>,
            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">'input_ids': pad_sequence([torch.tensor(x['input_ids'], dtype=torch.int64) for x in features],</span>
                                      <span style="color: #635C4A;"># </span><span style="color: #635C4A;">batch_first=True, padding_value=self.tokenizer.pad_token_id),</span>
            <span style="color: #cea2ca;">'belief_labels'</span>: pad_sequence<span style="color: #47ba99;">(</span><span style="color: #9d81ba;">[</span>torch.tensor(x<span style="color: #35BF88;">[</span><span style="color: #cea2ca;">'belief_labels'</span><span style="color: #35BF88;">]</span>, dtype=torch.int64) <span style="color: #49bdb0;">for</span> x <span style="color: #49bdb0;">in</span> features<span style="color: #9d81ba;">]</span>,
                                          batch_first=<span style="color: #ef6787;">True</span>, padding_value=-100<span style="color: #47ba99;">)</span>,
        <span style="color: #4d9391;">}</span>

        <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">"position_ids"</span> <span style="color: #49bdb0;">in</span> features<span style="color: #4d9391;">[</span>0<span style="color: #4d9391;">]</span>:
            <span style="color: #49bdb0;">if</span> features<span style="color: #4d9391;">[</span>0<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">"position_ids"</span><span style="color: #4d9391;">]</span> <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
                batch<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">"position_ids"</span><span style="color: #4d9391;">]</span>=pad_sequence<span style="color: #4d9391;">(</span><span style="color: #47ba99;">[</span>x<span style="color: #9d81ba;">[</span><span style="color: #cea2ca;">"position_ids"</span><span style="color: #9d81ba;">]</span> <span style="color: #49bdb0;">for</span> x <span style="color: #49bdb0;">in</span> features<span style="color: #47ba99;">]</span>,batch_first=<span style="color: #ef6787;">True</span>,padding_value=0<span style="color: #4d9391;">)</span>
                <span style="color: #635C4A;"># </span><span style="color: #635C4A;">print(batch["position_ids"].shape)</span>
                <span style="color: #635C4A;"># </span><span style="color: #635C4A;">print(batch["input_ids"].shape)</span>
                <span style="color: #635C4A;"># </span><span style="color: #635C4A;">print("=============")</span>

        <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">"states_ids"</span> <span style="color: #49bdb0;">in</span> features<span style="color: #4d9391;">[</span>0<span style="color: #4d9391;">]</span>:
            <span style="color: #49bdb0;">if</span> features<span style="color: #4d9391;">[</span>0<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">"states_ids"</span><span style="color: #4d9391;">]</span> <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
                batch<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">"states_ids"</span><span style="color: #4d9391;">]</span>=pad_sequence<span style="color: #4d9391;">(</span><span style="color: #47ba99;">[</span>torch.tensor<span style="color: #9d81ba;">(</span>x[<span style="color: #cea2ca;">"states_ids"</span>],dtype=torch.int64<span style="color: #9d81ba;">)</span> <span style="color: #49bdb0;">for</span> x <span style="color: #49bdb0;">in</span> features<span style="color: #47ba99;">]</span>,batch_first=<span style="color: #ef6787;">True</span>,padding_value=<span style="color: #49bdb0;">self</span>.tokenizer.pad_token_id<span style="color: #4d9391;">)</span>

        <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">"his_ids"</span> <span style="color: #49bdb0;">in</span> features<span style="color: #4d9391;">[</span>0<span style="color: #4d9391;">]</span>:
            <span style="color: #49bdb0;">if</span> features<span style="color: #4d9391;">[</span>0<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">"his_ids"</span><span style="color: #4d9391;">]</span> <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
                batch<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">"his_ids"</span><span style="color: #4d9391;">]</span>=pad_sequence<span style="color: #4d9391;">(</span><span style="color: #47ba99;">[</span>torch.tensor<span style="color: #9d81ba;">(</span>x[<span style="color: #cea2ca;">"his_ids"</span>],dtype=torch.int64<span style="color: #9d81ba;">)</span> <span style="color: #49bdb0;">for</span> x <span style="color: #49bdb0;">in</span> features<span style="color: #47ba99;">]</span>,batch_first=<span style="color: #ef6787;">True</span>,padding_value=<span style="color: #49bdb0;">self</span>.tokenizer.pad_token_id<span style="color: #4d9391;">)</span>

        <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">"response_labels"</span> <span style="color: #49bdb0;">in</span> features<span style="color: #4d9391;">[</span>0<span style="color: #4d9391;">]</span>:
            batch<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">"response_labels"</span><span style="color: #4d9391;">]</span>= pad_sequence<span style="color: #4d9391;">(</span><span style="color: #47ba99;">[</span>torch.tensor<span style="color: #9d81ba;">(</span>x[<span style="color: #cea2ca;">'response_labels'</span>], dtype=torch.int64<span style="color: #9d81ba;">)</span> <span style="color: #49bdb0;">for</span> x <span style="color: #49bdb0;">in</span> features<span style="color: #47ba99;">]</span>,batch_first=<span style="color: #ef6787;">True</span>, padding_value=-100<span style="color: #4d9391;">)</span>
        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">else:</span>
        <span style="color: #635C4A;">#     </span><span style="color: #635C4A;">batch["response_labels"]=None </span>

        <span style="color: #49bdb0;">return</span> batch
</pre>
</div>

<p>
这里所采取的便是padding的操作,基于 <code>pad_sequence</code> 函数. 值得注意的是, 此处形成的一个tensor,其shape为batchsize*max_seqlen. max_seqlen是指这个batch中的最长数据的长度, 而非模型的max seq length.
</p>
</div>
</div>








<div id="outline-container-org98e7cda" class="outline-3">
<h3 id="org98e7cda"><span class="section-number-3">2.4.</span> 再坚持一下: 为什么说一个TOD很复杂?</h3>
<div class="outline-text-3" id="text-2-4">
<p>
如果你认为上述部分就是TOD data部分源码的核心, 未免有点小看任务型对话系统的复杂度了. 因为我们其实还没有正式开始介绍全部的流程. 
</p>
</div>
<div id="outline-container-org4edc5e1" class="outline-4">
<h4 id="org4edc5e1"><span class="section-number-4">2.4.1.</span> 如何预处理任务型对话系统数据集?</h4>
<div class="outline-text-4" id="text-2-4-1">
<p>
略.
这部分代码我还没开始看,后续补充.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #635C4A;">#</span><span style="color: #635C4A;">!/usr/bin/env python</span>
<span style="color: #49bdb0;">import</span> sqlite3
<span style="color: #49bdb0;">import</span> json
<span style="color: #49bdb0;">import</span> os
<span style="color: #49bdb0;">import</span> tempfile
<span style="color: #49bdb0;">import</span> re
<span style="color: #49bdb0;">import</span> shutil
<span style="color: #49bdb0;">import</span> requests
<span style="color: #49bdb0;">import</span> random
<span style="color: #49bdb0;">import</span> logging
<span style="color: #49bdb0;">import</span> subprocess
<span style="color: #49bdb0;">import</span> sys
<span style="color: #49bdb0;">from</span> collections <span style="color: #49bdb0;">import</span> defaultdict
<span style="color: #49bdb0;">from</span> copy <span style="color: #49bdb0;">import</span> deepcopy
<span style="color: #49bdb0;">import</span> zipfile
<span style="color: #49bdb0;">import</span> inspect
<span style="color: #49bdb0;">from</span> collections <span style="color: #49bdb0;">import</span> OrderedDict, Counter
<span style="color: #49bdb0;">from</span> tqdm <span style="color: #49bdb0;">import</span> tqdm
<span style="color: #49bdb0;">import</span> numpy <span style="color: #49bdb0;">as</span> np

sys.path.append<span style="color: #4d9391;">(</span>os.path.dirname<span style="color: #47ba99;">(</span>os.path.dirname<span style="color: #9d81ba;">(</span>os.path.abspath(__file__)<span style="color: #9d81ba;">)</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
<span style="color: #49bdb0;">from</span> utils <span style="color: #49bdb0;">import</span> setup_logging  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">noqa: E402</span>


np.set_printoptions<span style="color: #4d9391;">(</span>precision=3<span style="color: #4d9391;">)</span>
np.random.seed<span style="color: #4d9391;">(</span>2<span style="color: #4d9391;">)</span>
setup_logging<span style="color: #4d9391;">()</span>
logger = logging.getLogger<span style="color: #4d9391;">()</span>

<span style="color: #635C4A;"># </span><span style="color: #635C4A;">GLOBAL VARIABLES</span>
DATASETS_PATH = os.path.join<span style="color: #4d9391;">(</span>os.path.expanduser<span style="color: #47ba99;">(</span>os.environ.get<span style="color: #9d81ba;">(</span><span style="color: #cea2ca;">'DATASETS_PATH'</span>, <span style="color: #cea2ca;">'~/datasets'</span><span style="color: #9d81ba;">)</span><span style="color: #47ba99;">)</span>, <span style="color: #cea2ca;">'soloist'</span><span style="color: #4d9391;">)</span>
DICT_SIZE = 400
MAX_LENGTH = 50
DEFAULT_IGNORE_VALUES = <span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'not mentioned'</span>, <span style="color: #cea2ca;">'dont care'</span>, <span style="color: #cea2ca;">'don\'t care'</span>, <span style="color: #cea2ca;">'dontcare'</span>, <span style="color: #cea2ca;">'do n\'t care'</span>, <span style="color: #cea2ca;">'none'</span><span style="color: #4d9391;">]</span>
MW_DOMAINS = <span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'restaurant'</span>, <span style="color: #cea2ca;">'hotel'</span>, <span style="color: #cea2ca;">'attraction'</span>, <span style="color: #cea2ca;">'train'</span>, <span style="color: #cea2ca;">'taxi'</span>, <span style="color: #cea2ca;">'hospital'</span>, <span style="color: #cea2ca;">'police'</span><span style="color: #4d9391;">]</span>
digitpat = re.<span style="color: #53E6B5;">compile</span><span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'\d+'</span><span style="color: #4d9391;">)</span>
timepat = re.<span style="color: #53E6B5;">compile</span><span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">"\d{1,2}[:]\d{1,2}"</span><span style="color: #4d9391;">)</span>
pricepat2 = re.<span style="color: #53E6B5;">compile</span><span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">"\d{1,3}[.]\d{1,2}"</span><span style="color: #4d9391;">)</span>
timepat = re.<span style="color: #53E6B5;">compile</span><span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">"\d{1,2}[:]\d{1,2}"</span><span style="color: #4d9391;">)</span>
label_regex = re.<span style="color: #53E6B5;">compile</span><span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'\[([\w\d\s]+)\]'</span><span style="color: #4d9391;">)</span>
pricepat = re.<span style="color: #53E6B5;">compile</span><span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">"\d{1,3}[.]\d{1,2}"</span><span style="color: #4d9391;">)</span>
fin = <span style="color: #53E6B5;">open</span><span style="color: #4d9391;">(</span>os.path.join<span style="color: #47ba99;">(</span>os.path.dirname<span style="color: #9d81ba;">(</span>__file__<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'mapping.pair'</span><span style="color: #47ba99;">)</span>, <span style="color: #cea2ca;">'r'</span><span style="color: #4d9391;">)</span>
replacements = <span style="color: #4d9391;">[]</span>
<span style="color: #49bdb0;">for</span> line <span style="color: #49bdb0;">in</span> fin.readlines<span style="color: #4d9391;">()</span>:
    <span style="color: #ef6787;">tok_from</span>, <span style="color: #ef6787;">tok_to</span> = line.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'\n'</span>, <span style="color: #cea2ca;">''</span><span style="color: #4d9391;">)</span>.split<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'\t'</span><span style="color: #4d9391;">)</span>
    replacements.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span><span style="color: #cea2ca;">' '</span> + tok_from + <span style="color: #cea2ca;">' '</span>, <span style="color: #cea2ca;">' '</span> + tok_to + <span style="color: #cea2ca;">' '</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>


<span style="color: #49bdb0;">class</span> <span style="color: #eed891;">Lexicalizer</span>:
    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__init__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, zipf<span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">self</span>.path = zipf.filename

    placeholder_re = re.<span style="color: #53E6B5;">compile</span><span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'\[(\s*[\w_\s]+)\s*\]'</span><span style="color: #4d9391;">)</span>
    number_re = re.<span style="color: #53E6B5;">compile</span><span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'.*(\d+|one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve)\s$'</span><span style="color: #4d9391;">)</span>
    time_re = re.<span style="color: #53E6B5;">compile</span><span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'((?:\d{1,2}[:]\d{2,3})|(?:\d{1,2} (?:am|pm)))'</span>, re.IGNORECASE<span style="color: #4d9391;">)</span>

    @<span style="color: #53E6B5;">staticmethod</span>
    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">ends_with_number</span><span style="color: #4d9391;">(</span>s<span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">return</span> <span style="color: #53E6B5;">bool</span><span style="color: #4d9391;">(</span>Lexicalizer.number_re.match<span style="color: #47ba99;">(</span>s<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>

    @<span style="color: #53E6B5;">staticmethod</span>
    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">extend_database_results</span><span style="color: #4d9391;">(</span>database_results, belief<span style="color: #4d9391;">)</span>:
        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Augment database results from the belief state</span>
        database_results = OrderedDict<span style="color: #4d9391;">(</span>database_results<span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">if</span> belief <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
            <span style="color: #49bdb0;">for</span> i, <span style="color: #4d9391;">(</span>domain, <span style="color: #47ba99;">(</span>num_results, results<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">in</span> <span style="color: #53E6B5;">enumerate</span><span style="color: #4d9391;">(</span>database_results.items<span style="color: #47ba99;">()</span><span style="color: #4d9391;">)</span>:
                <span style="color: #49bdb0;">if</span> domain <span style="color: #49bdb0;">not</span> <span style="color: #49bdb0;">in</span> belief:
                    <span style="color: #49bdb0;">continue</span>
                <span style="color: #49bdb0;">if</span> num_results == 0:
                    database_results<span style="color: #4d9391;">[</span><span style="color: #ef6787;">domain</span><span style="color: #4d9391;">]</span> = <span style="color: #4d9391;">(</span>1, <span style="color: #47ba99;">[</span>belief<span style="color: #9d81ba;">[</span>domain<span style="color: #9d81ba;">]</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
                <span style="color: #49bdb0;">else</span>:
                    new_results = <span style="color: #4d9391;">[]</span>
                    <span style="color: #49bdb0;">for</span> r <span style="color: #49bdb0;">in</span> results:
                        r = <span style="color: #53E6B5;">dict</span><span style="color: #4d9391;">(</span>**r<span style="color: #4d9391;">)</span>
                        <span style="color: #49bdb0;">for</span> k, val <span style="color: #49bdb0;">in</span> belief<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">]</span>.items<span style="color: #4d9391;">()</span>:
                            <span style="color: #49bdb0;">if</span> k <span style="color: #49bdb0;">not</span> <span style="color: #49bdb0;">in</span> r:
                                r<span style="color: #4d9391;">[</span><span style="color: #ef6787;">k</span><span style="color: #4d9391;">]</span> = val
                        new_results.append<span style="color: #4d9391;">(</span>r<span style="color: #4d9391;">)</span>
                    database_results<span style="color: #4d9391;">[</span><span style="color: #ef6787;">domain</span><span style="color: #4d9391;">]</span> = <span style="color: #4d9391;">(</span>num_results, new_results<span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">return</span> database_results

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__call__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, text, database_results, belief=<span style="color: #ef6787;">None</span>, context=<span style="color: #ef6787;">None</span><span style="color: #4d9391;">)</span>:
        database_results = Lexicalizer.extend_database_results<span style="color: #4d9391;">(</span>database_results, belief<span style="color: #4d9391;">)</span>
        result_index = 0
        last_assignment = defaultdict<span style="color: #4d9391;">(</span><span style="color: #53E6B5;">set</span><span style="color: #4d9391;">)</span>

        <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">trans</span><span style="color: #4d9391;">(</span>label, span, force=<span style="color: #ef6787;">False</span>, loop=100<span style="color: #4d9391;">)</span>:
            <span style="color: #49bdb0;">nonlocal</span> result_index
            <span style="color: #49bdb0;">nonlocal</span> last_assignment
            result_str = <span style="color: #ef6787;">None</span>
            current_domain = <span style="color: #ef6787;">None</span>
            <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'_'</span> <span style="color: #49bdb0;">in</span> label:
                current_domain = label<span style="color: #4d9391;">[</span>:label.index<span style="color: #47ba99;">(</span><span style="color: #cea2ca;">'_'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">]</span>
                label = label<span style="color: #4d9391;">[</span>label.index<span style="color: #47ba99;">(</span><span style="color: #cea2ca;">'_'</span><span style="color: #47ba99;">)</span> + 1:<span style="color: #4d9391;">]</span>
            <span style="color: #49bdb0;">if</span> label == <span style="color: #cea2ca;">'postcode'</span>:
                label = <span style="color: #cea2ca;">'post code'</span>

            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">No references in the MW 2.0 database</span>
            <span style="color: #49bdb0;">if</span> label == <span style="color: #cea2ca;">'reference'</span>:
                <span style="color: #49bdb0;">return</span> <span style="color: #cea2ca;">'YF86GE4J'</span>

            <span style="color: #49bdb0;">for</span> domain, <span style="color: #4d9391;">(</span>count, results<span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">in</span> database_results.items<span style="color: #4d9391;">()</span>:
                <span style="color: #49bdb0;">if</span> count == 0:
                    <span style="color: #49bdb0;">continue</span>
                <span style="color: #49bdb0;">if</span> current_domain <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span> <span style="color: #49bdb0;">and</span> domain != current_domain <span style="color: #49bdb0;">and</span> <span style="color: #49bdb0;">not</span> force:
                    <span style="color: #49bdb0;">continue</span>
                result = results<span style="color: #4d9391;">[</span>result_index % <span style="color: #53E6B5;">len</span><span style="color: #47ba99;">(</span>results<span style="color: #47ba99;">)</span><span style="color: #4d9391;">]</span>
                <span style="color: #49bdb0;">if</span> label <span style="color: #49bdb0;">in</span> result:
                    result_str = <span style="color: #53E6B5;">str</span><span style="color: #4d9391;">(</span>result<span style="color: #47ba99;">[</span>label<span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
                    <span style="color: #49bdb0;">if</span> result_str == <span style="color: #cea2ca;">'?'</span>:
                        result_str = <span style="color: #cea2ca;">'unknown'</span>
                    <span style="color: #49bdb0;">if</span> label == <span style="color: #cea2ca;">'price range'</span> <span style="color: #49bdb0;">and</span> result_str == <span style="color: #cea2ca;">'moderate'</span> <span style="color: #49bdb0;">and</span> \
                            <span style="color: #49bdb0;">not</span> text<span style="color: #4d9391;">[</span>span<span style="color: #47ba99;">[</span>1<span style="color: #47ba99;">]</span>:<span style="color: #4d9391;">]</span>.startswith<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">' price range'</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">and</span> \
                            <span style="color: #49bdb0;">not</span> text<span style="color: #4d9391;">[</span>span<span style="color: #47ba99;">[</span>1<span style="color: #47ba99;">]</span>:<span style="color: #4d9391;">]</span>.startswith<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">' in price'</span><span style="color: #4d9391;">)</span>:
                        result_str = <span style="color: #cea2ca;">'moderately priced'</span>
                    <span style="color: #49bdb0;">if</span> label == <span style="color: #cea2ca;">'type'</span>:
                        <span style="color: #49bdb0;">if</span> text<span style="color: #4d9391;">[</span>:span<span style="color: #47ba99;">[</span>0<span style="color: #47ba99;">]</span><span style="color: #4d9391;">]</span>.endswith<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'no '</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">or</span> text<span style="color: #4d9391;">[</span>:span<span style="color: #47ba99;">[</span>0<span style="color: #47ba99;">]</span><span style="color: #4d9391;">]</span>.endswith<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'any '</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">or</span> \
                                text<span style="color: #4d9391;">[</span>:span<span style="color: #47ba99;">[</span>0<span style="color: #47ba99;">]</span><span style="color: #4d9391;">]</span>.endswith<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'some '</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">or</span> Lexicalizer.ends_with_number<span style="color: #4d9391;">(</span>text<span style="color: #47ba99;">[</span>:span<span style="color: #9d81ba;">[</span>0<span style="color: #9d81ba;">]</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>:
                            <span style="color: #49bdb0;">if</span> <span style="color: #49bdb0;">not</span> result_str.endswith<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'s'</span><span style="color: #4d9391;">)</span>:
                                result_str += <span style="color: #cea2ca;">'s'</span>
                <span style="color: #49bdb0;">if</span> label == <span style="color: #cea2ca;">'time'</span> <span style="color: #49bdb0;">and</span> <span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'[leave at]'</span> <span style="color: #49bdb0;">in</span> text <span style="color: #49bdb0;">or</span> <span style="color: #cea2ca;">'[arrive by]'</span> <span style="color: #49bdb0;">in</span> text<span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">and</span> \
                    belief <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span> <span style="color: #49bdb0;">and</span> <span style="color: #cea2ca;">'train'</span> <span style="color: #49bdb0;">in</span> belief <span style="color: #49bdb0;">and</span> \
                        <span style="color: #53E6B5;">any</span><span style="color: #4d9391;">(</span><span style="color: #47ba99;">[</span>k <span style="color: #49bdb0;">in</span> belief<span style="color: #9d81ba;">[</span><span style="color: #cea2ca;">'train'</span><span style="color: #9d81ba;">]</span> <span style="color: #49bdb0;">for</span> k <span style="color: #49bdb0;">in</span> <span style="color: #9d81ba;">(</span><span style="color: #cea2ca;">'leave at'</span>, <span style="color: #cea2ca;">'arrive by'</span><span style="color: #9d81ba;">)</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>:
                    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">this is a specific case in which additional [time] slot needs to be lexicalised</span>
                    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">directly from the belief state</span>
                    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">"The earliest train after [time] leaves at ... and arrives by ..."</span>
                    <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'leave at'</span> <span style="color: #49bdb0;">in</span> belief<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'train'</span><span style="color: #4d9391;">]</span>:
                        result_str = belief<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'train'</span><span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'leave at'</span><span style="color: #4d9391;">]</span>
                    <span style="color: #49bdb0;">else</span>:
                        result_str = belief<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'train'</span><span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'arrive by'</span><span style="color: #4d9391;">]</span>
                <span style="color: #49bdb0;">elif</span> force:
                    <span style="color: #49bdb0;">if</span> label == <span style="color: #cea2ca;">'time'</span>:
                        <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'leave at'</span> <span style="color: #49bdb0;">in</span> result <span style="color: #49bdb0;">or</span> <span style="color: #cea2ca;">'arrive by'</span> <span style="color: #49bdb0;">in</span> result:
                            <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'arrive'</span> <span style="color: #49bdb0;">in</span> text <span style="color: #49bdb0;">and</span> <span style="color: #cea2ca;">'arrive by'</span> <span style="color: #49bdb0;">in</span> result:
                                result_str = result<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'arrive by'</span><span style="color: #4d9391;">]</span>.lstrip<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'0'</span><span style="color: #4d9391;">)</span>
                            <span style="color: #49bdb0;">elif</span> <span style="color: #cea2ca;">'leave at'</span> <span style="color: #49bdb0;">in</span> result:
                                result_str = result<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'leave at'</span><span style="color: #4d9391;">]</span>.lstrip<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'0'</span><span style="color: #4d9391;">)</span>
                        <span style="color: #49bdb0;">elif</span> context <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span> <span style="color: #49bdb0;">and</span> <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span>context<span style="color: #4d9391;">)</span> &gt; 0:
                            last_utt = context<span style="color: #4d9391;">[</span>-1<span style="color: #4d9391;">]</span>
                            mtch = Lexicalizer.time_re.search<span style="color: #4d9391;">(</span>last_utt<span style="color: #4d9391;">)</span>
                            <span style="color: #49bdb0;">if</span> mtch <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
                                result_str = mtch.group<span style="color: #4d9391;">(</span>1<span style="color: #4d9391;">)</span>.lstrip<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'0'</span><span style="color: #4d9391;">)</span>
                <span style="color: #49bdb0;">if</span> result_str <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
                    <span style="color: #49bdb0;">break</span>
            <span style="color: #49bdb0;">if</span> force <span style="color: #49bdb0;">and</span> result_str <span style="color: #49bdb0;">is</span> <span style="color: #ef6787;">None</span>:
                <span style="color: #49bdb0;">if</span> label == <span style="color: #cea2ca;">'reference'</span>:
                    result_str = <span style="color: #cea2ca;">'YF86GE4J'</span>
                <span style="color: #49bdb0;">elif</span> label == <span style="color: #cea2ca;">'phone'</span>:
                    result_str = <span style="color: #cea2ca;">'01223358966'</span>
                <span style="color: #49bdb0;">elif</span> label == <span style="color: #cea2ca;">'postcode'</span>:
                    result_str = <span style="color: #cea2ca;">'CB11JG'</span>
                <span style="color: #49bdb0;">elif</span> label == <span style="color: #cea2ca;">'agent'</span>:
                    result_str = <span style="color: #cea2ca;">'Cambridge Towninfo Centre'</span>
                <span style="color: #49bdb0;">elif</span> label == <span style="color: #cea2ca;">'stars'</span>:
                    result_str = <span style="color: #cea2ca;">'4'</span>

            <span style="color: #49bdb0;">if</span> result_str <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span> <span style="color: #49bdb0;">and</span> result_str.lower<span style="color: #4d9391;">()</span> <span style="color: #49bdb0;">in</span> last_assignment<span style="color: #4d9391;">[</span>label<span style="color: #4d9391;">]</span> <span style="color: #49bdb0;">and</span> loop &gt; 0:
                result_index += 1
                <span style="color: #49bdb0;">return</span> trans<span style="color: #4d9391;">(</span>label, force=force, loop=loop - 1, span=span<span style="color: #4d9391;">)</span>

            <span style="color: #49bdb0;">if</span> result_str <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
                last_assignment<span style="color: #4d9391;">[</span>label<span style="color: #4d9391;">]</span>.add<span style="color: #4d9391;">(</span>result_str.lower<span style="color: #47ba99;">()</span><span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">return</span> result_str <span style="color: #49bdb0;">or</span> f<span style="color: #cea2ca;">'[</span>{label}<span style="color: #cea2ca;">]'</span>

        text = Lexicalizer.placeholder_re.sub<span style="color: #4d9391;">(</span><span style="color: #49bdb0;">lambda</span> m: trans<span style="color: #47ba99;">(</span>m.group<span style="color: #9d81ba;">(</span>1<span style="color: #9d81ba;">)</span>, span=m.span<span style="color: #9d81ba;">()</span><span style="color: #47ba99;">)</span>, text<span style="color: #4d9391;">)</span>
        text = Lexicalizer.placeholder_re.sub<span style="color: #4d9391;">(</span><span style="color: #49bdb0;">lambda</span> m: trans<span style="color: #47ba99;">(</span>m.group<span style="color: #9d81ba;">(</span>1<span style="color: #9d81ba;">)</span>, force=<span style="color: #ef6787;">True</span>, span=m.span<span style="color: #9d81ba;">()</span><span style="color: #47ba99;">)</span>, text<span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">return</span> text

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">save</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, path<span style="color: #4d9391;">)</span>:
        shutil.copy<span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>.path, os.path.join<span style="color: #47ba99;">(</span>path, os.path.split<span style="color: #9d81ba;">(</span><span style="color: #49bdb0;">self</span>.path<span style="color: #9d81ba;">)[</span>-1<span style="color: #9d81ba;">]</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">clear_whitespaces</span><span style="color: #4d9391;">(</span>text<span style="color: #4d9391;">)</span>:
    text = re.sub<span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'[\s\n\r]+'</span>, <span style="color: #cea2ca;">' '</span>, text<span style="color: #4d9391;">)</span>
    text = <span style="color: #cea2ca;">' '</span> + text + <span style="color: #cea2ca;">' '</span>
    text = re.sub<span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'\s([,\.:\?\!\']+)'</span>, <span style="color: #49bdb0;">lambda</span> m: m.group<span style="color: #47ba99;">(</span>1<span style="color: #47ba99;">)</span>, text<span style="color: #4d9391;">)</span>
    <span style="color: #49bdb0;">return</span> text.strip<span style="color: #4d9391;">()</span>


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">insertSpace</span><span style="color: #4d9391;">(</span>token, text<span style="color: #4d9391;">)</span>:
    sidx = 0
    <span style="color: #49bdb0;">while</span> <span style="color: #ef6787;">True</span>:
        sidx = text.find<span style="color: #4d9391;">(</span>token, sidx<span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">if</span> sidx == -1:
            <span style="color: #49bdb0;">break</span>
        <span style="color: #49bdb0;">if</span> sidx + 1 &lt; <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span>text<span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">and</span> re.match<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'[0-9]'</span>, text<span style="color: #47ba99;">[</span>sidx - 1<span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">and</span> \
                re.match<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'[0-9]'</span>, text<span style="color: #47ba99;">[</span>sidx + 1<span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>:
            sidx += 1
            <span style="color: #49bdb0;">continue</span>
        <span style="color: #49bdb0;">if</span> text<span style="color: #4d9391;">[</span>sidx - 1<span style="color: #4d9391;">]</span> != <span style="color: #cea2ca;">' '</span>:
            text = text<span style="color: #4d9391;">[</span>:sidx<span style="color: #4d9391;">]</span> + <span style="color: #cea2ca;">' '</span> + text<span style="color: #4d9391;">[</span>sidx:<span style="color: #4d9391;">]</span>
            sidx += 1
        <span style="color: #49bdb0;">if</span> sidx + <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span>token<span style="color: #4d9391;">)</span> &lt; <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span>text<span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">and</span> text<span style="color: #4d9391;">[</span>sidx + <span style="color: #53E6B5;">len</span><span style="color: #47ba99;">(</span>token<span style="color: #47ba99;">)</span><span style="color: #4d9391;">]</span> != <span style="color: #cea2ca;">' '</span>:
            text = text<span style="color: #4d9391;">[</span>:sidx + 1<span style="color: #4d9391;">]</span> + <span style="color: #cea2ca;">' '</span> + text<span style="color: #4d9391;">[</span>sidx + 1:<span style="color: #4d9391;">]</span>
        sidx += 1
    <span style="color: #49bdb0;">return</span> text


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">normalize</span><span style="color: #4d9391;">(</span>text<span style="color: #4d9391;">)</span>:
    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">lower case every word</span>
    text = text.lower<span style="color: #4d9391;">()</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">replace white spaces in front and end</span>
    text = re.sub<span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'^\s*|\s*$'</span>, <span style="color: #cea2ca;">''</span>, text<span style="color: #4d9391;">)</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">hotel domain pfb30</span>
    text = re.sub<span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">"b&amp;b"</span>, <span style="color: #cea2ca;">"bed and breakfast"</span>, text<span style="color: #4d9391;">)</span>
    text = re.sub<span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">"b and b"</span>, <span style="color: #cea2ca;">"bed and breakfast"</span>, text<span style="color: #4d9391;">)</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">normalize phone number</span>
    ms = re.findall<span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'\(?(\d{3})\)?[-.\s]?(\d{3})[-.\s]?(\d{4,5})'</span>, text<span style="color: #4d9391;">)</span>
    <span style="color: #49bdb0;">if</span> ms:
        sidx = 0
        <span style="color: #49bdb0;">for</span> m <span style="color: #49bdb0;">in</span> ms:
            sidx = text.find<span style="color: #4d9391;">(</span>m<span style="color: #47ba99;">[</span>0<span style="color: #47ba99;">]</span>, sidx<span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">if</span> text<span style="color: #4d9391;">[</span>sidx - 1<span style="color: #4d9391;">]</span> == <span style="color: #cea2ca;">'('</span>:
                sidx -= 1
            eidx = text.find<span style="color: #4d9391;">(</span>m<span style="color: #47ba99;">[</span>-1<span style="color: #47ba99;">]</span>, sidx<span style="color: #4d9391;">)</span> + <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span>m<span style="color: #47ba99;">[</span>-1<span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
            text = text.replace<span style="color: #4d9391;">(</span>text<span style="color: #47ba99;">[</span>sidx:eidx<span style="color: #47ba99;">]</span>, <span style="color: #cea2ca;">''</span>.join<span style="color: #47ba99;">(</span>m<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">normalize postcode</span>
    ms = re.findall<span style="color: #4d9391;">(</span>
        r<span style="color: #cea2ca;">'([a-z]{1}[\. ]?[a-z]{1}[\. ]?\d{1,2}[, ]+\d{1}[\. ]?[a-z]{1}[\. ]?[a-z]{1}|[a-z]{2}\d{2}[a-z]{2})'</span>,
        text<span style="color: #4d9391;">)</span>
    <span style="color: #49bdb0;">if</span> ms:
        sidx = 0
        <span style="color: #49bdb0;">for</span> m <span style="color: #49bdb0;">in</span> ms:
            sidx = text.find<span style="color: #4d9391;">(</span>m, sidx<span style="color: #4d9391;">)</span>
            eidx = sidx + <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span>m<span style="color: #4d9391;">)</span>
            text = text<span style="color: #4d9391;">[</span>:sidx<span style="color: #4d9391;">]</span> + re.sub<span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'[,\. ]'</span>, <span style="color: #cea2ca;">''</span>, m<span style="color: #4d9391;">)</span> + text<span style="color: #4d9391;">[</span>eidx:<span style="color: #4d9391;">]</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">weird unicode bug</span>
    text = re.sub<span style="color: #4d9391;">(</span>u<span style="color: #cea2ca;">"(\u2018|\u2019)"</span>, <span style="color: #cea2ca;">"'"</span>, text<span style="color: #4d9391;">)</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">replace time and and price</span>
    text = re.sub<span style="color: #4d9391;">(</span>timepat, <span style="color: #cea2ca;">' [value_time] '</span>, text<span style="color: #4d9391;">)</span>
    text = re.sub<span style="color: #4d9391;">(</span>pricepat, <span style="color: #cea2ca;">' [value_price] '</span>, text<span style="color: #4d9391;">)</span>
    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">text = re.sub(pricepat2, '[value_price]', text)</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">replace st.</span>
    text = text.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">';'</span>, <span style="color: #cea2ca;">','</span><span style="color: #4d9391;">)</span>
    text = re.sub<span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'$\/'</span>, <span style="color: #cea2ca;">''</span>, text<span style="color: #4d9391;">)</span>
    text = text.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'/'</span>, <span style="color: #cea2ca;">' and '</span><span style="color: #4d9391;">)</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">replace other special characters</span>
    text = text.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'-'</span>, <span style="color: #cea2ca;">' '</span><span style="color: #4d9391;">)</span>
    text = re.sub<span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'[\":\&lt;&gt;@\(\)]'</span>, <span style="color: #cea2ca;">''</span>, text<span style="color: #4d9391;">)</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">insert white space before and after tokens:</span>
    <span style="color: #49bdb0;">for</span> token <span style="color: #49bdb0;">in</span> <span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'?'</span>, <span style="color: #cea2ca;">'.'</span>, <span style="color: #cea2ca;">','</span>, <span style="color: #cea2ca;">'!'</span><span style="color: #4d9391;">]</span>:
        text = insertSpace<span style="color: #4d9391;">(</span>token, text<span style="color: #4d9391;">)</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">insert white space for 's</span>
    text = insertSpace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'\'s'</span>, text<span style="color: #4d9391;">)</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">replace it's, does't, you'd ... etc</span>
    text = re.sub<span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'^\''</span>, <span style="color: #cea2ca;">''</span>, text<span style="color: #4d9391;">)</span>
    text = re.sub<span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'\'$'</span>, <span style="color: #cea2ca;">''</span>, text<span style="color: #4d9391;">)</span>
    text = re.sub<span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'\'\s'</span>, <span style="color: #cea2ca;">' '</span>, text<span style="color: #4d9391;">)</span>
    text = re.sub<span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'\s\''</span>, <span style="color: #cea2ca;">' '</span>, text<span style="color: #4d9391;">)</span>
    <span style="color: #49bdb0;">for</span> fromx, tox <span style="color: #49bdb0;">in</span> replacements:
        text = <span style="color: #cea2ca;">' '</span> + text + <span style="color: #cea2ca;">' '</span>
        text = text.replace<span style="color: #4d9391;">(</span>fromx, tox<span style="color: #4d9391;">)[</span>1:-1<span style="color: #4d9391;">]</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">remove multiple spaces</span>
    text = re.sub<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">' +'</span>, <span style="color: #cea2ca;">' '</span>, text<span style="color: #4d9391;">)</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">concatenate numbers</span>
    tokens = text.split<span style="color: #4d9391;">()</span>
    i = 1
    <span style="color: #49bdb0;">while</span> i &lt; <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span>tokens<span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">if</span> re.match<span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'^\d+$'</span>, tokens<span style="color: #47ba99;">[</span>i<span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">and</span> \
                re.match<span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'\d+$'</span>, tokens<span style="color: #47ba99;">[</span>i - 1<span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>:
            tokens<span style="color: #4d9391;">[</span>i - 1<span style="color: #4d9391;">]</span> += tokens<span style="color: #4d9391;">[</span>i<span style="color: #4d9391;">]</span>
            <span style="color: #49bdb0;">del</span> tokens<span style="color: #4d9391;">[</span>i<span style="color: #4d9391;">]</span>
        <span style="color: #49bdb0;">else</span>:
            i += 1
    text = <span style="color: #cea2ca;">' '</span>.join<span style="color: #4d9391;">(</span>tokens<span style="color: #4d9391;">)</span>
    <span style="color: #49bdb0;">return</span> text


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">fix_active_domain_and_delex</span><span style="color: #4d9391;">(</span>active_domain, text, delex<span style="color: #4d9391;">)</span>:
    domains = <span style="color: #4d9391;">[</span>x.group<span style="color: #47ba99;">(</span>1<span style="color: #47ba99;">)</span>.split<span style="color: #47ba99;">(</span><span style="color: #cea2ca;">'_'</span><span style="color: #47ba99;">)[</span>0<span style="color: #47ba99;">]</span> <span style="color: #49bdb0;">for</span> x <span style="color: #49bdb0;">in</span> label_regex.finditer<span style="color: #47ba99;">(</span>delex<span style="color: #47ba99;">)</span><span style="color: #4d9391;">]</span>
    domains = <span style="color: #4d9391;">[</span>x <span style="color: #49bdb0;">for</span> x <span style="color: #49bdb0;">in</span> MW_DOMAINS <span style="color: #49bdb0;">if</span> x <span style="color: #49bdb0;">in</span> domains<span style="color: #4d9391;">]</span>
    domain_counter = Counter<span style="color: #4d9391;">(</span>domains<span style="color: #4d9391;">)</span>
    <span style="color: #49bdb0;">if</span> domain_counter:
        active_domain = domain_counter.most_common<span style="color: #4d9391;">(</span>1<span style="color: #4d9391;">)[</span>0<span style="color: #4d9391;">][</span>0<span style="color: #4d9391;">]</span>

    lresponse = text.lower<span style="color: #4d9391;">()</span>
    <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'hotel'</span> <span style="color: #49bdb0;">in</span> lresponse:
        active_domain = <span style="color: #cea2ca;">'hotel'</span>
    <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'train'</span> <span style="color: #49bdb0;">in</span> lresponse <span style="color: #49bdb0;">or</span> <span style="color: #cea2ca;">'arrive'</span> <span style="color: #49bdb0;">in</span> lresponse <span style="color: #49bdb0;">or</span> <span style="color: #cea2ca;">'leave'</span> <span style="color: #49bdb0;">in</span> lresponse:
        active_domain = <span style="color: #cea2ca;">'train'</span>
    <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'attraction'</span> <span style="color: #49bdb0;">in</span> lresponse:
        active_domain = <span style="color: #cea2ca;">'attraction'</span>
    <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'police'</span> <span style="color: #49bdb0;">in</span> lresponse:
        active_domain = <span style="color: #cea2ca;">'police'</span>
    <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'restaurant'</span> <span style="color: #49bdb0;">in</span> lresponse <span style="color: #49bdb0;">or</span> <span style="color: #cea2ca;">'food'</span> <span style="color: #49bdb0;">in</span> lresponse:
        active_domain = <span style="color: #cea2ca;">'restaurant'</span>
    <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'hospital'</span> <span style="color: #49bdb0;">in</span> lresponse:
        active_domain = <span style="color: #cea2ca;">'hospital'</span>
    <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'taxi'</span> <span style="color: #49bdb0;">in</span> lresponse <span style="color: #49bdb0;">or</span> <span style="color: #cea2ca;">'car'</span> <span style="color: #49bdb0;">in</span> lresponse:
        active_domain = <span style="color: #cea2ca;">'taxi'</span>
    taxi_brands = <span style="color: #4d9391;">[</span><span style="color: #cea2ca;">"toyota"</span>, <span style="color: #cea2ca;">"skoda"</span>, <span style="color: #cea2ca;">"bmw"</span>, <span style="color: #cea2ca;">'honda'</span>, <span style="color: #cea2ca;">'ford'</span>, <span style="color: #cea2ca;">'audi'</span>, <span style="color: #cea2ca;">'lexus'</span>, <span style="color: #cea2ca;">'volvo'</span>, <span style="color: #cea2ca;">'volkswagen'</span>, <span style="color: #cea2ca;">'tesla'</span><span style="color: #4d9391;">]</span>
    <span style="color: #49bdb0;">if</span> <span style="color: #53E6B5;">any</span><span style="color: #4d9391;">(</span>t <span style="color: #49bdb0;">in</span> lresponse <span style="color: #49bdb0;">for</span> t <span style="color: #49bdb0;">in</span> taxi_brands<span style="color: #4d9391;">)</span>:
        active_domain = <span style="color: #cea2ca;">'taxi'</span>

    <span style="color: #49bdb0;">for</span> match <span style="color: #49bdb0;">in</span> label_regex.finditer<span style="color: #4d9391;">(</span>delex<span style="color: #4d9391;">)</span>:
        domain, slot = match.group<span style="color: #4d9391;">(</span>1<span style="color: #4d9391;">)</span>.split<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'_'</span><span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">if</span> slot == <span style="color: #cea2ca;">'reference'</span>:
            active_domain = domain

    <span style="color: #49bdb0;">if</span> active_domain <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
        delex = label_regex.sub<span style="color: #4d9391;">(</span><span style="color: #49bdb0;">lambda</span> x: f<span style="color: #cea2ca;">'[</span>{active_domain}<span style="color: #cea2ca;">_</span>{x.group(1).split("_")[1]}<span style="color: #cea2ca;">]'</span>, delex<span style="color: #4d9391;">)</span>
    <span style="color: #49bdb0;">return</span> active_domain, delex


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">prepareSlotValuesIndependent</span><span style="color: #4d9391;">(</span>dbzipf, path<span style="color: #4d9391;">)</span>:
    domains = <span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'restaurant'</span>, <span style="color: #cea2ca;">'hotel'</span>, <span style="color: #cea2ca;">'attraction'</span>, <span style="color: #cea2ca;">'train'</span>, <span style="color: #cea2ca;">'taxi'</span>, <span style="color: #cea2ca;">'hospital'</span>, <span style="color: #cea2ca;">'police'</span><span style="color: #4d9391;">]</span>
    dic = <span style="color: #4d9391;">[]</span>
    dic_area = <span style="color: #4d9391;">[]</span>
    dic_food = <span style="color: #4d9391;">[]</span>
    dic_price = <span style="color: #4d9391;">[]</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">read databases</span>
    <span style="color: #49bdb0;">for</span> domain <span style="color: #49bdb0;">in</span> domains:
        <span style="color: #49bdb0;">try</span>:
            fin = dbzipf.<span style="color: #53E6B5;">open</span><span style="color: #4d9391;">(</span>os.path.join<span style="color: #47ba99;">(</span><span style="color: #cea2ca;">'db/'</span> + domain + <span style="color: #cea2ca;">'_db.json'</span><span style="color: #47ba99;">)</span>, <span style="color: #cea2ca;">'r'</span><span style="color: #4d9391;">)</span>
            db_json = json.load<span style="color: #4d9391;">(</span>fin<span style="color: #4d9391;">)</span>
            fin.close<span style="color: #4d9391;">()</span>

            <span style="color: #49bdb0;">for</span> ent <span style="color: #49bdb0;">in</span> db_json:
                <span style="color: #49bdb0;">for</span> key, val <span style="color: #49bdb0;">in</span> ent.items<span style="color: #4d9391;">()</span>:
                    <span style="color: #49bdb0;">if</span> val == <span style="color: #cea2ca;">'?'</span> <span style="color: #49bdb0;">or</span> val == <span style="color: #cea2ca;">'free'</span>:
                        <span style="color: #49bdb0;">pass</span>
                    <span style="color: #49bdb0;">elif</span> key == <span style="color: #cea2ca;">'address'</span>:
                        dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'address'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                        <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">"road"</span> <span style="color: #49bdb0;">in</span> val:
                            val = val.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"road"</span>, <span style="color: #cea2ca;">"rd"</span><span style="color: #4d9391;">)</span>
                            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'address'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                        <span style="color: #49bdb0;">elif</span> <span style="color: #cea2ca;">"rd"</span> <span style="color: #49bdb0;">in</span> val:
                            val = val.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"rd"</span>, <span style="color: #cea2ca;">"road"</span><span style="color: #4d9391;">)</span>
                            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'address'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                        <span style="color: #49bdb0;">elif</span> <span style="color: #cea2ca;">"st"</span> <span style="color: #49bdb0;">in</span> val:
                            val = val.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"st"</span>, <span style="color: #cea2ca;">"street"</span><span style="color: #4d9391;">)</span>
                            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'address'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                        <span style="color: #49bdb0;">elif</span> <span style="color: #cea2ca;">"street"</span> <span style="color: #49bdb0;">in</span> val:
                            val = val.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"street"</span>, <span style="color: #cea2ca;">"st"</span><span style="color: #4d9391;">)</span>
                            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'address'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                    <span style="color: #49bdb0;">elif</span> key == <span style="color: #cea2ca;">'name'</span>:
                        dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'name'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                        <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">"b &amp; b"</span> <span style="color: #49bdb0;">in</span> val:
                            val = val.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"b &amp; b"</span>, <span style="color: #cea2ca;">"bed and breakfast"</span><span style="color: #4d9391;">)</span>
                            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'name'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                        <span style="color: #49bdb0;">elif</span> <span style="color: #cea2ca;">"bed and breakfast"</span> <span style="color: #49bdb0;">in</span> val:
                            val = val.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"bed and breakfast"</span>, <span style="color: #cea2ca;">"b &amp; b"</span><span style="color: #4d9391;">)</span>
                            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'name'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                        <span style="color: #49bdb0;">elif</span> <span style="color: #cea2ca;">"hotel"</span> <span style="color: #49bdb0;">in</span> val <span style="color: #49bdb0;">and</span> <span style="color: #cea2ca;">'gonville'</span> <span style="color: #49bdb0;">not</span> <span style="color: #49bdb0;">in</span> val:
                            val = val.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"hotel"</span>, <span style="color: #cea2ca;">""</span><span style="color: #4d9391;">)</span>
                            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'name'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                        <span style="color: #49bdb0;">elif</span> <span style="color: #cea2ca;">"restaurant"</span> <span style="color: #49bdb0;">in</span> val:
                            val = val.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"restaurant"</span>, <span style="color: #cea2ca;">""</span><span style="color: #4d9391;">)</span>
                            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'name'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                    <span style="color: #49bdb0;">elif</span> key == <span style="color: #cea2ca;">'postcode'</span>:
                        dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'postcode'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                    <span style="color: #49bdb0;">elif</span> key == <span style="color: #cea2ca;">'phone'</span>:
                        dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>val, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'phone'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                    <span style="color: #49bdb0;">elif</span> key == <span style="color: #cea2ca;">'trainID'</span>:
                        dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'id'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                    <span style="color: #49bdb0;">elif</span> key == <span style="color: #cea2ca;">'department'</span>:
                        dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'department'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>

                    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">NORMAL DELEX</span>
                    <span style="color: #49bdb0;">elif</span> key == <span style="color: #cea2ca;">'area'</span>:
                        dic_area.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + <span style="color: #cea2ca;">'value'</span> + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'area'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                    <span style="color: #49bdb0;">elif</span> key == <span style="color: #cea2ca;">'food'</span>:
                        dic_food.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + <span style="color: #cea2ca;">'value'</span> + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'food'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                    <span style="color: #49bdb0;">elif</span> key == <span style="color: #cea2ca;">'pricerange'</span>:
                        dic_price.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + <span style="color: #cea2ca;">'value'</span> + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'pricerange'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                    <span style="color: #49bdb0;">else</span>:
                        <span style="color: #49bdb0;">pass</span>
                    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">TODO car type?</span>
        <span style="color: #49bdb0;">except</span><span style="color: #4d9391;">(</span><span style="color: #eed891;">Exception</span><span style="color: #4d9391;">)</span>:
            <span style="color: #49bdb0;">pass</span>

        <span style="color: #49bdb0;">if</span> domain == <span style="color: #cea2ca;">'hospital'</span>:
            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span><span style="color: #cea2ca;">'Hills Rd'</span><span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'address'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span><span style="color: #cea2ca;">'Hills Road'</span><span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'address'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span><span style="color: #cea2ca;">'CB20QQ'</span><span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'postcode'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span><span style="color: #cea2ca;">'01223245151'</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'phone'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span><span style="color: #cea2ca;">'1223245151'</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'phone'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span><span style="color: #cea2ca;">'0122324515'</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'phone'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span><span style="color: #cea2ca;">'Addenbrookes Hospital'</span><span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'name'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>

        <span style="color: #49bdb0;">elif</span> domain == <span style="color: #cea2ca;">'police'</span>:
            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span><span style="color: #cea2ca;">'Parkside'</span><span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'address'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span><span style="color: #cea2ca;">'CB11JG'</span><span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'postcode'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span><span style="color: #cea2ca;">'01223358966'</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'phone'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span><span style="color: #cea2ca;">'1223358966'</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'phone'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
            dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span><span style="color: #cea2ca;">'Parkside Police Station'</span><span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'name'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">add at the end places from trains</span>
    fin = dbzipf.<span style="color: #53E6B5;">open</span><span style="color: #4d9391;">(</span>os.path.join<span style="color: #47ba99;">(</span><span style="color: #cea2ca;">'db/'</span> + <span style="color: #cea2ca;">'train'</span> + <span style="color: #cea2ca;">'_db.json'</span><span style="color: #47ba99;">)</span>, <span style="color: #cea2ca;">'r'</span><span style="color: #4d9391;">)</span>
    db_json = json.load<span style="color: #4d9391;">(</span>fin<span style="color: #4d9391;">)</span>
    fin.close<span style="color: #4d9391;">()</span>

    <span style="color: #49bdb0;">for</span> ent <span style="color: #49bdb0;">in</span> db_json:
        <span style="color: #49bdb0;">for</span> key, val <span style="color: #49bdb0;">in</span> ent.items<span style="color: #4d9391;">()</span>:
            <span style="color: #49bdb0;">if</span> key == <span style="color: #cea2ca;">'departure'</span> <span style="color: #49bdb0;">or</span> key == <span style="color: #cea2ca;">'destination'</span>:
                dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + <span style="color: #cea2ca;">'value'</span> + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'place'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">add specific values:</span>
    <span style="color: #49bdb0;">for</span> key <span style="color: #49bdb0;">in</span> <span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'monday'</span>, <span style="color: #cea2ca;">'tuesday'</span>, <span style="color: #cea2ca;">'wednesday'</span>, <span style="color: #cea2ca;">'thursday'</span>, <span style="color: #cea2ca;">'friday'</span>, <span style="color: #cea2ca;">'saturday'</span>, <span style="color: #cea2ca;">'sunday'</span><span style="color: #4d9391;">]</span>:
        dic.append<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>normalize<span style="color: #9d81ba;">(</span>key<span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'['</span> + <span style="color: #cea2ca;">'value'</span> + <span style="color: #cea2ca;">'_'</span> + <span style="color: #cea2ca;">'day'</span> + <span style="color: #cea2ca;">']'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">more general values add at the end</span>
    dic.extend<span style="color: #4d9391;">(</span>dic_area<span style="color: #4d9391;">)</span>
    dic.extend<span style="color: #4d9391;">(</span>dic_food<span style="color: #4d9391;">)</span>
    dic.extend<span style="color: #4d9391;">(</span>dic_price<span style="color: #4d9391;">)</span>

    <span style="color: #49bdb0;">return</span> dic


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">delexicalise</span><span style="color: #4d9391;">(</span>utt, dictionary<span style="color: #4d9391;">)</span>:
    <span style="color: #49bdb0;">for</span> key, val <span style="color: #49bdb0;">in</span> dictionary:
        utt = <span style="color: #4d9391;">(</span><span style="color: #cea2ca;">' '</span> + utt + <span style="color: #cea2ca;">' '</span><span style="color: #4d9391;">)</span>.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">' '</span> + key + <span style="color: #cea2ca;">' '</span>, <span style="color: #cea2ca;">' '</span> + val + <span style="color: #cea2ca;">' '</span><span style="color: #4d9391;">)</span>
        utt = utt<span style="color: #4d9391;">[</span>1:-1<span style="color: #4d9391;">]</span>  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">why this?</span>

    <span style="color: #49bdb0;">return</span> utt


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">delexicaliseDomain</span><span style="color: #4d9391;">(</span>utt, dictionary, domain<span style="color: #4d9391;">)</span>:
    <span style="color: #49bdb0;">for</span> key, val <span style="color: #49bdb0;">in</span> dictionary:
        <span style="color: #49bdb0;">if</span> key == domain <span style="color: #49bdb0;">or</span> key == <span style="color: #cea2ca;">'value'</span>:
            utt = <span style="color: #4d9391;">(</span><span style="color: #cea2ca;">' '</span> + utt + <span style="color: #cea2ca;">' '</span><span style="color: #4d9391;">)</span>.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">' '</span> + key + <span style="color: #cea2ca;">' '</span>, <span style="color: #cea2ca;">' '</span> + val + <span style="color: #cea2ca;">' '</span><span style="color: #4d9391;">)</span>
            utt = utt<span style="color: #4d9391;">[</span>1:-1<span style="color: #4d9391;">]</span>  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">why this?</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">go through rest of domain in case we are missing something out?</span>
    <span style="color: #49bdb0;">for</span> key, val <span style="color: #49bdb0;">in</span> dictionary:
        utt = <span style="color: #4d9391;">(</span><span style="color: #cea2ca;">' '</span> + utt + <span style="color: #cea2ca;">' '</span><span style="color: #4d9391;">)</span>.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">' '</span> + key + <span style="color: #cea2ca;">' '</span>, <span style="color: #cea2ca;">' '</span> + val + <span style="color: #cea2ca;">' '</span><span style="color: #4d9391;">)</span>
        utt = utt<span style="color: #4d9391;">[</span>1:-1<span style="color: #4d9391;">]</span>  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">why this?</span>
    <span style="color: #49bdb0;">return</span> utt


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">is_ascii</span><span style="color: #4d9391;">(</span>s<span style="color: #4d9391;">)</span>:
    <span style="color: #49bdb0;">return</span> <span style="color: #53E6B5;">all</span><span style="color: #4d9391;">(</span><span style="color: #53E6B5;">ord</span><span style="color: #47ba99;">(</span>c<span style="color: #47ba99;">)</span> &lt; 128 <span style="color: #49bdb0;">for</span> c <span style="color: #49bdb0;">in</span> s<span style="color: #4d9391;">)</span>


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">domain_not_empty</span><span style="color: #4d9391;">(</span>domain_bs<span style="color: #4d9391;">)</span>:
    <span style="color: #49bdb0;">return</span> <span style="color: #53E6B5;">any</span><span style="color: #4d9391;">(</span><span style="color: #53E6B5;">len</span><span style="color: #47ba99;">(</span>val<span style="color: #47ba99;">)</span> &gt; 0 <span style="color: #49bdb0;">and</span> val <span style="color: #49bdb0;">not</span> <span style="color: #49bdb0;">in</span> DEFAULT_IGNORE_VALUES <span style="color: #49bdb0;">for</span> val <span style="color: #49bdb0;">in</span> domain_bs.values<span style="color: #47ba99;">()</span><span style="color: #4d9391;">)</span>


<span style="color: #49bdb0;">class</span> <span style="color: #eed891;">BeliefStateTransformation</span>:
    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">_process_domain</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, domain_bs<span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">return</span> <span style="color: #4d9391;">{</span><span style="color: #49bdb0;">self</span>._map_slot<span style="color: #47ba99;">(</span>slot<span style="color: #47ba99;">)</span>: <span style="color: #49bdb0;">self</span>._clear_value<span style="color: #47ba99;">(</span>val<span style="color: #47ba99;">)</span> <span style="color: #49bdb0;">for</span> slot, val <span style="color: #49bdb0;">in</span> domain_bs.items<span style="color: #47ba99;">()</span>
                <span style="color: #49bdb0;">if</span> <span style="color: #47ba99;">(</span><span style="color: #53E6B5;">len</span><span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span> &gt; 0 <span style="color: #49bdb0;">and</span> val <span style="color: #49bdb0;">not</span> <span style="color: #49bdb0;">in</span> DEFAULT_IGNORE_VALUES<span style="color: #47ba99;">)</span><span style="color: #4d9391;">}</span>

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">_map_slot</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, slot<span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">if</span> slot == <span style="color: #cea2ca;">'arriveBy'</span>:
            <span style="color: #49bdb0;">return</span> <span style="color: #cea2ca;">'arrive by'</span>
        <span style="color: #49bdb0;">if</span> slot == <span style="color: #cea2ca;">'leaveAt'</span>:
            <span style="color: #49bdb0;">return</span> <span style="color: #cea2ca;">'leave at'</span>
        <span style="color: #49bdb0;">if</span> slot == <span style="color: #cea2ca;">'pricerange'</span>:
            slot = <span style="color: #cea2ca;">'price range'</span>
        <span style="color: #49bdb0;">return</span> slot

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">_clear_value</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, value<span style="color: #4d9391;">)</span>:
        value = value.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'&gt;'</span>, <span style="color: #cea2ca;">' '</span><span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">if</span> value == <span style="color: #cea2ca;">'el shaddia guesthouse'</span>:
            value = <span style="color: #cea2ca;">'el shaddai'</span>
        <span style="color: #49bdb0;">if</span> value == <span style="color: #cea2ca;">'concerthall'</span>:
            value = <span style="color: #cea2ca;">'concert hall'</span>
        <span style="color: #49bdb0;">if</span> value == <span style="color: #cea2ca;">'nightclub'</span>:
            value = <span style="color: #cea2ca;">'night club'</span>
        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">BUG in MW2.0</span>
        value = value.lstrip<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'`'</span><span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">return</span> value

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__call__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, belief_state, dialogue_act, active_domain<span style="color: #4d9391;">)</span>:
        clean_belief = <span style="color: #53E6B5;">dict</span><span style="color: #4d9391;">()</span>
        <span style="color: #49bdb0;">for</span> domain, domain_bs <span style="color: #49bdb0;">in</span> belief_state.items<span style="color: #4d9391;">()</span>:
            new_domain_bs = <span style="color: #4d9391;">{}</span>
            <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'semi'</span> <span style="color: #49bdb0;">in</span> domain_bs:
                new_domain_bs.update<span style="color: #4d9391;">(</span>domain_bs<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'semi'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'book'</span> <span style="color: #49bdb0;">in</span> domain_bs:
                new_domain_bs.update<span style="color: #4d9391;">(</span><span style="color: #47ba99;">{</span>k: v <span style="color: #49bdb0;">for</span> k, v <span style="color: #49bdb0;">in</span> domain_bs<span style="color: #9d81ba;">[</span><span style="color: #cea2ca;">'book'</span><span style="color: #9d81ba;">]</span>.items<span style="color: #9d81ba;">()</span> <span style="color: #49bdb0;">if</span> k != <span style="color: #cea2ca;">'booked'</span><span style="color: #47ba99;">}</span><span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'book'</span> <span style="color: #49bdb0;">in</span> domain_bs <span style="color: #49bdb0;">and</span> <span style="color: #cea2ca;">'booked'</span> <span style="color: #49bdb0;">in</span> domain_bs<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'book'</span><span style="color: #4d9391;">]</span> <span style="color: #49bdb0;">and</span> <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span>domain_bs<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'book'</span><span style="color: #47ba99;">][</span><span style="color: #cea2ca;">'booked'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span> &gt; 0:
                new_domain_bs<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'booked'</span><span style="color: #4d9391;">]</span> = <span style="color: #cea2ca;">'true'</span>
            <span style="color: #49bdb0;">elif</span> <span style="color: #49bdb0;">not</span> domain_not_empty<span style="color: #4d9391;">(</span>domain_bs<span style="color: #4d9391;">)</span>:
                <span style="color: #49bdb0;">continue</span>
            new_domain_bs = <span style="color: #49bdb0;">self</span>._process_domain<span style="color: #4d9391;">(</span>new_domain_bs<span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">if</span> <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span>new_domain_bs<span style="color: #4d9391;">)</span> == 0:
                <span style="color: #49bdb0;">continue</span>
            <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'internet'</span> <span style="color: #49bdb0;">in</span> new_domain_bs <span style="color: #49bdb0;">and</span> new_domain_bs<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'internet'</span><span style="color: #4d9391;">]</span> == <span style="color: #cea2ca;">'no'</span>:
                <span style="color: #49bdb0;">del</span> new_domain_bs<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'internet'</span><span style="color: #4d9391;">]</span>  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">no internet by default</span>
            <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'parking'</span> <span style="color: #49bdb0;">in</span> new_domain_bs <span style="color: #49bdb0;">and</span> new_domain_bs<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'parking'</span><span style="color: #4d9391;">]</span> == <span style="color: #cea2ca;">'no'</span>:
                <span style="color: #49bdb0;">del</span> new_domain_bs<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'parking'</span><span style="color: #4d9391;">]</span>  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">no parking by default</span>
            clean_belief<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">]</span> = new_domain_bs

        <span style="color: #49bdb0;">for</span> domain <span style="color: #49bdb0;">in</span> <span style="color: #4d9391;">{</span><span style="color: #cea2ca;">'Hospital'</span>, <span style="color: #cea2ca;">'Police'</span><span style="color: #4d9391;">}</span>:
            <span style="color: #49bdb0;">if</span> <span style="color: #53E6B5;">any</span><span style="color: #4d9391;">(</span><span style="color: #47ba99;">[</span>da<span style="color: #9d81ba;">[</span>1<span style="color: #9d81ba;">]</span> == domain <span style="color: #49bdb0;">for</span> da <span style="color: #49bdb0;">in</span> dialogue_act<span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>:
                clean_belief<span style="color: #4d9391;">[</span>domain.lower<span style="color: #47ba99;">()</span><span style="color: #4d9391;">]</span> = <span style="color: #4d9391;">{}</span>

        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Sort belief</span>
        clean_belief = <span style="color: #4d9391;">{</span>k: OrderedDict<span style="color: #47ba99;">(</span><span style="color: #53E6B5;">sorted</span><span style="color: #9d81ba;">(</span>v.items(), key=<span style="color: #49bdb0;">lambda</span> x: x[0]<span style="color: #9d81ba;">)</span><span style="color: #47ba99;">)</span> <span style="color: #49bdb0;">for</span> k, v <span style="color: #49bdb0;">in</span> clean_belief.items<span style="color: #47ba99;">()</span><span style="color: #4d9391;">}</span>
        active_bs = <span style="color: #ef6787;">None</span>
        <span style="color: #49bdb0;">if</span> active_domain <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
            active_domain = active_domain.lower<span style="color: #4d9391;">()</span>
            active_bs = clean_belief.pop<span style="color: #4d9391;">(</span>active_domain, <span style="color: #ef6787;">None</span><span style="color: #4d9391;">)</span>
        items = <span style="color: #4d9391;">[</span><span style="color: #47ba99;">(</span>active_domain, active_bs<span style="color: #47ba99;">)</span><span style="color: #4d9391;">]</span> <span style="color: #49bdb0;">if</span> active_bs <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span> <span style="color: #49bdb0;">else</span> <span style="color: #4d9391;">[]</span>
        items += <span style="color: #4d9391;">[</span><span style="color: #47ba99;">(</span>k, v<span style="color: #47ba99;">)</span> <span style="color: #49bdb0;">for</span> k, v <span style="color: #49bdb0;">in</span> <span style="color: #53E6B5;">sorted</span><span style="color: #47ba99;">(</span>clean_belief.items<span style="color: #9d81ba;">()</span>, key=<span style="color: #49bdb0;">lambda</span> x: x<span style="color: #9d81ba;">[</span>0<span style="color: #9d81ba;">]</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">]</span>
        result = OrderedDict<span style="color: #4d9391;">(</span>items<span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">return</span> result


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">fixDelex</span><span style="color: #4d9391;">(</span>delex, act<span style="color: #4d9391;">)</span>:
    <span style="color: #49bdb0;">for</span> k <span style="color: #49bdb0;">in</span> act:
        <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'Attraction'</span> == k<span style="color: #4d9391;">[</span>1<span style="color: #4d9391;">]</span>:
            <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'restaurant_'</span> <span style="color: #49bdb0;">in</span> delex:
                delex = delex.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"restaurant"</span>, <span style="color: #cea2ca;">"attraction"</span><span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'hotel_'</span> <span style="color: #49bdb0;">in</span> delex:
                delex = delex.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"hotel"</span>, <span style="color: #cea2ca;">"attraction"</span><span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'Hotel'</span> == k<span style="color: #4d9391;">[</span>1<span style="color: #4d9391;">]</span>:
            <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'attraction_'</span> <span style="color: #49bdb0;">in</span> delex:
                delex = delex.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"attraction"</span>, <span style="color: #cea2ca;">"hotel"</span><span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'restaurant_'</span> <span style="color: #49bdb0;">in</span> delex:
                delex = delex.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"restaurant"</span>, <span style="color: #cea2ca;">"hotel"</span><span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'Restaurant'</span> == k<span style="color: #4d9391;">[</span>1<span style="color: #4d9391;">]</span>:
            <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'attraction_'</span> <span style="color: #49bdb0;">in</span> delex:
                delex = delex.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"attraction"</span>, <span style="color: #cea2ca;">"restaurant"</span><span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'hotel_'</span> <span style="color: #49bdb0;">in</span> delex:
                delex = delex.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"hotel"</span>, <span style="color: #cea2ca;">"restaurant"</span><span style="color: #4d9391;">)</span>

    <span style="color: #49bdb0;">return</span> delex


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">delexicaliseReferenceNumber</span><span style="color: #4d9391;">(</span>sent, turn<span style="color: #4d9391;">)</span>:
    <span style="color: #a9779c;">"""Based on the belief state, we can find reference number that</span>
<span style="color: #a9779c;">    during data gathering was created randomly."""</span>
    domains = <span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'restaurant'</span>, <span style="color: #cea2ca;">'hotel'</span>, <span style="color: #cea2ca;">'attraction'</span>, <span style="color: #cea2ca;">'train'</span>, <span style="color: #cea2ca;">'taxi'</span>, <span style="color: #cea2ca;">'hospital'</span><span style="color: #4d9391;">]</span>  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">, 'police']</span>
    <span style="color: #49bdb0;">if</span> turn<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'metadata'</span><span style="color: #4d9391;">]</span>:
        <span style="color: #49bdb0;">for</span> domain <span style="color: #49bdb0;">in</span> domains:
            <span style="color: #49bdb0;">if</span> turn<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'metadata'</span><span style="color: #4d9391;">][</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'book'</span><span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'booked'</span><span style="color: #4d9391;">]</span>:
                <span style="color: #49bdb0;">for</span> slot <span style="color: #49bdb0;">in</span> turn<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'metadata'</span><span style="color: #4d9391;">][</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'book'</span><span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'booked'</span><span style="color: #4d9391;">][</span>0<span style="color: #4d9391;">]</span>:
                    <span style="color: #49bdb0;">if</span> slot == <span style="color: #cea2ca;">'reference'</span>:
                        val = <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + slot + <span style="color: #cea2ca;">']'</span>
                    <span style="color: #49bdb0;">else</span>:
                        val = <span style="color: #cea2ca;">'['</span> + domain + <span style="color: #cea2ca;">'_'</span> + slot + <span style="color: #cea2ca;">']'</span>
                    key = normalize<span style="color: #4d9391;">(</span>turn<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'metadata'</span><span style="color: #47ba99;">][</span>domain<span style="color: #47ba99;">][</span><span style="color: #cea2ca;">'book'</span><span style="color: #47ba99;">][</span><span style="color: #cea2ca;">'booked'</span><span style="color: #47ba99;">][</span>0<span style="color: #47ba99;">][</span>slot<span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
                    sent = <span style="color: #4d9391;">(</span><span style="color: #cea2ca;">' '</span> + sent + <span style="color: #cea2ca;">' '</span><span style="color: #4d9391;">)</span>.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">' '</span> + key + <span style="color: #cea2ca;">' '</span>, <span style="color: #cea2ca;">' '</span> + val + <span style="color: #cea2ca;">' '</span><span style="color: #4d9391;">)</span>

                    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">try reference with hashtag</span>
                    key = normalize<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"#"</span> + turn<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'metadata'</span><span style="color: #47ba99;">][</span>domain<span style="color: #47ba99;">][</span><span style="color: #cea2ca;">'book'</span><span style="color: #47ba99;">][</span><span style="color: #cea2ca;">'booked'</span><span style="color: #47ba99;">][</span>0<span style="color: #47ba99;">][</span>slot<span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
                    sent = <span style="color: #4d9391;">(</span><span style="color: #cea2ca;">' '</span> + sent + <span style="color: #cea2ca;">' '</span><span style="color: #4d9391;">)</span>.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">' '</span> + key + <span style="color: #cea2ca;">' '</span>, <span style="color: #cea2ca;">' '</span> + val + <span style="color: #cea2ca;">' '</span><span style="color: #4d9391;">)</span>

                    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">try reference with ref#</span>
                    key = normalize<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"ref#"</span> + turn<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'metadata'</span><span style="color: #47ba99;">][</span>domain<span style="color: #47ba99;">][</span><span style="color: #cea2ca;">'book'</span><span style="color: #47ba99;">][</span><span style="color: #cea2ca;">'booked'</span><span style="color: #47ba99;">][</span>0<span style="color: #47ba99;">][</span>slot<span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
                    sent = <span style="color: #4d9391;">(</span><span style="color: #cea2ca;">' '</span> + sent + <span style="color: #cea2ca;">' '</span><span style="color: #4d9391;">)</span>.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">' '</span> + key + <span style="color: #cea2ca;">' '</span>, <span style="color: #cea2ca;">' '</span> + val + <span style="color: #cea2ca;">' '</span><span style="color: #4d9391;">)</span>
    <span style="color: #49bdb0;">return</span> sent


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">analyze_dialogue</span><span style="color: #4d9391;">(</span>dialogue, maxlen<span style="color: #4d9391;">)</span>:
    <span style="color: #a9779c;">"""Cleaning procedure for all kinds of errors in text and annotation."""</span>
    d = dialogue
    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">do all the necessary postprocessing</span>
    <span style="color: #49bdb0;">if</span> <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span>d<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span> % 2 != 0:
        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">print path</span>
        logger.warning<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'odd # of turns'</span><span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">return</span> <span style="color: #ef6787;">None</span>  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">odd number of turns, wrong dialogue</span>

    <span style="color: #49bdb0;">for</span> i <span style="color: #49bdb0;">in</span> <span style="color: #53E6B5;">range</span><span style="color: #4d9391;">(</span><span style="color: #53E6B5;">len</span><span style="color: #47ba99;">(</span>d<span style="color: #9d81ba;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #9d81ba;">]</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">if</span> <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span>d<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #47ba99;">][</span>i<span style="color: #47ba99;">][</span><span style="color: #cea2ca;">'text'</span><span style="color: #47ba99;">]</span>.split<span style="color: #47ba99;">()</span><span style="color: #4d9391;">)</span> &gt; maxlen:
            logger.warning<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'too long'</span><span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">return</span> <span style="color: #ef6787;">None</span>  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">too long sentence, wrong dialogue</span>
        <span style="color: #49bdb0;">if</span> i % 2 == 0:  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">usr turn</span>
            text = d<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #4d9391;">][</span>i<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'text'</span><span style="color: #4d9391;">]</span>
            <span style="color: #49bdb0;">if</span> <span style="color: #49bdb0;">not</span> is_ascii<span style="color: #4d9391;">(</span>text<span style="color: #4d9391;">)</span>:
                logger.warning<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'not ascii'</span><span style="color: #4d9391;">)</span>
                <span style="color: #49bdb0;">return</span> <span style="color: #ef6787;">None</span>
        <span style="color: #49bdb0;">else</span>:  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">sys turn</span>
            <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'database'</span> <span style="color: #49bdb0;">not</span> <span style="color: #49bdb0;">in</span> d<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #4d9391;">][</span>i<span style="color: #4d9391;">]</span>:
                logger.warning<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'no db'</span><span style="color: #4d9391;">)</span>
                <span style="color: #49bdb0;">return</span> <span style="color: #ef6787;">None</span>  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">no db_pointer, probably 2 usr turns in a row, wrong dialogue</span>
            text = d<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #4d9391;">][</span>i<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'text'</span><span style="color: #4d9391;">]</span>
            <span style="color: #49bdb0;">if</span> <span style="color: #49bdb0;">not</span> is_ascii<span style="color: #4d9391;">(</span>text<span style="color: #4d9391;">)</span>:
                logger.warning<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'not ascii'</span><span style="color: #4d9391;">)</span>
                <span style="color: #49bdb0;">return</span> <span style="color: #ef6787;">None</span>
        d<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #4d9391;">][</span>i<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'text'</span><span style="color: #4d9391;">]</span> = clear_whitespaces<span style="color: #4d9391;">(</span>d<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #47ba99;">][</span>i<span style="color: #47ba99;">][</span><span style="color: #cea2ca;">'text'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
    <span style="color: #49bdb0;">return</span> dialogue


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">get_dial</span><span style="color: #4d9391;">(</span>dialogue<span style="color: #4d9391;">)</span>:
    d_orig = analyze_dialogue<span style="color: #4d9391;">(</span>dialogue, MAX_LENGTH<span style="color: #4d9391;">)</span>  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">max turn len is 50 words</span>
    <span style="color: #49bdb0;">if</span> d_orig <span style="color: #49bdb0;">is</span> <span style="color: #ef6787;">None</span>:
        <span style="color: #49bdb0;">return</span> <span style="color: #ef6787;">None</span>
    <span style="color: #49bdb0;">return</span> d_orig


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">createDict</span><span style="color: #4d9391;">(</span>word_freqs<span style="color: #4d9391;">)</span>:
    words = <span style="color: #53E6B5;">list</span><span style="color: #4d9391;">(</span>word_freqs.keys<span style="color: #47ba99;">()</span><span style="color: #4d9391;">)</span>
    freqs = <span style="color: #53E6B5;">list</span><span style="color: #4d9391;">(</span>word_freqs.values<span style="color: #47ba99;">()</span><span style="color: #4d9391;">)</span>

    sorted_idx = np.argsort<span style="color: #4d9391;">(</span>freqs<span style="color: #4d9391;">)</span>
    sorted_words = <span style="color: #4d9391;">[</span>words<span style="color: #47ba99;">[</span>ii<span style="color: #47ba99;">]</span> <span style="color: #49bdb0;">for</span> ii <span style="color: #49bdb0;">in</span> sorted_idx<span style="color: #47ba99;">[</span>::-1<span style="color: #47ba99;">]</span><span style="color: #4d9391;">]</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Extra vocabulary symbols</span>
    _GO = <span style="color: #cea2ca;">'_GO'</span>
    EOS = <span style="color: #cea2ca;">'_EOS'</span>
    UNK = <span style="color: #cea2ca;">'_UNK'</span>
    PAD = <span style="color: #cea2ca;">'_PAD'</span>
    extra_tokens = <span style="color: #4d9391;">[</span>_GO, EOS, UNK, PAD<span style="color: #4d9391;">]</span>

    worddict = OrderedDict<span style="color: #4d9391;">()</span>
    <span style="color: #49bdb0;">for</span> ii, ww <span style="color: #49bdb0;">in</span> <span style="color: #53E6B5;">enumerate</span><span style="color: #4d9391;">(</span>extra_tokens<span style="color: #4d9391;">)</span>:
        worddict<span style="color: #4d9391;">[</span>ww<span style="color: #4d9391;">]</span> = ii
    <span style="color: #49bdb0;">for</span> ii, ww <span style="color: #49bdb0;">in</span> <span style="color: #53E6B5;">enumerate</span><span style="color: #4d9391;">(</span>sorted_words<span style="color: #4d9391;">)</span>:
        worddict<span style="color: #4d9391;">[</span>ww<span style="color: #4d9391;">]</span> = ii + <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span>extra_tokens<span style="color: #4d9391;">)</span>

    <span style="color: #49bdb0;">for</span> key, idx <span style="color: #49bdb0;">in</span> <span style="color: #53E6B5;">list</span><span style="color: #4d9391;">(</span>worddict.items<span style="color: #47ba99;">()</span><span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">if</span> idx &gt;= DICT_SIZE:
            <span style="color: #49bdb0;">del</span> worddict<span style="color: #4d9391;">[</span>key<span style="color: #4d9391;">]</span>

    <span style="color: #49bdb0;">return</span> worddict


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">createDelexData</span><span style="color: #4d9391;">(</span>zipf, path<span style="color: #4d9391;">)</span>:
    <span style="color: #a9779c;">"""Main function of the script - loads delexical dictionary,</span>
<span style="color: #a9779c;">    goes through each dialogue and does:</span>
<span style="color: #a9779c;">    1) data normalization</span>
<span style="color: #a9779c;">    2) delexicalization</span>
<span style="color: #a9779c;">    3) addition of database pointer</span>
<span style="color: #a9779c;">    4) saves the delexicalised data</span>
<span style="color: #a9779c;">    """</span>
    transform_belief = BeliefStateTransformation<span style="color: #4d9391;">()</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Load databases</span>
    <span style="color: #49bdb0;">with</span> zipfile.ZipFile<span style="color: #4d9391;">(</span>os.path.join<span style="color: #47ba99;">(</span>path, <span style="color: #cea2ca;">'database.zip'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">as</span> dbzipf:
        db = Database<span style="color: #4d9391;">(</span>dbzipf<span style="color: #4d9391;">)</span>

        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">create dictionary of delexicalied values that then we will search against, order matters here!</span>
        dic = prepareSlotValuesIndependent<span style="color: #4d9391;">(</span>dbzipf, path<span style="color: #4d9391;">)</span>
    delex_data = OrderedDict<span style="color: #4d9391;">()</span>
    <span style="color: #49bdb0;">with</span> zipfile.ZipFile<span style="color: #4d9391;">(</span>os.path.join<span style="color: #47ba99;">(</span>path, <span style="color: #cea2ca;">'lexicalizer.zip'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">as</span> lexzipf:
        lexicalizer = Lexicalizer<span style="color: #4d9391;">(</span>lexzipf<span style="color: #4d9391;">)</span>

    root = <span style="color: #53E6B5;">next</span><span style="color: #4d9391;">(</span><span style="color: #53E6B5;">iter</span><span style="color: #47ba99;">(</span><span style="color: #9d81ba;">{</span>n.strip(<span style="color: #cea2ca;">'data.json'</span>) <span style="color: #49bdb0;">for</span> n <span style="color: #49bdb0;">in</span> zipf.namelist() <span style="color: #49bdb0;">if</span> n.endswith(<span style="color: #cea2ca;">'data.json'</span>)<span style="color: #9d81ba;">}</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
    fin1 = zipf.<span style="color: #53E6B5;">open</span><span style="color: #4d9391;">(</span>root + <span style="color: #cea2ca;">'data.json'</span>, <span style="color: #cea2ca;">'r'</span><span style="color: #4d9391;">)</span>
    data = json.load<span style="color: #4d9391;">(</span>fin1<span style="color: #4d9391;">)</span>

    fin2 = zipf.<span style="color: #53E6B5;">open</span><span style="color: #4d9391;">(</span>root + <span style="color: #cea2ca;">'dialogue_acts.json'</span>, <span style="color: #cea2ca;">'r'</span><span style="color: #4d9391;">)</span>
    data2 = json.load<span style="color: #4d9391;">(</span>fin2<span style="color: #4d9391;">)</span>
    ignored_dialogues = 0

    <span style="color: #49bdb0;">for</span> dialogue_name <span style="color: #49bdb0;">in</span> tqdm<span style="color: #4d9391;">(</span>data<span style="color: #4d9391;">)</span>:
        dialogue = data<span style="color: #4d9391;">[</span>dialogue_name<span style="color: #4d9391;">]</span>
        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">print dialogue_name</span>

        idx_acts = 1
        active_domain = <span style="color: #ef6787;">None</span>
        ignore_dialogue = <span style="color: #ef6787;">False</span>

        <span style="color: #49bdb0;">for</span> idx, turn <span style="color: #49bdb0;">in</span> <span style="color: #53E6B5;">enumerate</span><span style="color: #4d9391;">(</span>dialogue<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>:
            <span style="color: #49bdb0;">try</span>:
                dialogue_act = <span style="color: #4d9391;">[</span><span style="color: #53E6B5;">tuple</span><span style="color: #47ba99;">(</span><span style="color: #53E6B5;">reversed</span><span style="color: #9d81ba;">(</span>f.split(<span style="color: #cea2ca;">'-'</span>)<span style="color: #9d81ba;">)</span><span style="color: #47ba99;">)</span> + <span style="color: #53E6B5;">tuple</span><span style="color: #47ba99;">(</span>x<span style="color: #47ba99;">)</span>
                                <span style="color: #49bdb0;">for</span> f, xs <span style="color: #49bdb0;">in</span> data2<span style="color: #47ba99;">[</span>dialogue_name.strip<span style="color: #9d81ba;">(</span><span style="color: #cea2ca;">'.json'</span><span style="color: #9d81ba;">)</span><span style="color: #47ba99;">][</span><span style="color: #53E6B5;">str</span><span style="color: #9d81ba;">(</span>idx_acts<span style="color: #9d81ba;">)</span><span style="color: #47ba99;">]</span>.items<span style="color: #47ba99;">()</span> <span style="color: #49bdb0;">for</span> x <span style="color: #49bdb0;">in</span> xs<span style="color: #4d9391;">]</span>
            <span style="color: #49bdb0;">except</span><span style="color: #4d9391;">(</span><span style="color: #eed891;">Exception</span><span style="color: #4d9391;">)</span>:
                dialogue_act = <span style="color: #4d9391;">[]</span>
            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">normalization, split and delexicalization of the sentence</span>
            sent = normalize<span style="color: #4d9391;">(</span>turn<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'text'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
            text = sent

            words = sent.split<span style="color: #4d9391;">()</span>
            sent = delexicalise<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">' '</span>.join<span style="color: #47ba99;">(</span>words<span style="color: #47ba99;">)</span>, dic<span style="color: #4d9391;">)</span>

            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">parsing reference number GIVEN belief state</span>
            sent = delexicaliseReferenceNumber<span style="color: #4d9391;">(</span>sent, turn<span style="color: #4d9391;">)</span>

            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">changes to numbers only here</span>
            digitpat = re.<span style="color: #53E6B5;">compile</span><span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'\d+'</span><span style="color: #4d9391;">)</span>
            sent = re.sub<span style="color: #4d9391;">(</span>digitpat, <span style="color: #cea2ca;">'[value_count]'</span>, sent<span style="color: #4d9391;">)</span>

            dialogue<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #4d9391;">][</span>idx<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'dialogue_act'</span><span style="color: #4d9391;">]</span> = dialogue_act
            dialogue<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #4d9391;">][</span>idx<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'speaker'</span><span style="color: #4d9391;">]</span> = <span style="color: #cea2ca;">'user'</span>

            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">delexicalised sentence added to the dialogue</span>
            delex = sent.strip<span style="color: #4d9391;">()</span>
            delex = fixDelex<span style="color: #4d9391;">(</span>delex, dialogue_act<span style="color: #4d9391;">)</span>

            <span style="color: #49bdb0;">if</span> idx % 2 == 1:  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">if it's a system turn</span>
                dialogue<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #4d9391;">][</span>idx<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'speaker'</span><span style="color: #4d9391;">]</span> = <span style="color: #cea2ca;">'system'</span>
                belief = dialogue<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #4d9391;">][</span>idx<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'metadata'</span><span style="color: #4d9391;">]</span>
                active_domain, delex = fix_active_domain_and_delex<span style="color: #4d9391;">(</span>active_domain, text, delex<span style="color: #4d9391;">)</span>
                dialogue<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #4d9391;">][</span>idx<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'active_domain'</span><span style="color: #4d9391;">]</span> = active_domain

                belief = transform_belief<span style="color: #4d9391;">(</span>belief, dialogue_act, active_domain<span style="color: #4d9391;">)</span>
                dialogue<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #4d9391;">][</span>idx<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'belief'</span><span style="color: #4d9391;">]</span> = belief
                <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'bus'</span> <span style="color: #49bdb0;">in</span> belief:
                    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">We need to ignore this dialogue</span>
                    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">There is no data for the bus domain</span>
                    ignore_dialogue = <span style="color: #ef6787;">True</span>
                    <span style="color: #49bdb0;">break</span>

                dialogue<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #4d9391;">][</span>idx<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'database'</span><span style="color: #4d9391;">]</span> = db<span style="color: #4d9391;">(</span>belief<span style="color: #4d9391;">)</span>

                <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Add booked property</span>
                dialogue<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #4d9391;">][</span>idx<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'booked_domains'</span><span style="color: #4d9391;">]</span> = <span style="color: #53E6B5;">sorted</span><span style="color: #4d9391;">(</span>get_booked_domains<span style="color: #47ba99;">(</span>dialogue<span style="color: #9d81ba;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #9d81ba;">][</span>idx<span style="color: #9d81ba;">][</span><span style="color: #cea2ca;">'metadata'</span><span style="color: #9d81ba;">]</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>

                <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Test if lexicalizer works</span>
                lexicalizer<span style="color: #4d9391;">(</span>delex, db<span style="color: #47ba99;">(</span>belief, return_results=<span style="color: #ef6787;">True</span><span style="color: #47ba99;">)</span>, belief<span style="color: #4d9391;">)</span>

            dialogue<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #4d9391;">][</span>idx<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'delexicalised_text'</span><span style="color: #4d9391;">]</span> = delex

            idx_acts += 1

        <span style="color: #49bdb0;">if</span> <span style="color: #49bdb0;">not</span> ignore_dialogue:
            dialogue<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'goal'</span><span style="color: #4d9391;">]</span> = parse_goal<span style="color: #4d9391;">(</span>dialogue<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'goal'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
            delex_data<span style="color: #4d9391;">[</span>dialogue_name<span style="color: #4d9391;">]</span> = dialogue
        <span style="color: #49bdb0;">else</span>:
            ignored_dialogues += 1
    <span style="color: #49bdb0;">if</span> ignored_dialogues &gt; 0:
        logger.warning<span style="color: #4d9391;">(</span>f<span style="color: #cea2ca;">'dialogues were ignored </span>{100 * ignored_dialogues / (ignored_dialogues + <span style="color: #53E6B5;">len</span>(delex_data)):.1f}<span style="color: #cea2ca;">% due to a missing domain "bus"'</span><span style="color: #4d9391;">)</span>  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">noqa: E501</span>
    <span style="color: #49bdb0;">return</span> delex_data


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">load_databases</span><span style="color: #4d9391;">(</span>zipf<span style="color: #4d9391;">)</span>:
    dbs = <span style="color: #4d9391;">{}</span>
    sql_dbs = <span style="color: #4d9391;">{</span><span style="color: #cea2ca;">'attraction'</span>, <span style="color: #cea2ca;">'hotel'</span>, <span style="color: #cea2ca;">'restaurant'</span>, <span style="color: #cea2ca;">'train'</span><span style="color: #4d9391;">}</span>
    <span style="color: #49bdb0;">for</span> domain <span style="color: #49bdb0;">in</span> MW_DOMAINS:
        <span style="color: #49bdb0;">if</span> domain <span style="color: #49bdb0;">in</span> sql_dbs:
            db = <span style="color: #cea2ca;">'db/{}-dbase.db'</span>.<span style="color: #53E6B5;">format</span><span style="color: #4d9391;">(</span>domain<span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">with</span> tempfile.NamedTemporaryFile<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'rb+'</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">as</span> dbf:
                shutil.copyfileobj<span style="color: #4d9391;">(</span>zipf.<span style="color: #53E6B5;">open</span><span style="color: #47ba99;">(</span>db<span style="color: #47ba99;">)</span>, dbf<span style="color: #4d9391;">)</span>
                dbf.flush<span style="color: #4d9391;">()</span>
                fileconn = sqlite3.connect<span style="color: #4d9391;">(</span>dbf.name<span style="color: #4d9391;">)</span>
                conn = sqlite3.connect<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">':memory:'</span><span style="color: #4d9391;">)</span>
                fileconn.backup<span style="color: #4d9391;">(</span>conn<span style="color: #4d9391;">)</span>

            <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">dict_factory</span><span style="color: #4d9391;">(</span>cursor, row<span style="color: #4d9391;">)</span>:
                d = <span style="color: #4d9391;">{}</span>
                <span style="color: #49bdb0;">for</span> idx, col <span style="color: #49bdb0;">in</span> <span style="color: #53E6B5;">enumerate</span><span style="color: #4d9391;">(</span>cursor.description<span style="color: #4d9391;">)</span>:
                    d<span style="color: #4d9391;">[</span>col<span style="color: #47ba99;">[</span>0<span style="color: #47ba99;">]</span><span style="color: #4d9391;">]</span> = row<span style="color: #4d9391;">[</span>idx<span style="color: #4d9391;">]</span>
                <span style="color: #49bdb0;">return</span> d

            conn.row_factory = dict_factory
            c = conn.cursor<span style="color: #4d9391;">()</span>
            dbs<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">]</span> = c
        <span style="color: #49bdb0;">else</span>:
            db = <span style="color: #cea2ca;">'db/{}_db.json'</span>.<span style="color: #53E6B5;">format</span><span style="color: #4d9391;">(</span>domain<span style="color: #4d9391;">)</span>
            dbs<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">]</span> = json.load<span style="color: #4d9391;">(</span>zipf.<span style="color: #53E6B5;">open</span><span style="color: #47ba99;">(</span>db<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
    <span style="color: #49bdb0;">return</span> dbs


<span style="color: #49bdb0;">class</span> <span style="color: #eed891;">Database</span>:
    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__init__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, zipf, seed=42<span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">self</span>.path = zipf.filename
        <span style="color: #49bdb0;">self</span>.dbs = load_databases<span style="color: #4d9391;">(</span>zipf<span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">self</span>.ignore_values = <span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'not mentioned'</span>, <span style="color: #cea2ca;">'dont care'</span>, <span style="color: #cea2ca;">'don\'t care'</span>, <span style="color: #cea2ca;">'dontcare'</span>, <span style="color: #cea2ca;">'do n\'t care'</span>, <span style="color: #cea2ca;">'none'</span><span style="color: #4d9391;">]</span>
        <span style="color: #49bdb0;">self</span>.rng = random.Random<span style="color: #4d9391;">(</span>seed<span style="color: #4d9391;">)</span>

    price_re = re.<span style="color: #53E6B5;">compile</span><span style="color: #4d9391;">(</span>r<span style="color: #cea2ca;">'\d+\.\d+'</span><span style="color: #4d9391;">)</span>

    @<span style="color: #53E6B5;">staticmethod</span>
    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">translate_to_db_col</span><span style="color: #4d9391;">(</span>s<span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">if</span> s == <span style="color: #cea2ca;">'leave at'</span>:
            <span style="color: #49bdb0;">return</span> <span style="color: #cea2ca;">'leaveAt'</span>
        <span style="color: #49bdb0;">elif</span> s == <span style="color: #cea2ca;">'arrive by'</span>:
            <span style="color: #49bdb0;">return</span> <span style="color: #cea2ca;">'arriveBy'</span>
        <span style="color: #49bdb0;">elif</span> s == <span style="color: #cea2ca;">'price range'</span>:
            <span style="color: #49bdb0;">return</span> <span style="color: #cea2ca;">'pricerange'</span>
        <span style="color: #49bdb0;">else</span>:
            <span style="color: #49bdb0;">return</span> s

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">domain_not_empty</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, domain_bs<span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">return</span> <span style="color: #53E6B5;">any</span><span style="color: #4d9391;">(</span><span style="color: #53E6B5;">len</span><span style="color: #47ba99;">(</span>val<span style="color: #47ba99;">)</span> &gt; 0 <span style="color: #49bdb0;">and</span> val <span style="color: #49bdb0;">not</span> <span style="color: #49bdb0;">in</span> <span style="color: #49bdb0;">self</span>.ignore_values <span style="color: #49bdb0;">for</span> val <span style="color: #49bdb0;">in</span> domain_bs.values<span style="color: #47ba99;">()</span><span style="color: #4d9391;">)</span>

    @<span style="color: #53E6B5;">staticmethod</span>
    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">map_database_key</span><span style="color: #4d9391;">(</span>key<span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">if</span> key == <span style="color: #cea2ca;">'trainID'</span>:
            key = <span style="color: #cea2ca;">'id'</span>
        key = <span style="color: #cea2ca;">''</span>.join<span style="color: #4d9391;">(</span><span style="color: #47ba99;">[</span><span style="color: #cea2ca;">' '</span>+i.lower<span style="color: #9d81ba;">()</span> <span style="color: #49bdb0;">if</span> i.isupper<span style="color: #9d81ba;">()</span>
                       <span style="color: #49bdb0;">else</span> i <span style="color: #49bdb0;">for</span> i <span style="color: #49bdb0;">in</span> key<span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>.lstrip<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">' '</span><span style="color: #4d9391;">)</span>
        key = key.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'_'</span>, <span style="color: #cea2ca;">' '</span><span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">if</span> key == <span style="color: #cea2ca;">'pricerange'</span>:
            key = <span style="color: #cea2ca;">'price range'</span>
        <span style="color: #49bdb0;">if</span> key == <span style="color: #cea2ca;">'taxi phone'</span> <span style="color: #49bdb0;">or</span> key == <span style="color: #cea2ca;">'phone'</span>:
            key = <span style="color: #cea2ca;">'phone'</span>
        <span style="color: #49bdb0;">if</span> key == <span style="color: #cea2ca;">'taxi colors'</span>:
            key = <span style="color: #cea2ca;">'color'</span>
        <span style="color: #49bdb0;">if</span> key == <span style="color: #cea2ca;">'taxi types'</span>:
            key = <span style="color: #cea2ca;">'brand'</span>
        <span style="color: #49bdb0;">if</span> key == <span style="color: #cea2ca;">'ref'</span>:
            key = <span style="color: #cea2ca;">'reference'</span>
        <span style="color: #49bdb0;">if</span> key == <span style="color: #cea2ca;">'leaveAt'</span>:
            key = <span style="color: #cea2ca;">'leave at'</span>
        <span style="color: #49bdb0;">if</span> key == <span style="color: #cea2ca;">'arriveBy'</span>:
            key = <span style="color: #cea2ca;">'arrive by'</span>
        <span style="color: #49bdb0;">if</span> key == <span style="color: #cea2ca;">'entrance fee'</span>:
            key = <span style="color: #cea2ca;">'fee'</span>
        <span style="color: #49bdb0;">return</span> key

    @<span style="color: #53E6B5;">staticmethod</span>
    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">map_query_value</span><span style="color: #4d9391;">(</span>value<span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">if</span> value == <span style="color: #cea2ca;">'concert hall'</span>:
            value = <span style="color: #cea2ca;">'concerthall'</span>
        <span style="color: #49bdb0;">if</span> value == <span style="color: #cea2ca;">'night club'</span>:
            value = <span style="color: #cea2ca;">'nightclub'</span>
        <span style="color: #49bdb0;">return</span> value

    @<span style="color: #53E6B5;">staticmethod</span>
    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">capitalize</span><span style="color: #4d9391;">(</span>val<span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">_mk</span><span style="color: #4d9391;">(</span>v<span style="color: #4d9391;">)</span>:
            i, v = v
            <span style="color: #49bdb0;">if</span> i == 0 <span style="color: #49bdb0;">or</span> v <span style="color: #49bdb0;">not</span> <span style="color: #49bdb0;">in</span> <span style="color: #4d9391;">{</span><span style="color: #cea2ca;">'the'</span>, <span style="color: #cea2ca;">'an'</span>, <span style="color: #cea2ca;">'a'</span>, <span style="color: #cea2ca;">'of'</span>, <span style="color: #cea2ca;">'in'</span>, <span style="color: #cea2ca;">'for'</span>, <span style="color: #cea2ca;">'as'</span>, <span style="color: #cea2ca;">'these'</span>, <span style="color: #cea2ca;">'at'</span>, <span style="color: #cea2ca;">'up'</span>, <span style="color: #cea2ca;">'on'</span>, <span style="color: #cea2ca;">'and'</span>, <span style="color: #cea2ca;">'or'</span><span style="color: #4d9391;">}</span>:
                <span style="color: #49bdb0;">return</span> v<span style="color: #4d9391;">[</span>:1<span style="color: #4d9391;">]</span>.upper<span style="color: #4d9391;">()</span> + v<span style="color: #4d9391;">[</span>1:<span style="color: #4d9391;">]</span>
            <span style="color: #49bdb0;">else</span>:
                <span style="color: #49bdb0;">return</span> v
        <span style="color: #49bdb0;">return</span> <span style="color: #cea2ca;">' '</span>.join<span style="color: #4d9391;">(</span><span style="color: #53E6B5;">map</span><span style="color: #47ba99;">(</span>_mk, <span style="color: #53E6B5;">enumerate</span><span style="color: #9d81ba;">(</span>val.split()<span style="color: #9d81ba;">)</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>

    @<span style="color: #53E6B5;">staticmethod</span>
    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">map_database_row</span><span style="color: #4d9391;">(</span>domain, row, query<span style="color: #4d9391;">)</span>:
        results = <span style="color: #53E6B5;">dict</span><span style="color: #4d9391;">()</span>
        <span style="color: #49bdb0;">for</span> k, val <span style="color: #49bdb0;">in</span> row.items<span style="color: #4d9391;">()</span>:
            k2 = Database.map_database_key<span style="color: #4d9391;">(</span>k<span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">if</span> k == <span style="color: #cea2ca;">'location'</span>:
                <span style="color: #49bdb0;">continue</span>
            <span style="color: #49bdb0;">elif</span> k == <span style="color: #cea2ca;">'post code'</span> <span style="color: #49bdb0;">or</span> k == <span style="color: #cea2ca;">'postcode'</span>:
                val = val.upper<span style="color: #4d9391;">()</span>
            <span style="color: #49bdb0;">elif</span> k == <span style="color: #cea2ca;">'name'</span>:
                val = Database.capitalize<span style="color: #4d9391;">(</span>val<span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">elif</span> k == <span style="color: #cea2ca;">'type'</span> <span style="color: #49bdb0;">and</span> val == <span style="color: #cea2ca;">'concerthall'</span>:
                val = <span style="color: #cea2ca;">'concert hall'</span>
            <span style="color: #49bdb0;">elif</span> k == <span style="color: #cea2ca;">'price'</span> <span style="color: #49bdb0;">and</span> domain == <span style="color: #cea2ca;">'hotel'</span> <span style="color: #49bdb0;">and</span> <span style="color: #53E6B5;">isinstance</span><span style="color: #4d9391;">(</span>val, <span style="color: #53E6B5;">dict</span><span style="color: #4d9391;">)</span>:
                val = val.get<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'single'</span>, val.get<span style="color: #47ba99;">(</span><span style="color: #cea2ca;">'double'</span>, <span style="color: #53E6B5;">next</span><span style="color: #9d81ba;">(</span><span style="color: #53E6B5;">iter</span>(val.values<span style="color: #35BF88;">()</span>)<span style="color: #9d81ba;">)</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                val = f<span style="color: #cea2ca;">'</span>{val}<span style="color: #cea2ca;"> pounds'</span>
            <span style="color: #49bdb0;">if</span> k2 == <span style="color: #cea2ca;">'people'</span>:
                <span style="color: #635C4A;"># </span><span style="color: #635C4A;">BUG in MW2.0</span>
                val = val.lstrip<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'`'</span><span style="color: #4d9391;">)</span>
            results<span style="color: #4d9391;">[</span>k2<span style="color: #4d9391;">]</span> = val
        <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'color'</span> <span style="color: #49bdb0;">in</span> results <span style="color: #49bdb0;">and</span> <span style="color: #cea2ca;">'brand'</span> <span style="color: #49bdb0;">in</span> results:
            results<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'car'</span><span style="color: #4d9391;">]</span> = f<span style="color: #cea2ca;">"</span>{results['color']}<span style="color: #cea2ca;"> </span>{results['brand']}<span style="color: #cea2ca;">"</span>
        <span style="color: #49bdb0;">if</span> domain == <span style="color: #cea2ca;">'train'</span> <span style="color: #49bdb0;">and</span> <span style="color: #cea2ca;">'price'</span> <span style="color: #49bdb0;">in</span> row <span style="color: #49bdb0;">and</span> <span style="color: #cea2ca;">'people'</span> <span style="color: #49bdb0;">in</span> query:
            people = <span style="color: #53E6B5;">int</span><span style="color: #4d9391;">(</span>query<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'people'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>

            <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">multiply_people</span><span style="color: #4d9391;">(</span>m<span style="color: #4d9391;">)</span>:
                price = <span style="color: #53E6B5;">float</span><span style="color: #4d9391;">(</span>m.group<span style="color: #47ba99;">(</span>0<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                price *= people
                <span style="color: #49bdb0;">return</span> <span style="color: #53E6B5;">format</span><span style="color: #4d9391;">(</span>price, <span style="color: #cea2ca;">'.2f'</span><span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">if</span> people != 1:
                results<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'price'</span><span style="color: #4d9391;">]</span> = Database.price_re.sub<span style="color: #4d9391;">(</span>multiply_people, row<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'price'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">return</span> results

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">query_domain</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, domain, query<span style="color: #4d9391;">)</span>:
        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Handle special domains not in sqlite databases</span>
        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">NOTE: this is not a part of multiwoz repo</span>
        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Taken from convlab</span>
        <span style="color: #49bdb0;">if</span> domain == <span style="color: #cea2ca;">'taxi'</span>:
            <span style="color: #49bdb0;">return</span> <span style="color: #4d9391;">[</span><span style="color: #47ba99;">{</span><span style="color: #cea2ca;">'color'</span>: <span style="color: #49bdb0;">self</span>.rng.choice<span style="color: #9d81ba;">(</span><span style="color: #49bdb0;">self</span>.dbs[domain][<span style="color: #cea2ca;">'taxi_colors'</span>]<span style="color: #9d81ba;">)</span>,
                     <span style="color: #cea2ca;">'brand'</span>: <span style="color: #49bdb0;">self</span>.rng.choice<span style="color: #9d81ba;">(</span><span style="color: #49bdb0;">self</span>.dbs[domain][<span style="color: #cea2ca;">'taxi_types'</span>]<span style="color: #9d81ba;">)</span>,
                     <span style="color: #cea2ca;">'phone'</span>: <span style="color: #cea2ca;">''</span>.join<span style="color: #9d81ba;">(</span>[<span style="color: #53E6B5;">str</span><span style="color: #35BF88;">(</span>random.randint<span style="color: #eed891;">(</span>1, 9<span style="color: #eed891;">)</span><span style="color: #35BF88;">)</span> <span style="color: #49bdb0;">for</span> _ <span style="color: #49bdb0;">in</span> <span style="color: #53E6B5;">range</span><span style="color: #35BF88;">(</span>11<span style="color: #35BF88;">)</span>]<span style="color: #9d81ba;">)</span><span style="color: #47ba99;">}</span><span style="color: #4d9391;">]</span>
        <span style="color: #49bdb0;">if</span> domain == <span style="color: #cea2ca;">'police'</span>:
            <span style="color: #49bdb0;">return</span> deepcopy<span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>.dbs<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'police'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">if</span> domain == <span style="color: #cea2ca;">'hospital'</span>:
            department = <span style="color: #ef6787;">None</span>
            <span style="color: #49bdb0;">for</span> key, val <span style="color: #49bdb0;">in</span> query:
                <span style="color: #49bdb0;">if</span> key == <span style="color: #cea2ca;">'department'</span>:
                    department = val
            <span style="color: #49bdb0;">if</span> <span style="color: #49bdb0;">not</span> department:
                <span style="color: #49bdb0;">return</span> deepcopy<span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>.dbs<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'hospital'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">else</span>:
                <span style="color: #49bdb0;">return</span> <span style="color: #4d9391;">[</span>deepcopy<span style="color: #47ba99;">(</span>x<span style="color: #47ba99;">)</span> <span style="color: #49bdb0;">for</span> x <span style="color: #49bdb0;">in</span> <span style="color: #49bdb0;">self</span>.dbs<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'hospital'</span><span style="color: #47ba99;">]</span>
                        <span style="color: #49bdb0;">if</span> x<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'department'</span><span style="color: #47ba99;">]</span>.lower<span style="color: #47ba99;">()</span> == department.strip<span style="color: #47ba99;">()</span>.lower<span style="color: #47ba99;">()</span><span style="color: #4d9391;">]</span>

        sql_query = <span style="color: #cea2ca;">"select * from {}"</span>.<span style="color: #53E6B5;">format</span><span style="color: #4d9391;">(</span>domain<span style="color: #4d9391;">)</span>

        flag = <span style="color: #ef6787;">True</span>
        <span style="color: #49bdb0;">for</span> key, val <span style="color: #49bdb0;">in</span> query:
            <span style="color: #49bdb0;">if</span> val == <span style="color: #cea2ca;">""</span> <span style="color: #49bdb0;">or</span> val <span style="color: #49bdb0;">in</span> <span style="color: #49bdb0;">self</span>.ignore_values:
                <span style="color: #49bdb0;">pass</span>
            <span style="color: #49bdb0;">else</span>:
                <span style="color: #49bdb0;">if</span> flag:
                    sql_query += <span style="color: #cea2ca;">" where "</span>
                    val2 = val.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"'"</span>, <span style="color: #cea2ca;">"''"</span><span style="color: #4d9391;">)</span>
                    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">change query for trains</span>
                    <span style="color: #49bdb0;">if</span> key == <span style="color: #cea2ca;">'leaveAt'</span>:
                        sql_query += r<span style="color: #cea2ca;">" "</span> + key + <span style="color: #cea2ca;">" &gt; "</span> + r<span style="color: #cea2ca;">"'"</span> + val2 + r<span style="color: #cea2ca;">"'"</span>
                    <span style="color: #49bdb0;">elif</span> key == <span style="color: #cea2ca;">'arriveBy'</span>:
                        sql_query += r<span style="color: #cea2ca;">" "</span> + key + <span style="color: #cea2ca;">" &lt; "</span> + r<span style="color: #cea2ca;">"'"</span> + val2 + r<span style="color: #cea2ca;">"'"</span>
                    <span style="color: #49bdb0;">else</span>:
                        sql_query += r<span style="color: #cea2ca;">" "</span> + key + <span style="color: #cea2ca;">"="</span> + r<span style="color: #cea2ca;">"'"</span> + val2 + r<span style="color: #cea2ca;">"'"</span>
                    flag = <span style="color: #ef6787;">False</span>
                <span style="color: #49bdb0;">else</span>:
                    val2 = val.replace<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"'"</span>, <span style="color: #cea2ca;">"''"</span><span style="color: #4d9391;">)</span>
                    <span style="color: #49bdb0;">if</span> key == <span style="color: #cea2ca;">'leaveAt'</span>:
                        sql_query += r<span style="color: #cea2ca;">" and "</span> + key + <span style="color: #cea2ca;">" &gt; "</span> + r<span style="color: #cea2ca;">"'"</span> + val2 + r<span style="color: #cea2ca;">"'"</span>
                    <span style="color: #49bdb0;">elif</span> key == <span style="color: #cea2ca;">'arriveBy'</span>:
                        sql_query += r<span style="color: #cea2ca;">" and "</span> + key + <span style="color: #cea2ca;">" &lt; "</span> + r<span style="color: #cea2ca;">"'"</span> + val2 + r<span style="color: #cea2ca;">"'"</span>
                    <span style="color: #49bdb0;">else</span>:
                        sql_query += r<span style="color: #cea2ca;">" and "</span> + key + <span style="color: #cea2ca;">"="</span> + r<span style="color: #cea2ca;">"'"</span> + val2 + r<span style="color: #cea2ca;">"'"</span>

        result = <span style="color: #49bdb0;">self</span>.dbs<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">]</span>.execute<span style="color: #4d9391;">(</span>sql_query<span style="color: #4d9391;">)</span>.fetchall<span style="color: #4d9391;">()</span>
        <span style="color: #49bdb0;">return</span> result

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__call__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, belief, return_results=<span style="color: #ef6787;">False</span><span style="color: #4d9391;">)</span>:
        all_results = OrderedDict<span style="color: #4d9391;">()</span>
        <span style="color: #49bdb0;">for</span> domain, domain_bs <span style="color: #49bdb0;">in</span> belief.items<span style="color: #4d9391;">()</span>:
            blocked_slots = <span style="color: #4d9391;">{</span><span style="color: #cea2ca;">'people'</span>, <span style="color: #cea2ca;">'booked'</span>, <span style="color: #cea2ca;">'stay'</span><span style="color: #4d9391;">}</span>
            <span style="color: #49bdb0;">if</span> domain != <span style="color: #cea2ca;">'train'</span> <span style="color: #49bdb0;">and</span> domain != <span style="color: #cea2ca;">'bus'</span>:
                blocked_slots.add<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'day'</span><span style="color: #4d9391;">)</span>
                blocked_slots.add<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'time'</span><span style="color: #4d9391;">)</span>
            query = <span style="color: #4d9391;">[</span><span style="color: #47ba99;">(</span>Database.translate_to_db_col<span style="color: #9d81ba;">(</span>slot<span style="color: #9d81ba;">)</span>, Database.map_query_value<span style="color: #9d81ba;">(</span>val<span style="color: #9d81ba;">)</span><span style="color: #47ba99;">)</span>
                     <span style="color: #49bdb0;">for</span> slot, val <span style="color: #49bdb0;">in</span> domain_bs.items<span style="color: #47ba99;">()</span> <span style="color: #49bdb0;">if</span> slot <span style="color: #49bdb0;">not</span> <span style="color: #49bdb0;">in</span> blocked_slots<span style="color: #4d9391;">]</span>

            result = <span style="color: #49bdb0;">self</span>.query_domain<span style="color: #4d9391;">(</span>domain, query<span style="color: #4d9391;">)</span>
            result = <span style="color: #4d9391;">[</span>Database.map_database_row<span style="color: #47ba99;">(</span>domain, k, domain_bs<span style="color: #47ba99;">)</span> <span style="color: #49bdb0;">for</span> k <span style="color: #49bdb0;">in</span> result<span style="color: #4d9391;">]</span>
            <span style="color: #49bdb0;">if</span> return_results:
                all_results<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">]</span> = <span style="color: #4d9391;">(</span><span style="color: #53E6B5;">len</span><span style="color: #47ba99;">(</span>result<span style="color: #47ba99;">)</span>, result<span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">else</span>:
                all_results<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">]</span> = <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span>result<span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">return</span> all_results

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">save</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, path<span style="color: #4d9391;">)</span>:
        shutil.copy<span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>.path, os.path.join<span style="color: #47ba99;">(</span>path, os.path.split<span style="color: #9d81ba;">(</span><span style="color: #49bdb0;">self</span>.path<span style="color: #9d81ba;">)[</span>-1<span style="color: #9d81ba;">]</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">is_booked</span><span style="color: #4d9391;">(</span>raw_belief, domain<span style="color: #4d9391;">)</span>:
    <span style="color: #49bdb0;">return</span> domain <span style="color: #49bdb0;">in</span> raw_belief <span style="color: #49bdb0;">and</span> <span style="color: #cea2ca;">'book'</span> <span style="color: #49bdb0;">in</span> raw_belief<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">]</span> <span style="color: #49bdb0;">and</span> \
        <span style="color: #cea2ca;">'booked'</span> <span style="color: #49bdb0;">in</span> raw_belief<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'book'</span><span style="color: #4d9391;">]</span> <span style="color: #49bdb0;">and</span> \
        <span style="color: #53E6B5;">any</span><span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'reference'</span> <span style="color: #49bdb0;">in</span> x <span style="color: #49bdb0;">for</span> x <span style="color: #49bdb0;">in</span> raw_belief<span style="color: #47ba99;">[</span>domain<span style="color: #47ba99;">][</span><span style="color: #cea2ca;">'book'</span><span style="color: #47ba99;">][</span><span style="color: #cea2ca;">'booked'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">get_booked_domains</span><span style="color: #4d9391;">(</span>raw_belief<span style="color: #4d9391;">)</span>:
    <span style="color: #49bdb0;">for</span> domain <span style="color: #49bdb0;">in</span> raw_belief.keys<span style="color: #4d9391;">()</span>:
        <span style="color: #49bdb0;">if</span> is_booked<span style="color: #4d9391;">(</span>raw_belief, domain<span style="color: #4d9391;">)</span>:
            <span style="color: #49bdb0;">yield</span> domain


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">parse_goal</span><span style="color: #4d9391;">(</span>dialog_goal<span style="color: #4d9391;">)</span>:
    belief_transformation = BeliefStateTransformation<span style="color: #4d9391;">()</span>
    <span style="color: #a9779c;">"""Parses user goal into dictionary format."""</span>
    goal = <span style="color: #4d9391;">{}</span>
    <span style="color: #49bdb0;">for</span> domain <span style="color: #49bdb0;">in</span> MW_DOMAINS:
        <span style="color: #49bdb0;">if</span> <span style="color: #49bdb0;">not</span> dialog_goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">]</span>:
            <span style="color: #49bdb0;">continue</span>
        goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">]</span> = <span style="color: #4d9391;">{}</span>
        goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">]</span> = <span style="color: #4d9391;">{</span><span style="color: #cea2ca;">'informable'</span>: <span style="color: #47ba99;">[]</span>, <span style="color: #cea2ca;">'requestable'</span>: <span style="color: #47ba99;">[]</span>, <span style="color: #cea2ca;">'booking'</span>: <span style="color: #47ba99;">{}</span><span style="color: #4d9391;">}</span>
        <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'info'</span> <span style="color: #49bdb0;">in</span> dialog_goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">]</span>:
            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">if d['goal'][domain].has_key('info'):</span>
            <span style="color: #49bdb0;">if</span> domain == <span style="color: #cea2ca;">'train'</span>:
                <span style="color: #635C4A;"># </span><span style="color: #635C4A;">we consider dialogues only where train had to be booked!</span>
                <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'book'</span> <span style="color: #49bdb0;">in</span> dialog_goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">]</span>:
                    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">if d['goal'][domain].has_key('book'):</span>
                    goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'requestable'</span><span style="color: #4d9391;">]</span>.append<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'reference'</span><span style="color: #4d9391;">)</span>
                <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'reqt'</span> <span style="color: #49bdb0;">in</span> dialog_goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">]</span>:
                    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">if d['goal'][domain].has_key('reqt'):</span>
                    <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'trainID'</span> <span style="color: #49bdb0;">in</span> dialog_goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'reqt'</span><span style="color: #4d9391;">]</span>:
                        goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'requestable'</span><span style="color: #4d9391;">]</span>.append<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'id'</span><span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">else</span>:
                <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'reqt'</span> <span style="color: #49bdb0;">in</span> dialog_goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">]</span>:
                    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">if d['goal'][domain].has_key('reqt'):</span>
                    <span style="color: #49bdb0;">for</span> s <span style="color: #49bdb0;">in</span> dialog_goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'reqt'</span><span style="color: #4d9391;">]</span>:  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">addtional requests:</span>
                        <span style="color: #49bdb0;">if</span> s <span style="color: #49bdb0;">in</span> <span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'phone'</span>, <span style="color: #cea2ca;">'address'</span>, <span style="color: #cea2ca;">'postcode'</span>, <span style="color: #cea2ca;">'reference'</span>, <span style="color: #cea2ca;">'id'</span><span style="color: #4d9391;">]</span>:
                            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">ones that can be easily delexicalised</span>
                            goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'requestable'</span><span style="color: #4d9391;">]</span>.append<span style="color: #4d9391;">(</span>s<span style="color: #4d9391;">)</span>
                <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'book'</span> <span style="color: #49bdb0;">in</span> dialog_goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">]</span>:
                    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">if d['goal'][domain].has_key('book'):</span>
                    goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'requestable'</span><span style="color: #4d9391;">]</span>.append<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"reference"</span><span style="color: #4d9391;">)</span>

            goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">"informable"</span><span style="color: #4d9391;">]</span> = dialog_goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'info'</span><span style="color: #4d9391;">]</span>
            <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'book'</span> <span style="color: #49bdb0;">in</span> dialog_goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">]</span>:
                <span style="color: #635C4A;"># </span><span style="color: #635C4A;">if d['goal'][domain].has_key('book'):</span>
                goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">"booking"</span><span style="color: #4d9391;">]</span> = dialog_goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'book'</span><span style="color: #4d9391;">]</span>

        <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'invalid'</span> <span style="color: #49bdb0;">in</span> goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'booking'</span><span style="color: #4d9391;">]</span>:
            <span style="color: #49bdb0;">del</span> goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'booking'</span><span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'invalid'</span><span style="color: #4d9391;">]</span>
        <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'pre_invalid'</span> <span style="color: #49bdb0;">in</span> goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'booking'</span><span style="color: #4d9391;">]</span>:
            <span style="color: #49bdb0;">del</span> goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'booking'</span><span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'pre_invalid'</span><span style="color: #4d9391;">]</span>
        belief = <span style="color: #4d9391;">{</span>domain: <span style="color: #47ba99;">{</span><span style="color: #cea2ca;">'semi'</span>: goal<span style="color: #9d81ba;">[</span>domain<span style="color: #9d81ba;">][</span><span style="color: #cea2ca;">'informable'</span><span style="color: #9d81ba;">]</span>, <span style="color: #cea2ca;">'book'</span>: goal<span style="color: #9d81ba;">[</span>domain<span style="color: #9d81ba;">][</span><span style="color: #cea2ca;">'booking'</span><span style="color: #9d81ba;">]</span><span style="color: #47ba99;">}</span><span style="color: #4d9391;">}</span>
        belief = belief_transformation<span style="color: #4d9391;">(</span>belief, <span style="color: #47ba99;">[]</span>, domain<span style="color: #4d9391;">)</span>.get<span style="color: #4d9391;">(</span>domain, <span style="color: #53E6B5;">dict</span><span style="color: #47ba99;">()</span><span style="color: #4d9391;">)</span>
        goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'informable'</span><span style="color: #4d9391;">]</span> = belief
        <span style="color: #49bdb0;">del</span> goal<span style="color: #4d9391;">[</span>domain<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'booking'</span><span style="color: #4d9391;">]</span>
    <span style="color: #49bdb0;">return</span> goal


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">map_dialogue_items</span><span style="color: #4d9391;">(</span>log<span style="color: #4d9391;">)</span>:
    supported_keys = <span style="color: #4d9391;">{</span><span style="color: #cea2ca;">'text'</span>, <span style="color: #cea2ca;">'delexicalised_text'</span>, <span style="color: #cea2ca;">'speaker'</span>, <span style="color: #cea2ca;">'belief'</span>, <span style="color: #cea2ca;">'database'</span>,
                      <span style="color: #cea2ca;">'active_domain'</span>, <span style="color: #cea2ca;">'dialogue_act'</span>, <span style="color: #cea2ca;">'booked_domains'</span><span style="color: #4d9391;">}</span>
    <span style="color: #49bdb0;">for</span> item <span style="color: #49bdb0;">in</span> log:
        <span style="color: #49bdb0;">yield</span> <span style="color: #4d9391;">{</span>k: v <span style="color: #49bdb0;">for</span> k, v <span style="color: #49bdb0;">in</span> item.items<span style="color: #47ba99;">()</span> <span style="color: #49bdb0;">if</span> k <span style="color: #49bdb0;">in</span> supported_keys<span style="color: #4d9391;">}</span>


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">divideData</span><span style="color: #4d9391;">(</span>data, zipf, path<span style="color: #4d9391;">)</span>:
    <span style="color: #a9779c;">"""Given test and validation sets, divide</span>
<span style="color: #a9779c;">    the data for three different sets"""</span>
    testListFile = <span style="color: #4d9391;">[]</span>
    root = <span style="color: #53E6B5;">next</span><span style="color: #4d9391;">(</span><span style="color: #53E6B5;">iter</span><span style="color: #47ba99;">(</span><span style="color: #9d81ba;">{</span>n.strip(<span style="color: #cea2ca;">'data.json'</span>) <span style="color: #49bdb0;">for</span> n <span style="color: #49bdb0;">in</span> zipf.namelist() <span style="color: #49bdb0;">if</span> n.endswith(<span style="color: #cea2ca;">'data.json'</span>)<span style="color: #9d81ba;">}</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
    fin = zipf.<span style="color: #53E6B5;">open</span><span style="color: #4d9391;">(</span>root + <span style="color: #cea2ca;">'testListFile.json'</span>, <span style="color: #cea2ca;">'r'</span><span style="color: #4d9391;">)</span>
    <span style="color: #49bdb0;">for</span> line <span style="color: #49bdb0;">in</span> fin:
        testListFile.append<span style="color: #4d9391;">(</span>line<span style="color: #47ba99;">[</span>:-1<span style="color: #47ba99;">]</span>.decode<span style="color: #47ba99;">(</span><span style="color: #cea2ca;">'utf-8'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
    fin.close<span style="color: #4d9391;">()</span>

    valListFile = <span style="color: #4d9391;">[]</span>
    fin = zipf.<span style="color: #53E6B5;">open</span><span style="color: #4d9391;">(</span>root + <span style="color: #cea2ca;">'valListFile.json'</span>, <span style="color: #cea2ca;">'r'</span><span style="color: #4d9391;">)</span>
    <span style="color: #49bdb0;">for</span> line <span style="color: #49bdb0;">in</span> fin:
        valListFile.append<span style="color: #4d9391;">(</span>line<span style="color: #47ba99;">[</span>:-1<span style="color: #47ba99;">]</span>.decode<span style="color: #47ba99;">(</span><span style="color: #cea2ca;">'utf-8'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
    fin.close<span style="color: #4d9391;">()</span>

    test_dials = <span style="color: #4d9391;">[]</span>
    val_dials = <span style="color: #4d9391;">[]</span>
    train_dials = <span style="color: #4d9391;">[]</span>

    <span style="color: #49bdb0;">for</span> dialogue_name <span style="color: #49bdb0;">in</span> tqdm<span style="color: #4d9391;">(</span>data<span style="color: #4d9391;">)</span>:
        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">print dialogue_name</span>
        dial = get_dial<span style="color: #4d9391;">(</span>data<span style="color: #47ba99;">[</span>dialogue_name<span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">if</span> dial:
            dialogue = <span style="color: #4d9391;">{}</span>
            dialogue<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'name'</span><span style="color: #4d9391;">]</span> = dialogue_name
            dialogue<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'items'</span><span style="color: #4d9391;">]</span> = <span style="color: #53E6B5;">list</span><span style="color: #4d9391;">(</span>map_dialogue_items<span style="color: #47ba99;">(</span>dial<span style="color: #9d81ba;">[</span><span style="color: #cea2ca;">'log'</span><span style="color: #9d81ba;">]</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
            dialogue<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'goal'</span><span style="color: #4d9391;">]</span> = dial<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'goal'</span><span style="color: #4d9391;">]</span>

            <span style="color: #49bdb0;">if</span> dialogue_name <span style="color: #49bdb0;">in</span> testListFile:
                test_dials.append<span style="color: #4d9391;">(</span>dialogue<span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">elif</span> dialogue_name <span style="color: #49bdb0;">in</span> valListFile:
                val_dials.append<span style="color: #4d9391;">(</span>dialogue<span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">else</span>:
                train_dials.append<span style="color: #4d9391;">(</span>dialogue<span style="color: #4d9391;">)</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">save all dialogues</span>
    <span style="color: #49bdb0;">with</span> <span style="color: #53E6B5;">open</span><span style="color: #4d9391;">(</span>os.path.join<span style="color: #47ba99;">(</span>path, <span style="color: #cea2ca;">'val.json'</span><span style="color: #47ba99;">)</span>, <span style="color: #cea2ca;">'w'</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">as</span> f:
        json.dump<span style="color: #4d9391;">(</span><span style="color: #53E6B5;">dict</span><span style="color: #47ba99;">(</span>domains=MW_DOMAINS, dialogues=val_dials<span style="color: #47ba99;">)</span>, f, indent=4<span style="color: #4d9391;">)</span>

    <span style="color: #49bdb0;">with</span> <span style="color: #53E6B5;">open</span><span style="color: #4d9391;">(</span>os.path.join<span style="color: #47ba99;">(</span>path, <span style="color: #cea2ca;">'test.json'</span><span style="color: #47ba99;">)</span>, <span style="color: #cea2ca;">'w'</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">as</span> f:
        json.dump<span style="color: #4d9391;">(</span><span style="color: #53E6B5;">dict</span><span style="color: #47ba99;">(</span>domains=MW_DOMAINS, dialogues=test_dials<span style="color: #47ba99;">)</span>, f, indent=4<span style="color: #4d9391;">)</span>

    <span style="color: #49bdb0;">with</span> <span style="color: #53E6B5;">open</span><span style="color: #4d9391;">(</span>os.path.join<span style="color: #47ba99;">(</span>path, <span style="color: #cea2ca;">'train.json'</span><span style="color: #47ba99;">)</span>, <span style="color: #cea2ca;">'w'</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">as</span> f:
        json.dump<span style="color: #4d9391;">(</span><span style="color: #53E6B5;">dict</span><span style="color: #47ba99;">(</span>domains=MW_DOMAINS, dialogues=train_dials<span style="color: #47ba99;">)</span>, f, indent=4<span style="color: #4d9391;">)</span>


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">export_database_source</span><span style="color: #4d9391;">(</span>zipf<span style="color: #4d9391;">)</span>:
    source_code = f<span style="color: #cea2ca;">"""import sqlite3</span>
<span style="color: #cea2ca;">import os</span>
<span style="color: #cea2ca;">import shutil</span>
<span style="color: #cea2ca;">import re</span>
<span style="color: #cea2ca;">import random</span>
<span style="color: #cea2ca;">import json</span>
<span style="color: #cea2ca;">import zipfile</span>
<span style="color: #cea2ca;">import tempfile</span>
<span style="color: #cea2ca;">from copy import deepcopy</span>
<span style="color: #cea2ca;">from collections import OrderedDict</span>


<span style="color: #cea2ca;">MW_DOMAINS = {MW_DOMAINS}</span>


<span style="color: #cea2ca;">{inspect.getsource(load_databases)}</span>

<span style="color: #cea2ca;">{inspect.getsource(Database)}"""</span>
    <span style="color: #49bdb0;">with</span> zipf.<span style="color: #53E6B5;">open</span><span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'database.py'</span>, <span style="color: #cea2ca;">'w'</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">as</span> f:
        f.write<span style="color: #4d9391;">(</span>source_code.encode<span style="color: #47ba99;">(</span><span style="color: #cea2ca;">'utf-8'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
        f.flush<span style="color: #4d9391;">()</span>


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">download_file</span><span style="color: #4d9391;">(</span>source_url, dest<span style="color: #4d9391;">)</span>:
    response = requests.get<span style="color: #4d9391;">(</span>source_url, stream=<span style="color: #ef6787;">True</span>, timeout=5<span style="color: #4d9391;">)</span>
    response.raise_for_status<span style="color: #4d9391;">()</span>
    file_size = <span style="color: #53E6B5;">int</span><span style="color: #4d9391;">(</span>response.headers.get<span style="color: #47ba99;">(</span><span style="color: #cea2ca;">'content-length'</span>, 0<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
    zipf = <span style="color: #ef6787;">None</span>
    <span style="color: #49bdb0;">if</span> <span style="color: #53E6B5;">isinstance</span><span style="color: #4d9391;">(</span>dest, <span style="color: #53E6B5;">tuple</span><span style="color: #4d9391;">)</span>:
        zipf, dest_path = dest
    <span style="color: #49bdb0;">else</span>:
        dest_path = dest
        <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">"/"</span> <span style="color: #49bdb0;">in</span> dest_path:
            <span style="color: #53E6B5;">dir</span> = <span style="color: #cea2ca;">"/"</span>.join<span style="color: #4d9391;">(</span>dest_path.split<span style="color: #47ba99;">(</span><span style="color: #cea2ca;">"/"</span><span style="color: #47ba99;">)[</span>0:-1<span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
            os.makedirs<span style="color: #4d9391;">(</span><span style="color: #53E6B5;">dir</span>, exist_ok=<span style="color: #ef6787;">True</span><span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">if</span> os.path.exists<span style="color: #4d9391;">(</span>dest_path<span style="color: #4d9391;">)</span>:
            <span style="color: #49bdb0;">return</span>

    pbar = tqdm<span style="color: #4d9391;">(</span>
        total=file_size, unit=<span style="color: #cea2ca;">'B'</span>, disable=file_size &lt; 1024**2,
        unit_scale=<span style="color: #ef6787;">True</span>, desc=source_url.split<span style="color: #47ba99;">(</span><span style="color: #cea2ca;">'/'</span><span style="color: #47ba99;">)[</span>-1<span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>

    <span style="color: #49bdb0;">with</span> tempfile.TemporaryFile<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'rb+'</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">as</span> <span style="color: #53E6B5;">file</span>:
        <span style="color: #49bdb0;">for</span> data <span style="color: #49bdb0;">in</span> response.iter_content<span style="color: #4d9391;">(</span>chunk_size=1024<span style="color: #4d9391;">)</span>:
            <span style="color: #53E6B5;">file</span>.write<span style="color: #4d9391;">(</span>data<span style="color: #4d9391;">)</span>
            pbar.update<span style="color: #4d9391;">(</span>1024<span style="color: #4d9391;">)</span>
        <span style="color: #53E6B5;">file</span>.flush<span style="color: #4d9391;">()</span>
        <span style="color: #53E6B5;">file</span>.seek<span style="color: #4d9391;">(</span>0<span style="color: #4d9391;">)</span>
        pbar.close<span style="color: #4d9391;">()</span>
        <span style="color: #49bdb0;">if</span> zipf <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
            <span style="color: #49bdb0;">with</span> zipf.<span style="color: #53E6B5;">open</span><span style="color: #4d9391;">(</span>dest_path, <span style="color: #cea2ca;">'w'</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">as</span> f:
                shutil.copyfileobj<span style="color: #4d9391;">(</span><span style="color: #53E6B5;">file</span>, f<span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">else</span>:
            <span style="color: #49bdb0;">with</span> <span style="color: #53E6B5;">open</span><span style="color: #4d9391;">(</span>dest_path, <span style="color: #cea2ca;">'wb+'</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">as</span> f:
                shutil.copyfileobj<span style="color: #4d9391;">(</span><span style="color: #53E6B5;">file</span>, f<span style="color: #4d9391;">)</span>


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">export_lexicalizer_source</span><span style="color: #4d9391;">(</span>path<span style="color: #4d9391;">)</span>:
    source_code = f<span style="color: #cea2ca;">"""from collections import defaultdict, OrderedDict</span>
<span style="color: #cea2ca;">import os</span>
<span style="color: #cea2ca;">import shutil</span>
<span style="color: #cea2ca;">import re</span>


<span style="color: #cea2ca;">{inspect.getsource(Lexicalizer)}"""</span>
    <span style="color: #49bdb0;">with</span> zipfile.ZipFile<span style="color: #4d9391;">(</span>os.path.join<span style="color: #47ba99;">(</span>path, <span style="color: #cea2ca;">'lexicalizer.zip'</span><span style="color: #47ba99;">)</span>, <span style="color: #cea2ca;">'w'</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">as</span> zipf:
        <span style="color: #49bdb0;">with</span> zipf.<span style="color: #53E6B5;">open</span><span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'lexicalizer.py'</span>, <span style="color: #cea2ca;">'w'</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">as</span> f:
            f.write<span style="color: #4d9391;">(</span>source_code.encode<span style="color: #47ba99;">(</span><span style="color: #cea2ca;">'utf-8'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
            f.flush<span style="color: #4d9391;">()</span>


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">extract_databases</span><span style="color: #4d9391;">(</span>path, dbzipf, multiwoz_sha<span style="color: #4d9391;">)</span>:
    <span style="color: #49bdb0;">with</span> zipfile.ZipFile<span style="color: #4d9391;">(</span>os.path.join<span style="color: #47ba99;">(</span>path, <span style="color: #cea2ca;">'database.zip'</span><span style="color: #47ba99;">)</span>, <span style="color: #cea2ca;">'w'</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">as</span> dboutf:
        <span style="color: #49bdb0;">for</span> domain <span style="color: #49bdb0;">in</span> MW_DOMAINS<span style="color: #4d9391;">[</span>:-1<span style="color: #4d9391;">]</span>:
            db = f<span style="color: #cea2ca;">'multiwoz-</span>{multiwoz_sha}<span style="color: #cea2ca;">/db/</span>{domain}<span style="color: #cea2ca;">-dbase.db'</span>
            <span style="color: #49bdb0;">with</span> dbzipf.<span style="color: #53E6B5;">open</span><span style="color: #4d9391;">(</span>db<span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">as</span> zf, dboutf.<span style="color: #53E6B5;">open</span><span style="color: #4d9391;">(</span>os.path.join<span style="color: #47ba99;">(</span><span style="color: #cea2ca;">'db'</span>, f<span style="color: #cea2ca;">'</span>{domain}<span style="color: #cea2ca;">-dbase.db'</span><span style="color: #47ba99;">)</span>, <span style="color: #cea2ca;">'w'</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">as</span> f:
                shutil.copyfileobj<span style="color: #4d9391;">(</span>zf, f<span style="color: #4d9391;">)</span>

        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Fix json databases</span>
        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Download from convlab2</span>
        <span style="color: #49bdb0;">for</span> domain <span style="color: #49bdb0;">in</span> MW_DOMAINS:
            download_file<span style="color: #4d9391;">(</span>
                    f<span style="color: #cea2ca;">'https://raw.githubusercontent.com/thu-coai/ConvLab-2/b82732eae951b3dc957136f40b992a1904c9cbe5/data/multiwoz/db/</span>{domain}<span style="color: #cea2ca;">_db.json'</span>,  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">noqa: E501</span>
                    <span style="color: #47ba99;">(</span>dboutf, os.path.join<span style="color: #9d81ba;">(</span><span style="color: #cea2ca;">'db'</span>, f<span style="color: #cea2ca;">'</span>{domain}<span style="color: #cea2ca;">_db.json'</span><span style="color: #9d81ba;">)</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>

        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Export database source</span>
        export_database_source<span style="color: #4d9391;">(</span>dboutf<span style="color: #4d9391;">)</span>


<span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">download</span><span style="color: #4d9391;">(</span>version=<span style="color: #cea2ca;">'2.0'</span><span style="color: #4d9391;">)</span>:
    path = os.path.join<span style="color: #4d9391;">(</span>DATASETS_PATH, f<span style="color: #cea2ca;">'multiwoz-</span>{version}<span style="color: #cea2ca;">'</span><span style="color: #4d9391;">)</span>
    multiwoz_sha = <span style="color: #cea2ca;">'a24d299fafa00371d03880bce34cb3b0923518fa'</span>
    os.makedirs<span style="color: #4d9391;">(</span>path, exist_ok=<span style="color: #ef6787;">True</span><span style="color: #4d9391;">)</span>
    download_file<span style="color: #4d9391;">(</span>
        f<span style="color: #cea2ca;">'https://github.com/budzianowski/multiwoz/raw/</span>{multiwoz_sha}<span style="color: #cea2ca;">/data/MultiWOZ_</span>{version}<span style="color: #cea2ca;">.zip'</span>,
        os.path.join<span style="color: #47ba99;">(</span>path, <span style="color: #cea2ca;">'original.zip'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
    download_file<span style="color: #4d9391;">(</span>
        f<span style="color: #cea2ca;">'https://github.com/budzianowski/multiwoz/archive/</span>{multiwoz_sha}<span style="color: #cea2ca;">.zip'</span>,
        os.path.join<span style="color: #47ba99;">(</span>path, <span style="color: #cea2ca;">'repo.zip'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>

    <span style="color: #49bdb0;">with</span> zipfile.ZipFile<span style="color: #4d9391;">(</span>os.path.join<span style="color: #47ba99;">(</span>path, <span style="color: #cea2ca;">'original.zip'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">as</span> zipf, \
            zipfile.ZipFile<span style="color: #4d9391;">(</span>os.path.join<span style="color: #47ba99;">(</span>path, <span style="color: #cea2ca;">'repo.zip'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">as</span> dbzipf:
        export_lexicalizer_source<span style="color: #4d9391;">(</span>path<span style="color: #4d9391;">)</span>
        extract_databases<span style="color: #4d9391;">(</span>path, dbzipf, multiwoz_sha<span style="color: #4d9391;">)</span>
        delex_data = createDelexData<span style="color: #4d9391;">(</span>zipf, path<span style="color: #4d9391;">)</span>
        divideData<span style="color: #4d9391;">(</span>delex_data, zipf, path<span style="color: #4d9391;">)</span>

    <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Generating blacklist</span>
    logger.info<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'generating blacklist'</span><span style="color: #4d9391;">)</span>
    cwd = os.path.dirname<span style="color: #4d9391;">(</span>os.path.abspath<span style="color: #47ba99;">(</span>__file__<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
    subprocess.run<span style="color: #4d9391;">(</span><span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'python'</span>, os.path.join<span style="color: #9d81ba;">(</span>cwd, <span style="color: #cea2ca;">'build_multiwoz_blacklist.py'</span><span style="color: #9d81ba;">)</span>, <span style="color: #cea2ca;">'--dataset'</span>, <span style="color: #cea2ca;">'multiwoz-2.0'</span><span style="color: #47ba99;">]</span>, cwd=cwd<span style="color: #4d9391;">)</span>


<span style="color: #49bdb0;">if</span> <span style="color: #53E6B5;">__name__</span> == <span style="color: #cea2ca;">"__main__"</span>:
    download<span style="color: #4d9391;">()</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1c75e7f" class="outline-4">
<h4 id="org1c75e7f"><span class="section-number-4">2.4.2.</span> TOD的层级结构以及各个常见的数据对象</h4>
<div class="outline-text-4" id="text-2-4-2">
<p>
对话系统的最小单元, 应该是什么? 是一个组件吗? 不, 组件是不统一的,多个组件才能形成一次输入. 那么是一个对话吗? 当然也不是,因为一个对话包含了多个轮. 对的, 对话系统的基本单元,是轮. 对话系统是以轮为单位进行展示的. 我们的每次训练, 所传入的每一条数据,都是1轮数据整理成了一条线状的输入.
假如全局对话如下:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #49bdb0;">class</span> <span style="color: #eed891;">DialogueItems</span>:
    @<span style="color: #53E6B5;">staticmethod</span>
    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">cumsum</span><span style="color: #4d9391;">(</span>sequence<span style="color: #4d9391;">)</span>:
        <span style="color: #ef6787;">r</span>, <span style="color: #ef6787;">s</span> = <span style="color: #4d9391;">[]</span>, 0
        <span style="color: #49bdb0;">for</span> e <span style="color: #49bdb0;">in</span> sequence:
            r.append<span style="color: #4d9391;">(</span>e + s<span style="color: #4d9391;">)</span>
            <span style="color: #ef6787;">s</span> += e
        <span style="color: #49bdb0;">return</span> r

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__init__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, dialogues<span style="color: #4d9391;">)</span>:

        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">length list, every elemnt is the length of one dialogue</span>
        <span style="color: #ef6787;">lengths</span> = <span style="color: #4d9391;">[</span><span style="color: #53E6B5;">len</span><span style="color: #47ba99;">(</span>x<span style="color: #9d81ba;">[</span><span style="color: #cea2ca;">'items'</span><span style="color: #9d81ba;">]</span><span style="color: #47ba99;">)</span> <span style="color: #49bdb0;">for</span> x <span style="color: #49bdb0;">in</span> dialogues<span style="color: #4d9391;">]</span> 

        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">cumulative length list, every elemnt is the cumulative length of one dialogue</span>
        <span style="color: #49bdb0;">self</span>.<span style="color: #ef6787;">cumulative_sizes</span> = DialogueItems.cumsum<span style="color: #4d9391;">(</span>lengths<span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">self</span>.<span style="color: #ef6787;">dialogues</span> = dialogues

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__getitem__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, idx<span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">if</span> idx &lt; 0:
            <span style="color: #49bdb0;">if</span> -idx &gt; <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span><span style="color: #4d9391;">)</span>:
                <span style="color: #49bdb0;">raise</span> <span style="color: #eed891;">ValueError</span><span style="color: #4d9391;">(</span><span style="color: #cea2ca;">"absolute value of index should not exceed dataset length"</span><span style="color: #4d9391;">)</span>
            <span style="color: #ef6787;">idx</span> = <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span><span style="color: #4d9391;">)</span> + idx


        <span style="color: #ef6787;">dialogue_idx</span> = bisect.bisect_right<span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>.cumulative_sizes, idx<span style="color: #4d9391;">)</span>

        <span style="color: #49bdb0;">if</span> dialogue_idx == 0:
            sample_idx = idx
        <span style="color: #49bdb0;">else</span>:
            sample_idx = idx - <span style="color: #49bdb0;">self</span>.cumulative_sizes<span style="color: #4d9391;">[</span>dialogue_idx - 1<span style="color: #4d9391;">]</span>

        <span style="color: #635C4A;">## </span><span style="color: #635C4A;">dialogues needed; the index of sentences in this per_dialogues.</span>
        <span style="color: #49bdb0;">return</span> <span style="color: #49bdb0;">self</span>.dialogues<span style="color: #4d9391;">[</span>dialogue_idx<span style="color: #4d9391;">]</span>, <span style="color: #49bdb0;">self</span>.dialogues<span style="color: #4d9391;">[</span>dialogue_idx<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'items'</span><span style="color: #4d9391;">][</span>:sample_idx + 1<span style="color: #4d9391;">]</span>

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__len__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span><span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">if</span> <span style="color: #49bdb0;">not</span> <span style="color: #49bdb0;">self</span>.cumulative_sizes:
            <span style="color: #49bdb0;">return</span> 0
        <span style="color: #49bdb0;">return</span> <span style="color: #49bdb0;">self</span>.cumulative_sizes<span style="color: #4d9391;">[</span>-1<span style="color: #4d9391;">]</span>
</pre>
</div>
<p>
其中, <code>self.cumulative_sizes</code> 是一个列表, 列表里的每一个元素(经由cumsum计算而得)都是从一开始到现在所经历的对话轮数.
而这个函数本质上是一个dataset对象,给定一个turn的index, 他就会找到这个turn index对应的对话和从一开始一直到那一轮的片段对话, 将二者一同返回.
</p>

<p>
如此一来,我们可以意识到他是以turn为单位了.但我们对以上函数还不是特别清晰,因为我们不知道上述init函数的输入参数, 这个dialogues到底是什么. 其实这个dialogues是读取数据集json文件所获得的初始的dialogue, 所以说, 上述类的设计还不是最终的结果. 实际上,他是被当作了下一个类的输入,即下一个类中的items.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #eed891;">@dataclass</span>
<span style="color: #49bdb0;">class</span> <span style="color: #eed891;">DialogDataset</span><span style="color: #4d9391;">(</span>torch.utils.data.Dataset<span style="color: #4d9391;">)</span>:
    <span style="color: #ef6787;">items</span>: List<span style="color: #4d9391;">[</span><span style="color: #53E6B5;">any</span><span style="color: #4d9391;">]</span>
    database: Any = <span style="color: #ef6787;">None</span>
    <span style="color: #ef6787;">domains</span>: List<span style="color: #4d9391;">[</span><span style="color: #53E6B5;">str</span><span style="color: #4d9391;">]</span> = <span style="color: #ef6787;">None</span>
    <span style="color: #ef6787;">lexicalizer</span>: Any = <span style="color: #ef6787;">None</span>
    <span style="color: #ef6787;">transform</span>: <span style="color: #ef6787;">Callable</span><span style="color: #4d9391;">[</span><span style="color: #47ba99;">[</span><span style="color: #ef6787;">Any</span><span style="color: #47ba99;">]</span>, <span style="color: #ef6787;">Any</span><span style="color: #4d9391;">]</span> = <span style="color: #ef6787;">None</span>
    <span style="color: #ef6787;">normalize_input</span>: <span style="color: #ef6787;">Callable</span><span style="color: #4d9391;">[</span><span style="color: #47ba99;">[</span><span style="color: #53E6B5;">str</span><span style="color: #47ba99;">]</span>, <span style="color: #53E6B5;">str</span><span style="color: #4d9391;">]</span> = <span style="color: #ef6787;">None</span>
    <span style="color: #ef6787;">ontology</span>: <span style="color: #ef6787;">Dict</span><span style="color: #4d9391;">[</span><span style="color: #ef6787;">Tuple</span><span style="color: #47ba99;">[</span><span style="color: #53E6B5;">str</span>, <span style="color: #53E6B5;">str</span><span style="color: #47ba99;">]</span>, <span style="color: #ef6787;">Set</span><span style="color: #47ba99;">[</span><span style="color: #53E6B5;">str</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">]</span> = <span style="color: #ef6787;">None</span>

    @<span style="color: #53E6B5;">staticmethod</span>
    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">build_dataset_without_database</span><span style="color: #4d9391;">(</span>items, *args, **kwargs<span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">return</span> DialogDataset<span style="color: #4d9391;">(</span>items, FakeDatabase<span style="color: #47ba99;">()</span>, *args, **kwargs<span style="color: #4d9391;">)</span>

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__getitem__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, index<span style="color: #4d9391;">)</span>:
        <span style="color: #ef6787;">item</span> = <span style="color: #49bdb0;">self</span>.items<span style="color: #4d9391;">[</span>index<span style="color: #4d9391;">]</span>
        <span style="color: #49bdb0;">if</span> <span style="color: #49bdb0;">self</span>.transform <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
            item = <span style="color: #49bdb0;">self</span>.transform<span style="color: #4d9391;">(</span>item<span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">return</span> item

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__len__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span><span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">return</span> <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>.items<span style="color: #4d9391;">)</span>

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">map</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, transformation<span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">trans</span><span style="color: #4d9391;">(</span>x<span style="color: #4d9391;">)</span>:
            <span style="color: #ef6787;">x</span> = <span style="color: #49bdb0;">self</span>.transform<span style="color: #4d9391;">(</span>x<span style="color: #4d9391;">)</span>
            <span style="color: #ef6787;">x</span> = transformation<span style="color: #4d9391;">(</span>x<span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">return</span> x
        <span style="color: #49bdb0;">return</span> dataclasses.replace<span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, transform=trans<span style="color: #4d9391;">)</span>

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">finish</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, progressbar: Union<span style="color: #47ba99;">[</span><span style="color: #53E6B5;">str</span>, <span style="color: #53E6B5;">bool</span><span style="color: #47ba99;">]</span> = <span style="color: #ef6787;">False</span><span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">if</span> <span style="color: #49bdb0;">self</span>.transform <span style="color: #49bdb0;">is</span> <span style="color: #ef6787;">None</span>:
            <span style="color: #49bdb0;">return</span> <span style="color: #49bdb0;">self</span>

        ontology = defaultdict<span style="color: #4d9391;">(</span><span style="color: #49bdb0;">lambda</span>: <span style="color: #53E6B5;">set</span><span style="color: #47ba99;">()</span><span style="color: #4d9391;">)</span>
        domains = <span style="color: #53E6B5;">set</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>.domains<span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">if</span> <span style="color: #49bdb0;">self</span>.domains <span style="color: #49bdb0;">else</span> <span style="color: #53E6B5;">set</span><span style="color: #4d9391;">()</span>

        items = <span style="color: #4d9391;">[]</span>
        <span style="color: #49bdb0;">for</span> i <span style="color: #49bdb0;">in</span> trange<span style="color: #4d9391;">(</span><span style="color: #53E6B5;">len</span><span style="color: #47ba99;">(</span><span style="color: #49bdb0;">self</span><span style="color: #47ba99;">)</span>,
                        desc=progressbar <span style="color: #49bdb0;">if</span> <span style="color: #53E6B5;">isinstance</span><span style="color: #47ba99;">(</span>progressbar, <span style="color: #53E6B5;">str</span><span style="color: #47ba99;">)</span> <span style="color: #49bdb0;">else</span> <span style="color: #cea2ca;">'loading dataset'</span>,
                        disable=<span style="color: #49bdb0;">not</span> progressbar<span style="color: #4d9391;">)</span>:
            item = <span style="color: #49bdb0;">self</span><span style="color: #4d9391;">[</span>i<span style="color: #4d9391;">]</span>
            <span style="color: #49bdb0;">for</span> k, bs <span style="color: #49bdb0;">in</span> item.raw_belief.items<span style="color: #4d9391;">()</span>:
                domains.add<span style="color: #4d9391;">(</span>k<span style="color: #4d9391;">)</span>
                <span style="color: #49bdb0;">for</span> k2, val <span style="color: #49bdb0;">in</span> bs.items<span style="color: #4d9391;">()</span>:
                    ontology<span style="color: #4d9391;">[</span><span style="color: #47ba99;">(</span>k, k2<span style="color: #47ba99;">)</span><span style="color: #4d9391;">]</span>.add<span style="color: #4d9391;">(</span>val<span style="color: #4d9391;">)</span>
            items.append<span style="color: #4d9391;">(</span>item<span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">if</span> <span style="color: #49bdb0;">self</span>.ontology:
            ontology = merge_ontologies<span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span><span style="color: #49bdb0;">self</span>.ontology, ontology<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">return</span> dataclasses.replace<span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, items=items, transform=<span style="color: #ef6787;">None</span>, domains=domains, ontology=ontology<span style="color: #4d9391;">)</span>

</pre>
</div>

<p>
然后我们就看见了下一个类的函数, 我们首先注意到他是pytorch的官方Dataset类的子类了. 但我们又注意到, 这个官方类很喜欢进行transformation. 这其实是CV里用的比较多的写法, 我们注意到主要有两处,一处是 <code>getitem</code> 函数中, 这个transform主要用于解析和当前turn(即1个item)有关的信息,然后返回1个结构体.下面先给出transform的函数形式:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">transform</span><span style="color: #4d9391;">(</span>x<span style="color: #4d9391;">)</span>:
    <span style="color: #ef6787;">dialogue</span>, <span style="color: #ef6787;">items</span> = x
    <span style="color: #ef6787;">context</span> = <span style="color: #4d9391;">[</span>s<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'text'</span><span style="color: #47ba99;">]</span> <span style="color: #49bdb0;">for</span> s <span style="color: #49bdb0;">in</span> items<span style="color: #47ba99;">[</span>:-1<span style="color: #47ba99;">]</span><span style="color: #4d9391;">]</span>
    <span style="color: #49bdb0;">if</span> context_window_size <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span> <span style="color: #49bdb0;">and</span> context_window_size &gt; 0:
        <span style="color: #ef6787;">context</span> = context<span style="color: #4d9391;">[</span>-<span style="color: #ef6787;">context_window_size</span>:<span style="color: #4d9391;">]</span>
    belief = items<span style="color: #4d9391;">[</span>-1<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'belief'</span><span style="color: #4d9391;">]</span>
    <span style="color: #ef6787;">database</span> = items<span style="color: #4d9391;">[</span>-1<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'database'</span><span style="color: #4d9391;">]</span>
    <span style="color: #ef6787;">dialogue_act</span>=items<span style="color: #4d9391;">[</span>-1<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">"dialogue_act"</span><span style="color: #4d9391;">]</span>

    <span style="color: #ef6787;">item</span> = DialogDatasetItem<span style="color: #4d9391;">(</span>context,
                          raw_belief=belief,
                          raw_dialogue_act=dialogue_act,
                          database=database,
                  response=items<span style="color: #47ba99;">[</span>-1<span style="color: #47ba99;">][</span><span style="color: #cea2ca;">'delexicalised_text'</span><span style="color: #47ba99;">]</span>,
                          raw_response=items<span style="color: #47ba99;">[</span>-1<span style="color: #47ba99;">][</span><span style="color: #cea2ca;">'text'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
  <span style="color: #49bdb0;">return</span> item
</pre>
</div>

<p>
此处所涉及到的这个类, 其实是下面的这样形式的1个对象:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #eed891;">@dataclass</span>
<span style="color: #49bdb0;">class</span> <span style="color: #eed891;">DialogDatasetItem</span>:
    context: Union<span style="color: #4d9391;">[</span>List<span style="color: #47ba99;">[</span><span style="color: #53E6B5;">str</span><span style="color: #47ba99;">]</span>, <span style="color: #53E6B5;">str</span><span style="color: #4d9391;">]</span>
    belief: Union<span style="color: #4d9391;">[</span>Dict<span style="color: #47ba99;">[</span><span style="color: #53E6B5;">str</span>, Dict<span style="color: #9d81ba;">[</span><span style="color: #53E6B5;">str</span>, <span style="color: #53E6B5;">str</span><span style="color: #9d81ba;">]</span><span style="color: #47ba99;">]</span>, <span style="color: #53E6B5;">str</span><span style="color: #4d9391;">]</span> = <span style="color: #ef6787;">None</span>
    <span style="color: #ef6787;">database</span>: Union<span style="color: #4d9391;">[</span>List<span style="color: #47ba99;">[</span>Tuple<span style="color: #9d81ba;">[</span><span style="color: #53E6B5;">str</span>, <span style="color: #53E6B5;">int</span><span style="color: #9d81ba;">]</span><span style="color: #47ba99;">]</span>, List<span style="color: #47ba99;">[</span>Tuple<span style="color: #9d81ba;">[</span><span style="color: #53E6B5;">str</span>, <span style="color: #53E6B5;">int</span>, Any<span style="color: #9d81ba;">]</span><span style="color: #47ba99;">]</span>, <span style="color: #ef6787;">None</span>, <span style="color: #53E6B5;">str</span><span style="color: #4d9391;">]</span> = <span style="color: #ef6787;">None</span>
    <span style="color: #ef6787;">response</span>: <span style="color: #53E6B5;">str</span> = <span style="color: #ef6787;">None</span>
    <span style="color: #ef6787;">positive</span>: <span style="color: #53E6B5;">bool</span> = <span style="color: #ef6787;">True</span>
    <span style="color: #ef6787;">raw_belief</span>: Any = <span style="color: #ef6787;">None</span>
    <span style="color: #ef6787;">raw_response</span>: <span style="color: #53E6B5;">str</span> = <span style="color: #ef6787;">None</span>

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__getattribute__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, name<span style="color: #4d9391;">)</span>:
        <span style="color: #ef6787;">val</span> = <span style="color: #53E6B5;">object</span>.__getattribute__<span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, name<span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">if</span> name == <span style="color: #cea2ca;">'belief'</span> <span style="color: #49bdb0;">and</span> val <span style="color: #49bdb0;">is</span> <span style="color: #ef6787;">None</span> <span style="color: #49bdb0;">and</span> <span style="color: #49bdb0;">self</span>.raw_belief <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
            val = format_belief<span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>.raw_belief<span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">self</span>.belief = val

        <span style="color: #49bdb0;">return</span> val
</pre>
</div>


<p>
如此一来,可以说, 所有的结构体就算是结束了.
</p>
</div>
</div>
<div id="outline-container-org2bd83c5" class="outline-4">
<h4 id="org2bd83c5"><span class="section-number-4">2.4.3.</span> 如何解析tod数据集?</h4>
<div class="outline-text-4" id="text-2-4-3">
<p>
该源码直接基于名字加载数据集,如下面函数所示 <code>loader.py -&gt; load_dataset</code>
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">load_dataset</span><span style="color: #4d9391;">(</span>name, restrict_domains=<span style="color: #ef6787;">False</span>, augment=<span style="color: #cea2ca;">'disabled'</span>, use_blacklist=<span style="color: #ef6787;">False</span>, **kwargs<span style="color: #4d9391;">)</span>:
    <span style="color: #49bdb0;">if</span> restrict_domains:
        <span style="color: #49bdb0;">return</span> load_dataset<span style="color: #4d9391;">(</span>name, domains=RESTRICTED_DOMAINS, **kwargs<span style="color: #4d9391;">)</span>

    <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'+'</span> <span style="color: #49bdb0;">in</span> name:
        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">This is a concat dataset</span>
        datasets = name.split<span style="color: #4d9391;">(</span><span style="color: #cea2ca;">'+'</span><span style="color: #4d9391;">)</span>
        _load_dataset = functools.partial<span style="color: #4d9391;">(</span>load_dataset, **kwargs<span style="color: #4d9391;">)</span>
        datasets = <span style="color: #53E6B5;">list</span><span style="color: #4d9391;">(</span><span style="color: #53E6B5;">map</span><span style="color: #47ba99;">(</span>_load_dataset, datasets<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">return</span> ConcatDialogDataset<span style="color: #4d9391;">(</span>datasets<span style="color: #4d9391;">)</span>

    dataset_name, split = split_name<span style="color: #4d9391;">(</span>name<span style="color: #4d9391;">)</span>

    <span style="color: #49bdb0;">from</span> data.dataset <span style="color: #49bdb0;">import</span> load_dataset <span style="color: #49bdb0;">as</span> load_custom_dataset
    dataset = load_custom_dataset<span style="color: #4d9391;">(</span>name, **kwargs<span style="color: #4d9391;">)</span>

    <span style="color: #49bdb0;">if</span> use_blacklist:
        dataset = add_blacklist<span style="color: #4d9391;">(</span>dataset, name<span style="color: #4d9391;">)</span>
    <span style="color: #49bdb0;">return</span> dataset
</pre>
</div>

<p>
其实这里面并没有加载什么数据集!真正的加载数据集的操作被写进了 <code>dataset.py -&gt; load_dataset</code> 里面. 不是很理解作者的脑回路&#x2026;&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">load_dataset</span><span style="color: #4d9391;">(</span>name, use_goal=<span style="color: #ef6787;">False</span>,have_template=<span style="color: #ef6787;">False</span>,
                 context_window_size=15, domains=<span style="color: #ef6787;">None</span>,
                 **kwargs<span style="color: #4d9391;">)</span> -&gt; DialogDataset:
    name, split = split_name<span style="color: #4d9391;">(</span>name<span style="color: #4d9391;">)</span>
    path = os.path.join<span style="color: #4d9391;">(</span>DATASETS_PATH, name<span style="color: #4d9391;">)</span>
    <span style="color: #49bdb0;">with</span> <span style="color: #53E6B5;">open</span><span style="color: #4d9391;">(</span>os.path.join<span style="color: #47ba99;">(</span>path, f<span style="color: #cea2ca;">'</span>{split}<span style="color: #cea2ca;">.json'</span><span style="color: #47ba99;">)</span>, <span style="color: #cea2ca;">'r'</span><span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">as</span> f:
        data = json.load<span style="color: #4d9391;">(</span>f, object_pairs_hook=OrderedDict<span style="color: #4d9391;">)</span>
    dialogues = data<span style="color: #4d9391;">[</span><span style="color: #cea2ca;">'dialogues'</span><span style="color: #4d9391;">]</span> <span style="color: #635C4A;"># </span><span style="color: #635C4A;">load data done.</span>
    items = DialogueItems<span style="color: #4d9391;">(</span>dialogues<span style="color: #4d9391;">)</span> <span style="color: #635C4A;"># </span><span style="color: #635C4A;">???</span>
    items = BlacklistItemsWrapper<span style="color: #4d9391;">(</span>items, <span style="color: #53E6B5;">list</span><span style="color: #47ba99;">(</span>build_blacklist<span style="color: #9d81ba;">(</span>items, domains<span style="color: #9d81ba;">)</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">transform</span><span style="color: #4d9391;">(</span>x<span style="color: #4d9391;">)</span>:
        dialogue, items = x
        context = <span style="color: #4d9391;">[</span>s<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'text'</span><span style="color: #47ba99;">]</span> <span style="color: #49bdb0;">for</span> s <span style="color: #49bdb0;">in</span> items<span style="color: #47ba99;">[</span>:-1<span style="color: #47ba99;">]</span><span style="color: #4d9391;">]</span>
        <span style="color: #49bdb0;">if</span> context_window_size <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span> <span style="color: #49bdb0;">and</span> context_window_size &gt; 0:
            context = context<span style="color: #4d9391;">[</span>-context_window_size:<span style="color: #4d9391;">]</span>
        belief = items<span style="color: #4d9391;">[</span>-1<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'belief'</span><span style="color: #4d9391;">]</span>
        database = items<span style="color: #4d9391;">[</span>-1<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">'database'</span><span style="color: #4d9391;">]</span>
        dialogue_act=items<span style="color: #4d9391;">[</span>-1<span style="color: #4d9391;">][</span><span style="color: #cea2ca;">"dialogue_act"</span><span style="color: #4d9391;">]</span>

        item = DialogDatasetItem<span style="color: #4d9391;">(</span>context,
                              raw_belief=belief,
                              raw_dialogue_act=dialogue_act,
                              database=database,
                      response=items<span style="color: #47ba99;">[</span>-1<span style="color: #47ba99;">][</span><span style="color: #cea2ca;">'delexicalised_text'</span><span style="color: #47ba99;">]</span>,
                              raw_response=items<span style="color: #47ba99;">[</span>-1<span style="color: #47ba99;">][</span><span style="color: #cea2ca;">'text'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>

        <span style="color: #49bdb0;">if</span> use_goal:
            <span style="color: #53E6B5;">setattr</span><span style="color: #4d9391;">(</span>item, <span style="color: #cea2ca;">'goal'</span>, dialogue<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'goal'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">MultiWOZ evaluation uses booked domains property</span>
            <span style="color: #49bdb0;">if</span> <span style="color: #cea2ca;">'booked_domains'</span> <span style="color: #49bdb0;">in</span> items<span style="color: #4d9391;">[</span>-1<span style="color: #4d9391;">]</span>:
                <span style="color: #53E6B5;">setattr</span><span style="color: #4d9391;">(</span>item, <span style="color: #cea2ca;">'booked_domains'</span>, items<span style="color: #47ba99;">[</span>-1<span style="color: #47ba99;">][</span><span style="color: #cea2ca;">'booked_domains'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
            <span style="color: #53E6B5;">setattr</span><span style="color: #4d9391;">(</span>item, <span style="color: #cea2ca;">'dialogue_act'</span>, items<span style="color: #47ba99;">[</span>-1<span style="color: #47ba99;">][</span><span style="color: #cea2ca;">'dialogue_act'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
        <span style="color: #53E6B5;">setattr</span><span style="color: #4d9391;">(</span>item, <span style="color: #cea2ca;">'active_domain'</span>, items<span style="color: #47ba99;">[</span>-1<span style="color: #47ba99;">][</span><span style="color: #cea2ca;">'active_domain'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">return</span> item

    dataset = DialogDataset<span style="color: #4d9391;">(</span>items, transform=transform, domains=data<span style="color: #47ba99;">[</span><span style="color: #cea2ca;">'domains'</span><span style="color: #47ba99;">]</span><span style="color: #4d9391;">)</span>
    <span style="color: #49bdb0;">if</span> os.path.exists<span style="color: #4d9391;">(</span>os.path.join<span style="color: #47ba99;">(</span>path, <span style="color: #cea2ca;">'database.zip'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>:
        dataset.database = AutoDatabase.load<span style="color: #4d9391;">(</span>path<span style="color: #4d9391;">)</span>

    <span style="color: #49bdb0;">if</span> os.path.exists<span style="color: #4d9391;">(</span>os.path.join<span style="color: #47ba99;">(</span>path, <span style="color: #cea2ca;">'lexicalizer.zip'</span><span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>:
        dataset.lexicalizer = AutoLexicalizer.load<span style="color: #4d9391;">(</span>path<span style="color: #4d9391;">)</span>

    <span style="color: #49bdb0;">return</span> dataset
</pre>
</div>

<p>
这里就是解析数据集的关键了. 这个代码看起来有一些的复杂, 主要包括以下步骤:
</p>
<ol class="org-ol">
<li>首先, 基于一个数据集的名字, 经过一些变换得到数据集的路径,并且加载得到数据集.</li>
<li>之后, 加载数据集并进行解析操作. 数据集一共经历了三层封装.: 不得不说,这个写法也是有点绕的. 在进行数据的解析过程中,最值得关注的点,其实还是那个transform函数.根据源码可知,这个transform函数被作用在了每一个item上,而每一个item就是一个 <code>DialogueItems</code> 列表中的一个元素,所以其实就是说: 被进行transform的,其实就是这个对话,和对话的前n行. 然后这个transform最终的目标,或者transform的返回值, 则是一个 <code>DialogueDatasetItem</code> 对象,亦即是最终会被用来作为输入的一个batch单元.</li>
</ol>


<p>
换而言之, 上述各类的整体流程是: <code>DialogueItems</code> -&gt; <code>DialogDataset</code> -&gt; <code>DialogeDatasetItem</code>. 我是不理解为什么这个名字起的为什么这么没有分辨性,甚至我怀疑定义这么多class的重要性在哪里.
</p>

<p>
总之通过这种方式, 我们得到了1 标准的pytorch Dataset, 其返回的每条数据是一个DialogueDatasetItem, 但是竟然这个代码又进行了一次映射. 如下所示:
</p>

<p>
值得注意的是, 我们的DialogDataset, 在这里就是inner. 你会发现这里又出现了新的transform, 这个transform就是在前面所提及的transform了,也就是 <code>InsertLabelstransformation</code> 和 <code>TokenizerTransformation</code> 的组合.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #49bdb0;">class</span> <span style="color: #eed891;">NegativeSamplingDatasetWrapper</span><span style="color: #4d9391;">(</span>torch.utils.data.Dataset<span style="color: #4d9391;">)</span>:
    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__init__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, inner, transform=<span style="color: #ef6787;">None</span>,num_bs_negative=4<span style="color: #4d9391;">)</span>:
        <span style="color: #635C4A;">## </span><span style="color: #635C4A;">inner --&gt; datasets</span>
        <span style="color: #49bdb0;">self</span>.inner = inner
        <span style="color: #49bdb0;">self</span>.transform = transform
        <span style="color: #49bdb0;">assert</span> <span style="color: #53E6B5;">hasattr</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>.inner, <span style="color: #cea2ca;">'ontology'</span><span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">assert</span> <span style="color: #49bdb0;">self</span>.inner.ontology <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>
        <span style="color: #49bdb0;">self</span>.ontology = <span style="color: #4d9391;">{</span>k: <span style="color: #53E6B5;">sorted</span><span style="color: #47ba99;">(</span>v<span style="color: #47ba99;">)</span> <span style="color: #49bdb0;">for</span> k, v <span style="color: #49bdb0;">in</span> <span style="color: #49bdb0;">self</span>.inner.ontology.items<span style="color: #47ba99;">()</span><span style="color: #4d9391;">}</span>
        <span style="color: #49bdb0;">self</span>.num_bs_negative=num_bs_negative
    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__len__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span><span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">return</span> 2 * <span style="color: #53E6B5;">len</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>.inner<span style="color: #4d9391;">)</span>

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__getitem__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, i<span style="color: #4d9391;">)</span>:
        item = <span style="color: #49bdb0;">self</span>.inner<span style="color: #4d9391;">[</span>i // 2<span style="color: #4d9391;">]</span>

        negtive_bs_list=<span style="color: #4d9391;">[]</span>
        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">random sampling for belief state.</span>
        <span style="color: #49bdb0;">for</span> x <span style="color: #49bdb0;">in</span> <span style="color: #53E6B5;">range</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>.num_bs_negative<span style="color: #4d9391;">)</span>:
            negative_sample=random.randrange<span style="color: #4d9391;">(</span><span style="color: #53E6B5;">len</span><span style="color: #47ba99;">(</span><span style="color: #49bdb0;">self</span>.inner<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
            neg_sample=<span style="color: #49bdb0;">self</span>.inner<span style="color: #4d9391;">[</span>negative_sample<span style="color: #4d9391;">]</span>
            negtive_bs_list.append<span style="color: #4d9391;">(</span>format_belief<span style="color: #47ba99;">(</span>neg_sample.raw_belief<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>

        negative = i % 2
        <span style="color: #49bdb0;">if</span> negative:
            negative = <span style="color: #ef6787;">False</span>
            belief, response, context = item.belief, item.response, item.context
            raw_belief = item.raw_belief
            negative_type = random.randrange<span style="color: #4d9391;">(</span>1, 4<span style="color: #4d9391;">)</span>
            use_new_belief = <span style="color: #4d9391;">(</span>negative_type // 2<span style="color: #4d9391;">)</span> % 2
            use_new_response = negative_type % 2

            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Negative resonse</span>
            negative_sample = random.randrange<span style="color: #4d9391;">(</span><span style="color: #53E6B5;">len</span><span style="color: #47ba99;">(</span><span style="color: #49bdb0;">self</span>.inner<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
            neg_sample = <span style="color: #49bdb0;">self</span>.inner<span style="color: #4d9391;">[</span>negative_sample<span style="color: #4d9391;">]</span>

            <span style="color: #49bdb0;">if</span> use_new_belief:
                raw_belief = neg_sample.raw_belief
            <span style="color: #49bdb0;">if</span> use_new_response:
                response = neg_sample.response
            belief = format_belief<span style="color: #4d9391;">(</span>raw_belief<span style="color: #4d9391;">)</span>
            item = dataclasses.replace<span style="color: #4d9391;">(</span>item, context=context,
                                       belief=belief,
                                       raw_belief=raw_belief,
                                       response=response,
                                       positive=<span style="color: #ef6787;">False</span><span style="color: #4d9391;">)</span>

        item = dataclasses.replace<span style="color: #4d9391;">(</span>item,
                                   negative_bs_list=negtive_bs_list<span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">return</span> <span style="color: #49bdb0;">self</span>.transform<span style="color: #4d9391;">(</span>item<span style="color: #4d9391;">)</span>

</pre>
</div>

<p>
简单来说,这个wrapper就是加入了一个负采样, 相当于会生成1个正样本生成1个负样本, 这是为了一致性任务而使用的,后续会进行介绍. 
</p>

<p>
如此一来,整体上的data的处理就算是完成了. 下面来关注一下model的设计.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd92fbbe" class="outline-2">
<h2 id="orgd92fbbe"><span class="section-number-2">3.</span> Model的设计</h2>
<div class="outline-text-2" id="text-3">
<p>
model的设计中, training的forward和inference时的generation其实是两种形态,因此在此处进行两种描述. 先看一下训练时.
</p>
</div>

<div id="outline-container-org4163a3e" class="outline-3">
<h3 id="org4163a3e"><span class="section-number-3">3.1.</span> train- forward</h3>
<div class="outline-text-3" id="text-3-1">
<p>
核心代码如下:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #49bdb0;">class</span> <span style="color: #eed891;">SoloistConfig</span><span style="color: #4d9391;">(</span>transformers.GPT2Config<span style="color: #4d9391;">)</span>:
    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__init__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>,
                 summary_label_smoothing=0.1, <span style="color: #635C4A;"># </span><span style="color: #635C4A;">for overfitting.</span>
                 **kwargs<span style="color: #4d9391;">)</span>:
        <span style="color: #53E6B5;">super</span><span style="color: #4d9391;">()</span>.__init__<span style="color: #4d9391;">(</span>**kwargs<span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">self</span>.summary_label_smoothing = summary_label_smoothing

<span style="color: #49bdb0;">class</span> <span style="color: #eed891;">SoloistModel</span><span style="color: #4d9391;">(</span>transformers.GPT2PreTrainedModel<span style="color: #4d9391;">)</span>:
    authorized_missing_keys = <span style="color: #4d9391;">[</span>r<span style="color: #cea2ca;">"h\.\d+\.attn\.masked_bias"</span>,
                               r<span style="color: #cea2ca;">"lm\_head\.weight"</span>, r<span style="color: #cea2ca;">"binary\_head\.\w+"</span><span style="color: #4d9391;">]</span>

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">__init__</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>, config<span style="color: #4d9391;">)</span>:
        <span style="color: #53E6B5;">super</span><span style="color: #4d9391;">()</span>.__init__<span style="color: #4d9391;">(</span>config<span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">self</span>.transformer = transformers.GPT2Model<span style="color: #4d9391;">(</span>config<span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">self</span>.lm_head = nn.Linear<span style="color: #4d9391;">(</span>config.n_embd, config.vocab_size, bias=<span style="color: #ef6787;">False</span><span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">self</span>.consistency_head = nn.Linear<span style="color: #4d9391;">(</span>config.n_embd, 1<span style="color: #4d9391;">)</span> <span style="color: #635C4A;"># </span><span style="color: #635C4A;">?</span>
        <span style="color: #49bdb0;">self</span>.auxiliary_dropout = nn.Dropout<span style="color: #4d9391;">(</span>config.summary_first_dropout<span style="color: #4d9391;">)</span>
        <span style="color: #49bdb0;">self</span>.init_weights<span style="color: #4d9391;">()</span>

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">get_output_embeddings</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span><span style="color: #4d9391;">)</span>:
        <span style="color: #49bdb0;">return</span> <span style="color: #49bdb0;">self</span>.lm_head

    <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">forward</span><span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>,
                input_ids=<span style="color: #ef6787;">None</span>,          <span style="color: #635C4A;"># </span><span style="color: #635C4A;">all input sequence tokens;</span>
                past=<span style="color: #ef6787;">None</span>,
                attention_mask=<span style="color: #ef6787;">None</span>,
                token_type_ids=<span style="color: #ef6787;">None</span>,
                position_ids=<span style="color: #ef6787;">None</span>,
                head_mask=<span style="color: #ef6787;">None</span>,
                inputs_embeds=<span style="color: #ef6787;">None</span>,
                consistency_token_ids=<span style="color: #ef6787;">None</span>, <span style="color: #635C4A;"># </span><span style="color: #635C4A;">the last token (eos), for classify whether consistent or not. </span>
                consistency_labels=<span style="color: #ef6787;">None</span>,  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">is consistency or not</span>
                user_intent_token_ids=<span style="color: #ef6787;">None</span>,
                user_intent_labels=<span style="color: #ef6787;">None</span>,
                user_intent_mask=<span style="color: #ef6787;">None</span>,
                belief_labels=<span style="color: #ef6787;">None</span>,      <span style="color: #635C4A;"># </span><span style="color: #635C4A;">context + belief states, and aims to predict bs.</span>
                system_action_token_ids=<span style="color: #ef6787;">None</span>,
                system_action_labels=<span style="color: #ef6787;">None</span>,
                system_action_mask=<span style="color: #ef6787;">None</span>,
                response_labels=<span style="color: #ef6787;">None</span>, <span style="color: #635C4A;"># </span><span style="color: #635C4A;">only responses part has label, and others part is -100.</span>
                back_predict_labels=<span style="color: #ef6787;">None</span>,  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">this is the target of back predicted resonses.</span>
                bp_weight=0.3,
                binary_labels=<span style="color: #ef6787;">None</span>,
                use_cache=<span style="color: #ef6787;">None</span>,
                output_attentions=<span style="color: #ef6787;">None</span>,
                output_hidden_states=<span style="color: #ef6787;">None</span>,
                **kwargs  <span style="color: #635C4A;"># </span><span style="color: #635C4A;">context=context_labels</span>
                <span style="color: #4d9391;">)</span>:
        <span style="color: #635C4A;"># </span><span style="color: #635C4A;">print(f"shape of bp weight: {bp_weight.shape}")</span>

        transformer_outputs = <span style="color: #49bdb0;">self</span>.transformer<span style="color: #4d9391;">(</span>
            input_ids,
            past=past,
            attention_mask=attention_mask,
            token_type_ids=token_type_ids,
            position_ids=position_ids,
            head_mask=head_mask,
            inputs_embeds=inputs_embeds,
            use_cache=use_cache,
            output_attentions=output_attentions,
            output_hidden_states=output_hidden_states,
        <span style="color: #4d9391;">)</span>

        hidden_states = transformer_outputs<span style="color: #4d9391;">[</span>0<span style="color: #4d9391;">]</span>
        lm_logits = <span style="color: #49bdb0;">self</span>.lm_head<span style="color: #4d9391;">(</span>hidden_states<span style="color: #4d9391;">)</span>

        <span style="color: #49bdb0;">def</span> <span style="color: #7ED7E6;">gather_auxiliary_features</span><span style="color: #4d9391;">(</span>token_ids<span style="color: #4d9391;">)</span>:
            <span style="color: #49bdb0;">if</span> token_ids <span style="color: #49bdb0;">is</span> <span style="color: #ef6787;">None</span>:
                <span style="color: #635C4A;"># </span><span style="color: #635C4A;">torch.full_like(input,fill_value) returns the same size</span>
                <span style="color: #635C4A;">#</span><span style="color: #635C4A;">as input with the filling of fill_value.</span>

                <span style="color: #635C4A;"># </span><span style="color: #635C4A;">hidden_states.shape[-2] is max-seqence-length</span>

                <span style="color: #635C4A;"># </span><span style="color: #635C4A;">... in split means select the last dimension, so it means select the last</span>
                <span style="color: #635C4A;"># </span><span style="color: #635C4A;">embedding dimension, and select the first batch, and with all seqence.</span>
                <span style="color: #635C4A;"># </span><span style="color: #635C4A;">so the shape is 1*msl*1</span>
                token_ids = torch.full_like<span style="color: #4d9391;">(</span>hidden_states<span style="color: #47ba99;">[</span>..., :1, :<span style="color: #47ba99;">]</span>, <span style="color: #635C4A;"># </span><span style="color: #635C4A;">which the shape is ???</span>
                                            hidden_states.shape<span style="color: #47ba99;">[</span>-2<span style="color: #47ba99;">]</span>-1, dtype=torch.<span style="color: #53E6B5;">long</span>,<span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">else</span>:
                token_ids = token_ids.unsqueeze<span style="color: #4d9391;">(</span>-1<span style="color: #4d9391;">)</span>.unsqueeze<span style="color: #4d9391;">(</span>-1<span style="color: #4d9391;">)</span>
                token_ids = token_ids.expand<span style="color: #4d9391;">(</span>
                    <span style="color: #47ba99;">(</span>-1,<span style="color: #47ba99;">)</span> * <span style="color: #47ba99;">(</span>token_ids.dim<span style="color: #9d81ba;">()</span> - 1<span style="color: #47ba99;">)</span> + <span style="color: #47ba99;">(</span>hidden_states.size<span style="color: #9d81ba;">(</span>-1<span style="color: #9d81ba;">)</span>,<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>

            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">shape of binary_token_ids: (bsz, XX, 1, hidden_size)</span>
            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">where XX are optional leading dim of hidden_states</span>
            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">shape of binary_logits (bsz, XX, hidden_size)</span>
            logits = hidden_states.gather<span style="color: #4d9391;">(</span>-2, token_ids<span style="color: #4d9391;">)</span>.squeeze<span style="color: #4d9391;">(</span>-2<span style="color: #4d9391;">)</span>
            logits = <span style="color: #49bdb0;">self</span>.auxiliary_dropout<span style="color: #4d9391;">(</span>logits<span style="color: #4d9391;">)</span>
            <span style="color: #49bdb0;">return</span> logits

        consistency_logits = <span style="color: #49bdb0;">self</span>.consistency_head<span style="color: #4d9391;">(</span>gather_auxiliary_features<span style="color: #47ba99;">(</span>consistency_token_ids<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>.squeeze<span style="color: #4d9391;">(</span>-1<span style="color: #4d9391;">)</span>
        consistency_loss = <span style="color: #ef6787;">None</span>
        <span style="color: #49bdb0;">if</span> consistency_labels <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
            <span style="color: #635C4A;"># </span><span style="color: #635C4A;">Auxiliary tasks</span>
            aux_criterion = LabelSmoothingBCEWithLogitsLoss<span style="color: #4d9391;">(</span><span style="color: #49bdb0;">self</span>.config.summary_label_smoothing<span style="color: #4d9391;">)</span>
            consistency_loss = aux_criterion<span style="color: #4d9391;">(</span>consistency_logits, consistency_labels<span style="color: #4d9391;">)</span>

        belief_loss, response_loss = <span style="color: #ef6787;">None</span>, <span style="color: #ef6787;">None</span>
        <span style="color: #49bdb0;">if</span> belief_labels <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
            <span style="color: #49bdb0;">assert</span> response_labels <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>

            shift_logits = lm_logits<span style="color: #4d9391;">[</span>..., :-1, :<span style="color: #4d9391;">]</span>.contiguous<span style="color: #4d9391;">()</span>
            shift_belief_labels = belief_labels<span style="color: #4d9391;">[</span>..., 1:<span style="color: #4d9391;">]</span>.contiguous<span style="color: #4d9391;">()</span>
            shift_response_labels = response_labels<span style="color: #4d9391;">[</span>..., 1:<span style="color: #4d9391;">]</span>.contiguous<span style="color: #4d9391;">()</span>
            loss_fct = nn.CrossEntropyLoss<span style="color: #4d9391;">()</span>
            belief_loss = loss_fct<span style="color: #4d9391;">(</span>
                shift_logits.view<span style="color: #47ba99;">(</span>-1, shift_logits.size<span style="color: #9d81ba;">(</span>-1<span style="color: #9d81ba;">)</span><span style="color: #47ba99;">)</span>,
                shift_belief_labels.view<span style="color: #47ba99;">(</span>-1<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>

            response_ce = loss_fct<span style="color: #4d9391;">(</span>shift_logits.view<span style="color: #47ba99;">(</span>-1, shift_logits.size<span style="color: #9d81ba;">(</span>-1<span style="color: #9d81ba;">)</span><span style="color: #47ba99;">)</span>, shift_response_labels.view<span style="color: #47ba99;">(</span>-1<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
            response_loss = response_ce

            bp_loss=0.
            <span style="color: #635C4A;">## </span><span style="color: #635C4A;">we only use 0.5 weighted bp losses.</span>
            <span style="color: #49bdb0;">if</span> back_predict_labels <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
                shift_bp_labels = back_predict_labels<span style="color: #4d9391;">[</span>..., 1:<span style="color: #4d9391;">]</span>.contiguous<span style="color: #4d9391;">()</span>
                bp_loss = loss_fct<span style="color: #4d9391;">(</span>
                shift_logits.view<span style="color: #47ba99;">(</span>-1, shift_logits.size<span style="color: #9d81ba;">(</span>-1<span style="color: #9d81ba;">)</span><span style="color: #47ba99;">)</span>,
                shift_bp_labels.view<span style="color: #47ba99;">(</span>-1<span style="color: #47ba99;">)</span><span style="color: #4d9391;">)</span>
                <span style="color: #635C4A;"># </span><span style="color: #635C4A;">assert bp_weight is not None</span>
                bp_loss*=bp_weight<span style="color: #4d9391;">[</span>0<span style="color: #4d9391;">]</span>

        output = <span style="color: #4d9391;">(</span>lm_logits, consistency_logits,<span style="color: #4d9391;">)</span> + transformer_outputs<span style="color: #4d9391;">[</span>1:<span style="color: #4d9391;">]</span>
        <span style="color: #49bdb0;">if</span> consistency_loss <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span>:
            output = <span style="color: #4d9391;">(</span>consistency_loss,<span style="color: #4d9391;">)</span> + output
        <span style="color: #49bdb0;">return</span> <span style="color: #4d9391;">(</span><span style="color: #47ba99;">(</span>belief_loss, response_loss + bp_loss, response_ce + bp_loss<span style="color: #47ba99;">)</span> + output<span style="color: #4d9391;">)</span> <span style="color: #49bdb0;">if</span> belief_loss <span style="color: #49bdb0;">is</span> <span style="color: #49bdb0;">not</span> <span style="color: #ef6787;">None</span> <span style="color: #49bdb0;">else</span> output
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4d3aa57" class="outline-2">
<h2 id="org4d3aa57"><span class="section-number-2">4.</span> 训练流程</h2>
</div>
<div id="outline-container-orgc427d02" class="outline-2">
<h2 id="orgc427d02"><span class="section-number-2">5.</span> 推理流程</h2>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: Sun Jan 16 15:43:35 2022</p>
<p class="author">Author: Zi Liang</p>
<p class="date">Created: 2023-01-02 一 17:32</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
